# Тематический лог: ARCH

Лог изменений, связанных с архитектурой, структура файлов/компонентов, JavaScript, API, I/O.

<!-- ПРАВИЛА ФОРМАТИРОВАНИЯ ЗАПИСЕЙ
**КРИТИЧЕСКИ ВАЖНО**: При упоминании HTML-тегов в записях **ЗАПРЕЩЕНО** использовать обычные угловые скобки `<script>`, `<div>`, `<style>` и т.п. — они блокируют Markdown-превью. **ОБЯЗАТЕЛЬНО** использовать математические угловые скобки: ⟨script⟩, ⟨div⟩, ⟨style⟩ (U+27E8/U+27E9). Для скрытых комментариев используйте HTML-комментарии -->

## Исправления логики button-group: radio поведение и порядок эмиссии событий
28.12.2025 ◆ Исправлены ошибки в логике button-group для корректной работы radio и консистентности событий ▶ В button-group.js исправлена логика handleMenuClick для radio кнопок: убрано переключение состояния (const newActive = !state.active), добавлена проверка !state.active перед активацией (radio нельзя деактивировать кликом, только выбором другого radio). Исправлен порядок эмиссии событий в handleMenuClick: теперь button-change → button-toggle (как в handleButtonChange), вместо button-toggle → button-change ◉ Обеспечить нативное поведение radio кнопок (нельзя деактивировать кликом) и консистентный порядок эмиссии событий для всех путей взаимодействия @components @button-group @fix @radio @events @consistency

## Создание Vue-компонента button-group
28.12.2025 ◆ Создан компонент button-group — обёртка над Bootstrap .btn-group ▶ Создан shared/components/button-group.js: компонент с поддержкой трёх типов кнопок (button через cmp-button, checkbox и radio через нативный HTML), наследованием variant и size от группы, адаптивным схлопыванием в dropdown при брейкпоинте через двойной рендер с CSS-переключением (d-none d-{breakpoint}-inline-flex), синхронизацией состояния через внутреннее buttonStates, автоматическим сбросом других radio при выборе. Создан shared/templates/button-group-template.js: шаблон с двойным рендером (группа кнопок для ≥ breakpoint, dropdown для < breakpoint), маппингом buttons в menuItems для dropdown. Обновлён core/modules-config.js: добавлен шаблон button-group-template и компонент button-group с зависимостями. Обновлён app/app-ui-root.js: зарегистрирован компонент cmp-button-group, добавлен метод handleButtonGroupClick ◉ Создать универсальный компонент группы кнопок с поддержкой всех типов кнопок Bootstrap, адаптивностью и максимальной совместимостью с Bootstrap JS API @components @bootstrap @button-group @adaptivity @vue

## Ревизия шапок файлов на соответствие иерархии уровней
27.12.2025:b876f35 ◆ Проведена ревизия шапок файлов на соответствие иерархии уровней документирования ▶ В shared/utils/auto-markup.js расширена шапка с деталями реализации (правила применения, особенности), добавлены ссылки на общую документацию. В shared/templates/button-template.js убрано упоминание об адаптивности (общий принцип). В shared/components/button.js переформатирована шапка, убраны общие принципы, оставлено только специфичное для компонента, добавлены ссылки на общую документацию. В core/module-loader.js обновлена шапка с корректными деталями реализации, добавлены ссылки на общую документацию ◉ Привести шапки файлов в соответствие с иерархией уровней документирования, убрать общие принципы, оставить только специфичное для файла, обеспечить согласованность ссылок @documentation @refactoring @hierarchy @headers

## Вынос шаблонов компонентов в отдельные файлы
27.12.2025:0258094 ◆ Вынесены шаблоны компонентов из core/templates-inline.js в отдельные файлы в shared/templates/ ▶ Созданы 4 файла шаблонов: shared/templates/button-template.js, dropdown-menu-item-template.js, dropdown-template.js, combobox-template.js. Каждый файл содержит шапку документации с ЦЕЛЬ, ПРОБЛЕМА, РЕШЕНИЕ, КАК ДОСТИГАЕТСЯ, ОСОБЕННОСТИ ШАБЛОНА, ССЫЛКИ на общую документацию. Обновлён core/modules-config.js: добавлены 4 отдельных шаблона вместо templates-inline, обновлены зависимости Vue.js и app-ui-root. Обновлён core/module-loader.js: обновлена проверка критичных модулей для всех шаблонов. Удалён core/templates-inline.js. Удалены отладочные логи из core/module-loader.js, app/app-ui-root.js, shared/utils/auto-markup.js ◉ Разделить шаблоны на отдельные файлы для лучшей организации и документирования, обеспечить единообразную структуру шапок с ссылками на общую документацию @templates @refactoring @documentation @modules

## Реализация модульной системы загрузки скриптов
27.12.2025:2b7723c ◆ Реализована модульная система загрузки скриптов с автоматическим разрешением зависимостей ▶ Создан core/modules-config.js: централизованная конфигурация всех модулей приложения с описанием зависимостей, группировка по категориям (utilities, core, templates, libraries, components, app). Создан core/module-loader.js: загрузчик модулей с топологической сортировкой (алгоритм Kahn), обнаружением циклических зависимостей, поддержкой file:// и http:// протоколов через асинхронную загрузку ⟨script⟩ тегов, кэшированием загруженных модулей, улучшенной обработкой ошибок (критичные модули прерывают загрузку, некритичные продолжают), условной загрузкой модулей через feature flags (опциональное поле condition). Обновлён app/app-ui-root.js: убрана загрузка компонентов (теперь только инициализация Vue), компоненты загружаются через модульную систему. Обновлён index.html: заменена прямая загрузка модулей на модульную систему (подключение modules-config.js и module-loader.js). Удалены core/template-loader.js и shared/templates/*.html (шаблоны вынесены в shared/templates/*.js) ◉ Централизовать управление зависимостями модулей, автоматизировать порядок загрузки, упростить добавление новых модулей, обеспечить поддержку file:// и http:// протоколов @architecture @modules @loader @dependencies @refactoring @file-protocol

## Добавление утилиты pluralize и выравнивание высоты компонентов
27.12.2025:5cc7037 ◆ Добавлена утилита pluralize и реализовано выравнивание высоты через вертикальный padding ▶ Создан shared/utils/pluralize.js: утилита для склонения русских числительных (window.pluralize). В button.js обновлён метод containerClasses(): убран жёстко заданный py-2, оставлены только d-flex align-items-center для управления вертикальным padding через CSS. Вертикальный padding теперь управляется через CSS в responsive-breakpoints.css на основе классов размеров Bootstrap (btn-sm, btn-lg) ◉ Добавить утилиту для локализации и реализовать метод выравнивания высоты элементов для консистентности интерфейса @utilities @localization @alignment @components @css

## Исправление ошибки filteredItems и рефакторинг dropdownClasses в dropdown
26.12.2025:7e0bc9a ◆ Исправлена ошибка "Cannot read properties of undefined (reading 'length')" в компоненте dropdown и перенесён класс dropdown-responsive на корневой элемент ▶ В dropdown.js исправлено computed свойство filteredItems: добавлена защита от undefined/null items (const items = this.items || []), все обращения к this.items заменены на items. Добавлено computed свойство dropdownClasses() для корневого элемента dropdown: включает классы dropdown, dropdown-responsive, instanceHash и условные классы has-icon, has-text-short. Удалён класс dropdown-responsive из buttonClasses() (теперь только btn, btn-{variant}, dropdown-toggle, btn-{size}). Обновлён шаблон dropdown-template: корневой div использует :class="dropdownClasses" вместо class="dropdown", добавлена проверка filteredItems && перед обращением к .length в условии пустого состояния поиска ◉ Исправить ошибку рендеринга dropdown при отсутствии prop items и правильно разместить класс dropdown-responsive на корневом элементе для корректной работы CSS селекторов @components @dropdown @fix @bug @refactoring

## Система автоматической маркировки элементов и детерминированных хэшей
26.12.2025:39b3a5e ◆ Реализована система автоматической маркировки элементов DOM и детерминированных хэшей для компонентов ▶ Создан shared/utils/hash-generator.js: утилита генерации детерминированных Base58 хэшей из строк (алгоритм djb2). Создан shared/utils/auto-markup.js: утилита автоматической маркировки значимых контейнеров через MutationObserver (работает с асинхронной загрузкой). Добавлен computed instanceHash в button.js, dropdown.js, dropdown-menu-item.js: генерация детерминированного хэша на основе родительского контекста (класс avto-* или ID родителя) и идентификатора экземпляра из props (buttonId, itemId, dropdownId или fallback). Добавлен метод getParentContext() во все компоненты: поиск родительского контекста через обход DOM (до 5 уровней). Хэш автоматически добавляется к корневым элементам компонентов через buttonClasses, itemClasses. Добавлены props buttonId в button.js и itemId в dropdown-menu-item.js для явной идентификации экземпляров. Инициализация auto-markup в app/app-ui-root.js после монтирования Vue приложения. Подключение утилит в index.html (до Vue.js) ◉ Обеспечить автоматическую маркировку всех значимых элементов DOM и уникальную идентификацию экземпляров компонентов для навигации в коде и кастомной стилизации @utilities @markup @hash @components @vue @mutation-observer

## Рефакторинг адаптивности: удаление responsive prop из компонентов
26.12.2025:90b50ff ◆ Удалён responsive prop и все computed свойства для breakpoints из компонентов, адаптивность перенесена в CSS ▶ В button.js убран responsive prop, удалены computed свойства iconClasses, labelClasses, labelShortClasses, iconDataAttrs, labelShortDataAttrs, labelDataAttrs. Добавлены условные классы has-icon и has-label-short в buttonClasses. В dropdown.js убран responsive prop, удалены computed свойства buttonIconClasses, buttonTextShortClasses, buttonTextClasses. Добавлены условные классы has-icon и has-text-short в buttonClasses. В dropdown-menu-item.js убран responsive prop, удалены computed свойства iconClasses и subtitleClasses, добавлен computed itemClasses для класса компонента. Обновлены шаблоны: классы элементов (.icon, .label, .label-short, .suffix) добавляются напрямую, без computed свойств ◉ Упростить компоненты, убрать логику адаптивности из JavaScript, перенести её в CSS через классы компонентов @components @adaptivity @refactoring @vue @css

## Добавление адаптивности в компоненты button и dropdown
23.12.2025:a4dc95b ◆ Добавлена адаптивность для мобильных устройств в компоненты button и dropdown ▶ В button.js добавлен prop labelShort для укороченной версии текста на мобильных (если нет иконки). В dropdown.js добавлены props buttonIcon (иконка для мобильной версии), buttonTextShort (укороченный текст, если нет иконки) и responsive (объект с настройками адаптивности: hideTextOnMobile, showIconOnMobile, useShortTextOnMobile). Обновлены шаблоны в core/templates-inline.js: для button добавлена логика отображения labelShort на мобильных при отсутствии иконки, для dropdown добавлена логика отображения buttonIcon на мобильных и buttonTextShort при отсутствии иконки. Обновлены примеры в index.html для демонстрации адаптивности ◉ Реализовать единый подход к адаптивности текстового содержимого на мобильных устройствах для компонентов button и dropdown @components @adaptivity @responsive @mobile @button @dropdown

## Вынос шаблонов и логики инициализации из index.html
23.12.2025:8559968 ◆ Вынесены шаблоны компонентов и логика инициализации Vue из index.html в отдельные модули ▶ Создан core/templates-inline.js для хранения шаблонов как строк в JavaScript объекте (работает с file:// протоколом через обычный ⟨script⟩ тег). Создан app/app-ui-root.js с логикой загрузки компонентов и инициализации Vue приложения. Обновлён index.html: удалены встроенные шаблоны (~370 строк) и логика инициализации (~130 строк), добавлены подключения новых модулей. Шаблоны загружаются через обычный ⟨script⟩ тег, что работает и с file://, и с HTTP/HTTPS. Создан core/template-loader.js для будущего использования с HTTP/HTTPS через XMLHttpRequest ◉ Разгрузить index.html, вынести шаблоны и логику инициализации в отдельные модули, сохранить работоспособность с file:// протоколом @refactoring @templates @vue @file-protocol @modularity @index

## Исправление работы приложения с file:// протоколом
23.12.2025:ca794ba ◆ Исправлена работа приложения при открытии из локальной папки: заменён Vue development build на production build, встроены шаблоны компонентов в index.html вместо загрузки через fetch (для обхода CORS ограничений file:// протокола), добавлены проверки на существование элементов в dropdown.js и dropdown-menu-item.js перед обращением к DOM @vue @production @file-protocol @cors @fix @templates @components

## Создание Vue-компонента-обёртки над Bootstrap dropdown
23.12.2025:3c7811a ◆ Создан Vue-компонент-обёртка над Bootstrap dropdown с поддержкой поиска и прокрутки ▶ Создан шаблон `shared/templates/dropdown-template.html` с поддержкой поиска, прокрутки, слотов для гибкого использования. Создан компонент `shared/components/dropdown.js` с props, emits, методами программного управления через Bootstrap API. Реализована стратегия максимальной совместимости с Bootstrap JS API: инициализация через `new bootstrap.Dropdown()`, подписка на события Bootstrap (`show.bs.dropdown`, `hide.bs.dropdown`), методы `show()`, `hide()`, `toggle()`, `getBootstrapInstance()` для прямого доступа к Bootstrap API, уничтожение экземпляров в `beforeUnmount()`. Поддержка поиска с встроенной фильтрацией и кастомными функциями, прокрутка для длинных списков, слоты для кастомной кнопки и элементов списка. Обновлён index.html с примерами компонента (базовый, с поиском, с прокруткой, комбинированный). Обновлена документация в docs/doc-components.md: добавлен раздел о компоненте dropdown, добавлена стратегия максимальной совместимости с Bootstrap как обязательное требование, обновлено оглавление ◉ Создать Vue-обёртку над Bootstrap dropdown с дополнительной функциональностью (поиск, прокрутка) при сохранении полной совместимости с Bootstrap JS API @components @vue @bootstrap @dropdown @shared @bootstrap-api

## Создание компонента button
23.12.2025:bb969e5 ◆ Создан переиспользуемый компонент button для кнопок с иконкой, текстом и суффиксом ▶ Создан шаблон `shared/templates/button-template.html` с поддержкой иконки, текста, суффикса (массив badge/icon/indicator/chevron/info), tooltips, состояний (disabled/loading), вариантов Bootstrap, размеров. Создан компонент `shared/components/button.js` с props, emits, computed свойствами. Реализована логика событий: по умолчанию все зоны эмитят общий click, раздельные события (click-icon, click-text, click-suffix) эмитятся всегда. Настроены паддинги (px-3 py-2, px-md-3 py-md-2), gap между тап-зонами (me-1/ms-1), обесцвечивание disabled кнопок через нейтральные классы Bootstrap. Фиксированная ширина контейнера иконки (1.6em) с выравниванием по центру через text-center. Нативные подсказки браузера через атрибут title. Запрет переноса строк для текста кнопок (text-nowrap). Обновлён index.html с примерами компонента в разных состояниях. Обновлена документация в docs/doc-components.md ◉ Создать универсальный переиспользуемый компонент для кнопок с поддержкой всех необходимых функций, используя только Bootstrap классы @components @vue @bootstrap @button @shared

## Создание компонента dropdown-menu-item
23.12.2025:4cb4b35 ◆ Создан переиспользуемый компонент dropdown-menu-item для пунктов выпадающего меню ▶ Создан шаблон `shared/templates/dropdown-menu-item-template.html` с поддержкой иконки, заголовка, подзаголовка, суффикса (badge/icon/indicator/chevron/info), tooltips, состояний (active/disabled). Создан компонент `shared/components/dropdown-menu-item.js` с props, emits, методами обработки кликов. Реализована логика событий: по умолчанию все зоны эмитят общий click, раздельные события (click-icon, click-text, click-suffix) эмитятся всегда. Добавлена анимация chevron через Font Awesome классы (fa-rotate-90) + inline transition. Инициализация Bootstrap tooltips через data-bs-toggle. Обновлён index.html с примерами компонента в разных состояниях ◉ Создать универсальный переиспользуемый компонент для пунктов dropdown-меню с поддержкой всех необходимых функций, используя только Bootstrap классы @components @vue @bootstrap @dropdown @menu-item @shared

## Обновление формата записей в тематических логах
22.12.2025:f033986 ◆ Обновлён формат записей в тематических логах для компактности @logs @format @refactoring

## Обновление ссылок на переименованные файлы документации
22.12.2025:dff9953 ◆ Обновлены ссылки на переименованный файл документации в `core/lib-loader.js` @refactoring @links @lib-loader

## Создание загрузчика библиотек с fallback-механизмом
22.12.2025:2b7d0a8 ◆ Создан `core/lib-loader.js` для загрузки внешних библиотек с автоматическим fallback ▶ Реализованы функции: `load()`, `loadMultiple()`, `isLoaded()`, `addSource()`. Поддержка GitHub Pages CDN как основной источник, внешние CDN как fallback, кэширование загруженных библиотек. Поддержка библиотек: vue, chartjs, numeral, vuedraggable, dayjs. Обновлён порядок загрузки в `docs/doc-architect.md` ◉ Обеспечить надёжную загрузку библиотек независимо от доступности отдельных CDN, централизовать управление библиотеками @architect @lib-loader @cdn @fallback

## Создание критически важных структур проекта
22.12.2025:68e89b3 ◆ Созданы все критически важные структуры для здоровья проекта ▶ Создана структура `core/validation/` (schemas.js, validator.js, normalizer.js, math-validation.js). Создана структура `core/errors/` (error-types.js, error-handler.js). Создан `core/api/rate-limiter.js`. Создана структура `core/state/` (loading-state.js). Создана структура `core/events/` (event-bus.js). Создана структура `core/config/` (app-config.js, api-config.js). Создана структура `core/logging/` (logger.js). Обновлена документация `docs/doc-architect.md`: добавлен раздел "Критически важные структуры", обновлён порядок загрузки (15 шагов). Всего создано 19 файлов, 2268 строк JavaScript кода ◉ Заложить фундамент для надёжности финансовых расчётов, предотвратить ошибки из-за некорректных данных, обеспечить единообразную обработку ошибок и состояний @architect @validation @errors @rate-limiting @state @events @config @logging @foundation

## Декомпозиция ui/ и переименование в shared/
22.12.2025:37235af ◆ Переименована папка `ui/shared/` → `shared/`, обновлена структура проекта ▶ Переименована папка `ui/shared/` в `shared/`, удалена пустая папка `ui/`, обновлены все упоминания в `index.html`, создана структура папок: `shared/` (components, styles, templates, utils, config, assets/icons), `features/markets/`, `features/settings/`, `features/layout/` с подпапками ◉ Упростить структуру проекта, убрать лишний уровень вложенности, обеспечить чёткое разделение shared/feature-specific компонентов @architect @structure @refactoring @shared @features

## Создание модульного index.html с принципами модульности
22.12.2025:822e4e4 ◆ Создан `index.html` как точка подключения скриптов с развёрнутой шапкой, описывающей принципы модульности ▶ Добавлена шапка с описанием: вынос x-template шаблонов в отдельные файлы, модульная система загрузки скриптов через конфигурацию, группировка компонентов по функциональности и слоям, правила размещения файлов, порядок загрузки, принципы именования, работа без сборки ◉ Обеспечить модульную архитектуру проекта, избежать раздувания index.html, централизовать управление загрузкой модулей @architect @modularity @index @module-loader
