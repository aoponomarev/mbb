# Кэширование — стратегия и принципы

> Оглавление `docs/doc-cache.md`
- § Архитектура кэширования — общая структура системы кэширования
- § Слои хранения — распределение данных по хранилищам (hot/warm/cold)
- § Версионирование приложения — инвалидация кэша при обновлении
- § TTL и стратегии кэширования — временные лимиты и алгоритмы выбора источника данных
- § Что не кэшируется — данные, которые не сохраняются в кэше и причины
- § Правила принятия решений — критерии выбора слоя, версионирования, TTL и стратегии

> § <br> АРХИТЕКТУРА КЭШИРОВАНИЯ

## Общая концепция

Единая система кэширования через `core/cache/cache-manager.js` обеспечивает абстракцию над хранилищами (localStorage, IndexedDB), версионирование данных, автоматические миграции и стратегии кэширования. Все компоненты работают с кэшем через единый интерфейс.

## Компоненты системы

```
┌─────────────────────────────────────────────┐
│         cache-manager.js                    │
│  (единый интерфейс get/set/has/delete)     │
└──────────────┬──────────────────────────────┘
               │
    ┌──────────┴──────────┐
    │                     │
┌───▼────────┐  ┌─────────▼────────┐
│  storage-  │  │   cache-config   │
│  layers    │  │   (TTL,          │
│  (hot/     │  │    стратегии)    │
│  warm/     │  └──────────────────┘
│  cold)     │
└────────────┘
```

**Файлы модуля:**
- `cache-manager.js` — единый интерфейс, версионирование приложения
- `cache-config.js` — TTL, стратегии, версии схем
- `storage-layers.js` — распределение ключей по слоям хранения
- `cache-migrations.js` — миграции схем данных
- `cache-cleanup.js` — политики очистки
- `cache-indexes.js` — индексы IndexedDB

## Принципы

1. **Единый интерфейс**: Все компоненты используют `cacheManager`, детали хранилищ скрыты
2. **Автоматическое версионирование**: Ключи из внешних API версионируются префиксом `v:{hash}:{key}`
3. **Автоматические миграции**: Изменения структуры данных обрабатываются через `cache-migrations.js`
4. **Стратегии кэширования**: Выбор источника данных (кэш/сеть) определяется стратегией для каждого типа данных

> § <br> СЛОИ ХРАНЕНИЯ

## Разделение по объему и частоте доступа

**Hot (localStorage, ≤5MB)** — небольшие данные, частый доступ:
- Настройки: `settings`, `theme`, `timezone`, `favorites`, `ui-state`, `active-tab`
- Иконки: `icons-cache` (объект {coinId: url})

**Warm (IndexedDB, ≤50MB)** — средний объем, частый доступ:
- `coins-list`, `market-metrics`, `api-cache`

**Cold (IndexedDB, ≤500MB)** — большие объемы, редкий доступ:
- `time-series`, `history`, `portfolios`, `strategies`, `correlations`

**Принципы распределения:**
- localStorage: синхронный доступ, лимит ~5MB, быстрое чтение
- IndexedDB: асинхронный доступ, большие объемы, структурированные данные
- Лимиты: защита от переполнения, приоритетная очистка (cold → warm → hot)

**Детали распределения ключей:** `core/cache/storage-layers.js`

> § <br> ВЕРСИОНИРОВАНИЕ ПРИЛОЖЕНИЯ

## Назначение

Автоматическая инвалидация кэша при обновлении приложения через префикс `v:{hash}:{key}`, где `{hash}` — детерминированный хэш версии приложения.

**Реализация:**
- Хэш генерируется из `CONFIG.version` (app-config.js)
- Версионируются только ключи, зависящие от структуры данных
- При смене версии старые ключи автоматически удаляются через `clearOldVersions()`

## Версионируемые ключи

**Автоматически версионируются** (префикс `v:{hash}:`):
- `icons-cache` — структура CoinGecko API может измениться
- `coins-list` — формат ответа API может измениться
- `api-cache` — структура внешних API может измениться
- `market-metrics` — формат метрик может измениться
- `crypto-news-state` — структура зависит от промпта AI провайдера

**Особый случай:**
- `tooltips-{provider}-{versionHash}-{language}` — версия в имени ключа, не через префикс

**НЕ версионируются** (пользовательские данные):
- Настройки: `settings`, `theme`, `timezone`, `favorites`, `ui-state`
- API ключи: `yandex-api-key`, `perplexity-api-key`, `yandex-model`, `perplexity-model`, `ai-provider`
- Пользовательские данные: `portfolios`, `strategies`, `time-series`, `history`
- Язык перевода: `translation-language`

## Критерии версионирования

**ВЕРСИОНИРОВАТЬ, если:**
- ✅ Данные из внешних API — структура может измениться
- ✅ Данные парсятся из ответов — старый формат вызовет ошибки парсинга
- ✅ Структура зависит от версии приложения — изменения в коде могут изменить формат
- ✅ Ошибки в старых данных могут привести к сбоям

**НЕ версионировать, если:**
- ❌ Пользовательские данные — должны сохраняться между обновлениями
- ❌ Настройки пользователя — пользователь не должен перенастраивать после обновления
- ❌ UI-состояние — должно сохраняться между обновлениями
- ❌ Данные с миграциями — используют систему миграций схем

**Детали реализации:** `core/cache/cache-manager.js` (getVersionedKey, clearOldVersions)

> § <br> TTL И СТРАТЕГИИ КЭШИРОВАНИЯ

## TTL (Time To Live)

**С TTL:**
- `icons-cache`: 1 час — иконки меняются редко, но могут обновиться
- `coins-list`: 1 день — список монет стабилен, обновляется раз в день
- `market-metrics`: 1 час — метрики обновляются часто
- `api-cache`: 5 минут — кэш API-ответов, быстрое устаревание
- `time-series`: 1 час — временные ряды обновляются регулярно
- `history`: 1 день — история изменяется реже
- `crypto-news-cache-max-age`: 24 часа — максимальный возраст состояния новостей
- `market-update-fallback`: 3 часа — fallback при ошибке расчета обновления
- `market-update-delay-max`: 24 часа — максимальная задержка обновления

**Без TTL** (постоянное хранение):
- Пользовательские данные: `portfolios`, `strategies`, `time-series`, `history`
- Настройки: `settings`, `theme`, `timezone`, `favorites`, `ui-state`
- API ключи и провайдеры: `yandex-api-key`, `perplexity-api-key`, `yandex-model`, `perplexity-model`, `ai-provider`, `yandex-proxy-type`
- Язык: `translation-language`

**Все TTL централизованы:** `core/cache/cache-config.js`

## Стратегии кэширования

**cache-first** — всегда из кэша, обновление в фоне:
- `icons-cache`, `coins-list` — данные стабильны, важна скорость доступа

**network-first** — сначала сеть, fallback на кэш:
- `market-metrics`, `api-cache` — актуальность важнее скорости

**stale-while-revalidate** — показываем кэш, обновляем в фоне:
- `time-series`, `history` — баланс между актуальностью и производительностью

**cache-only** — только локальные данные, без TTL:
- `portfolios`, `strategies`, `settings`, `theme`, `timezone`, `favorites`, `ui-state`
- API ключи и настройки провайдеров
- `translation-language`

**Детали стратегий:** `core/cache/cache-config.js`

> § <br> ЧТО НЕ КЭШИРУЕТСЯ

## Новости криптовалют

**Не кэшируются сами новости** — только состояние:
- Индекс текущей новости (0-4)
- Timestamp последнего запроса
- Ключ кэша: `crypto-news-state` (версионируется)

**Причины:**
- Новости быстро устаревают (актуальность важнее производительности)
- Экономия места в кэше (новости большие по объему)
- При каждом клике загружается свежая новость с переводом

**Учет провайдера:** Данные от разных AI провайдеров кэшируются отдельно (ключ включает провайдера).

## Сессионное кэширование

**Не используется** — нет `sessionStorage`. Все данные хранятся в localStorage/IndexedDB и сохраняются до явной очистки браузера или вызова `cacheManager.clear()`.

**Причины:**
- Пользовательские данные должны сохраняться между сессиями
- Настройки должны быть доступны при следующем открытии
- Нет необходимости в автоматической очистке при закрытии вкладки

> § <br> ПРАВИЛА ПРИНЯТИЯ РЕШЕНИЙ

## Добавление нового ключа кэша

### 1. Выбор слоя хранения

**Hot (localStorage), если:**
- Объем < 100KB
- Частый доступ (при каждом рендере/действии)
- Простые структуры данных (примитивы, простые объекты)

**Warm (IndexedDB), если:**
- Объем 100KB–10MB
- Частый доступ
- Структурированные данные (массивы, сложные объекты)

**Cold (IndexedDB), если:**
- Объем > 10MB
- Редкий доступ (по требованию, не при каждом рендере)
- Большие структурированные данные

**Добавить ключ:** `core/cache/storage-layers.js` → `LAYERS.{layer}.keys`

### 2. Версионирование

**Версионировать, если:**
- Данные из внешних API (CoinGecko, AI провайдеры, и т.д.)
- Данные парсятся из ответов API
- Структура зависит от версии приложения
- Ошибки в старых данных могут вызвать сбои

**Не версионировать, если:**
- Пользовательские данные (портфели, стратегии, настройки)
- UI-состояние (активная вкладка, избранное)
- Данные с миграциями схем

**Добавить ключ:** `core/cache/cache-manager.js` → `getVersionedKey()` → массив `versionedKeys`

### 3. TTL

**С TTL, если:**
- Данные устаревают (цены, метрики, API-ответы)
- Есть источник обновления (внешний API)
- Актуальность важнее персистентности

**Без TTL, если:**
- Пользовательские данные (должны сохраняться)
- Настройки (пользователь не должен терять)
- Данные генерируются локально

**Добавить TTL:** `core/cache/cache-config.js` → объект `TTL`

**Рекомендуемые значения:**
- Данные, меняющиеся часто (цены, метрики): 1 час
- Данные, меняющиеся редко (списки монет): 1 день
- Кэш API-ответов: 5 минут
- Пользовательские данные: `null` (без TTL)

### 4. Стратегия кэширования

**cache-first**, если:
- Данные стабильны, актуальность не критична
- Важна скорость доступа (иконки, списки)

**network-first**, если:
- Актуальность критична (цены, метрики)
- Источник данных надежен

**stale-while-revalidate**, если:
- Баланс между актуальностью и производительностью
- Допустимо показывать немного устаревшие данные

**cache-only**, если:
- Только локальные данные (нет источника обновления)
- Пользовательские данные

**Добавить стратегию:** `core/cache/cache-config.js` → объект `STRATEGIES`

### 5. Версия схемы (для пользовательских данных)

Если структура данных может измениться и это пользовательские данные (не версионируются приложением):
- Добавить версию в `core/cache/cache-config.js` → объект `VERSIONS`
- Создать миграцию в `core/cache/cache-migrations.js`

> § <br> ССЫЛКИ

**Файлы модуля:**
- `core/cache/cache-manager.js` — единый интерфейс, версионирование приложения
- `core/cache/cache-config.js` — TTL, стратегии, версии схем
- `core/cache/storage-layers.js` — распределение ключей по слоям
- `core/cache/cache-migrations.js` — миграции схем данных
- `core/cache/cache-cleanup.js` — политики очистки
- `core/cache/cache-indexes.js` — индексы IndexedDB

**Связанные документы:**
- `docs/doc-architect.md` — архитектурный план (раздел "Принципы кэширования")
- `docs/doc-ai-providers.md` — AI провайдеры (кэширование переводов tooltips)
