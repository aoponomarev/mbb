<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GigaChat API Test</title>
</head>
<body>

    <h1>GigaChat API Test</h1>

    <!-- –ü–æ–ª–µ –¥–ª—è API –∫–ª—é—á–∞ -->
    <div style="margin-bottom: 10px;">
        <label for="api-key-input">Authorization Key (GigaChat, Base64):</label><br>
        <input type="password" id="api-key-input" style="width: 400px;" placeholder="–í–≤–µ–¥–∏—Ç–µ Authorization Key (Base64)">
        <button id="toggle-api-key-visibility" style="margin-left: 5px;">üëÅÔ∏è</button>
        <button id="save-api-key" style="margin-left: 5px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞ -->
    <textarea id="response-textarea" rows="10" cols="80" readonly></textarea><br>
    <input type="text" id="query-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å">
    <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è GigaChat API
        const GIGACHAT_OAUTH_URL = 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth';
        const GIGACHAT_PROXY_URL = 'https://gigachat-api-proxy.ponomarev-ux.workers.dev';
        const STORAGE_KEY = 'gigachat-api-key';

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è API –∫–ª—é—á–∞ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ –∏–ª–∏ localStorage
        function getApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput.value.trim();

            if (apiKey) {
                return apiKey;
            }

            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                apiKeyInput.value = savedKey;
                return savedKey;
            }

            return null;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è API –∫–ª—é—á–∞
        function saveApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            const apiKey = apiKeyInput.value.trim();

            if (apiKey) {
                localStorage.setItem(STORAGE_KEY, apiKey);
                alert('Authorization Key —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ Authorization Key –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º');
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–ª—é—á –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                document.getElementById('api-key-input').value = savedKey;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        document.getElementById('save-api-key').addEventListener('click', saveApiKey);

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ API –∫–ª—é—á–∞
        document.getElementById('toggle-api-key-visibility').addEventListener('click', function() {
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                apiKeyInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // –î–µ–±–∞–≥-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        const logs = [];
        function log(message, data = null) {
            const entry = {
                time: new Date().toISOString(),
                message,
                data: data ? JSON.parse(JSON.stringify(data)) : null
            };
            logs.push(entry);
            console.log(`[${entry.time}] ${message}`, data || '');

            const logText = logs.map(l =>
                `[${l.time}] ${l.message}${l.data ? '\n' + JSON.stringify(l.data, null, 2) : ''}`
            ).join('\n\n');
            document.getElementById('response-textarea').value = logText;
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        document.getElementById('send-button').addEventListener('click', async function() {
            log('Button clicked');

            const query = document.getElementById('query-input').value || '–ü—Ä–∏–≤–µ—Ç';
            log('Query value read', { query });

            await sendGigaChatRequest(query);
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat API
        async function sendGigaChatRequest(query) {
            log('Starting GigaChat API request');

            const authKey = getApiKey();
            if (!authKey) {
                log('‚ùå Authorization Key –Ω–µ –≤–≤–µ–¥–µ–Ω', {
                    message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ Authorization Key (Base64) –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞'
                });
                return;
            }

            try {
                // –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ OAuth (–ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞)
                log('–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ OAuth', {
                    oauthUrl: GIGACHAT_OAUTH_URL,
                    method: 'direct browser request'
                });

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π RqUID –¥–ª—è —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ –∑–∞–ø—Ä–æ—Å–∞
                const rqUID = crypto.randomUUID();

                // –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ OAuth endpoint –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ (–æ–±—Ö–æ–¥ –ø—Ä–æ–±–ª–µ–º—ã —Å SSL –≤ Worker)
                let oauthResponse;
                try {
                    oauthResponse = await fetch(GIGACHAT_OAUTH_URL, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Basic ${authKey}`,
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json',
                            'RqUID': rqUID,
                        },
                        body: 'scope=GIGACHAT_API_PERS'
                    });
                } catch (fetchError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OAuth endpoint', {
                        error: fetchError.message,
                        name: fetchError.name,
                        details: '–í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å CORS –∏–ª–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º'
                    });
                    return;
                }

                if (!oauthResponse.ok) {
                    const errorText = await oauthResponse.text();

                    log('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', {
                        status: oauthResponse.status,
                        error: errorText
                    });
                    return;
                }

                const oauthData = await oauthResponse.json();
                const accessToken = oauthData.access_token;

                if (!accessToken) {
                    log('‚ùå –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –Ω–µ –ø–æ–ª—É—á–µ–Ω');
                    return;
                }

                log('‚úÖ –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—É—á–µ–Ω', {
                    tokenPrefix: accessToken.substring(0, 10) + '...',
                    expiresIn: oauthData?.expires_in
                });

                // –®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat API
                log('–®–∞–≥ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat API', {
                    proxyUrl: GIGACHAT_PROXY_URL
                });

                const chatRequestBody = {
                    model: 'GigaChat',
                    messages: [
                        {
                            role: 'user',
                            content: query
                        }
                    ],
                    temperature: 0.6,
                    max_tokens: 2000
                };

                log('Request body prepared', {
                    body: chatRequestBody
                });

                const chatResponse = await fetch(`${GIGACHAT_PROXY_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accessToken: accessToken,
                        ...chatRequestBody
                    })
                });

                log('Chat response received', {
                    status: chatResponse.status,
                    statusText: chatResponse.statusText,
                    ok: chatResponse.ok
                });

                const chatResponseText = await chatResponse.text();
                log('Chat response body (raw)', {
                    text: chatResponseText,
                    length: chatResponseText.length
                });

                if (!chatResponse.ok) {
                    log('‚ùå GigaChat API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É', {
                        status: chatResponse.status,
                        error: chatResponseText
                    });
                    return;
                }

                const chatData = JSON.parse(chatResponseText);
                log('Chat response body (parsed)', { data: chatData });

                if (chatData.choices && chatData.choices.length > 0) {
                    const answer = chatData.choices[0].message.content;
                    log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat API', { answer });
                } else {
                    log('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', { data: chatData });
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ GigaChat API', {
                    error: error.message,
                    name: error.name,
                    stack: error.stack
                });
            }
        }
    </script>

</body>
</html>
