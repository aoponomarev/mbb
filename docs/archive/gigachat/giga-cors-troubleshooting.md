# Устранение проблем: GigaChat CORS

> Руководство по устранению проблем при работе с GigaChat API через прокси

## Проблема: CORS ошибки в браузере

### Симптомы

- Ошибка в консоли браузера: `Access to fetch at '...' has been blocked by CORS policy`
- Запрос не доходит до прокси
- Ответ от прокси не обрабатывается браузером

### Решение

1. **Проверьте CORS заголовки в ответе прокси:**
   - Откройте DevTools → Network
   - Найдите запрос к прокси
   - Проверьте заголовки ответа:
     - `Access-Control-Allow-Origin` должен быть `*` или конкретный домен
     - `Access-Control-Allow-Methods` должен содержать `POST, OPTIONS`
     - `Access-Control-Allow-Headers` должен содержать `Content-Type`

2. **Проверьте обработку OPTIONS запросов:**
   - Прокси должен обрабатывать OPTIONS запросы (preflight)
   - Ответ на OPTIONS должен быть статус 204
   - Все CORS заголовки должны быть в ответе на OPTIONS

3. **Проверьте код прокси:**
   - Убедитесь, что код соответствует `giga-oauth-proxy-code.md`
   - Проверьте, что CORS заголовки добавляются во все ответы

## Проблема: Ошибка получения OAuth токена

### Симптомы

- Ошибка в логах прокси: `OAuth error: 401` или `OAuth error: 403`
- Ошибка: `Authorization Key не настроен`

### Решение

1. **Проверьте Authorization Key:**
   - Убедитесь, что ключ сохранен в переменных окружения прокси
   - Проверьте, что ключ имеет формат Base64
   - Убедитесь, что ключ не истек (если есть срок действия)

2. **Проверьте переменные окружения:**
   - Для Cloudflare Workers: Settings → Variables → Environment Variables
   - Для Yandex Cloud Functions: Переменные окружения
   - Убедитесь, что переменная `GIGACHAT_AUTH_KEY` существует и заполнена

3. **Проверьте OAuth endpoint:**
   - Убедитесь, что прокси может обращаться к `https://ngw.devices.sberbank.ru:9443/api/v2/oauth`
   - Проверьте, что нет блокировок на уровне сети/файрвола

## Проблема: Ошибка запроса к Chat API

### Симптомы

- Ошибка в логах прокси: `Chat API error: 401` или `Chat API error: 403`
- Ошибка: `access_token expired` или `invalid access_token`

### Решение

1. **Проверьте кэширование токенов:**
   - Убедитесь, что токены кэшируются правильно
   - Проверьте, что токены обновляются при истечении
   - Убедитесь, что проверка истечения токена работает (запас 60 сек)

2. **Проверьте формат запроса:**
   - Убедитесь, что запрос к Chat API имеет правильный формат
   - Проверьте заголовок `Authorization: Bearer {access_token}`
   - Убедитесь, что поле `messages` не пустое

3. **Проверьте Chat API endpoint:**
   - Убедитесь, что прокси может обращаться к `https://gigachat.devices.sberbank.ru/api/v1/chat/completions`
   - Проверьте, что нет блокировок на уровне сети/файрвола

## Проблема: Таймауты запросов

### Симптомы

- Запрос обрывается по таймауту
- Ошибка: `Timeout` или `Request timeout`

### Решение

1. **Увеличьте таймаут прокси:**
   - Для Cloudflare Workers: обычно 30 секунд по умолчанию
   - Для Yandex Cloud Functions: установите таймаут 30 секунд или больше

2. **Оптимизируйте запросы:**
   - Убедитесь, что кэширование токенов работает (не получаем токен каждый раз)
   - Проверьте, что OAuth запрос не занимает слишком много времени

## Проблема: Неожиданный формат ответа

### Симптомы

- Ошибка: `Неожиданный формат ответа`
- Ответ от API не содержит ожидаемых полей

### Решение

1. **Проверьте формат ответа GigaChat:**
   - Ответ должен содержать поле `choices` с массивом
   - Каждый элемент `choices` должен содержать `message.content`
   - Проверьте структуру ответа в логах прокси

2. **Проверьте обработку ответа:**
   - Убедитесь, что код правильно извлекает `choices[0].message.content`
   - Проверьте, что обработка ошибок работает корректно

## Проблема: Прокси недоступен

### Симптомы

- Ошибка: `Failed to fetch` или `Network error`
- Прокси не отвечает

### Решение

1. **Проверьте статус прокси:**
   - Убедитесь, что прокси активен (Active / Активна)
   - Проверьте логи прокси на наличие ошибок

2. **Проверьте публичный доступ:**
   - Для Cloudflare Workers: убедитесь, что Route настроен правильно
   - Для Yandex Cloud Functions: убедитесь, что "Публичная функция" включена

3. **Проверьте URL прокси:**
   - Убедитесь, что URL прокси правильный
   - Проверьте, что URL доступен из браузера (попробуйте открыть в новой вкладке)

## Общие рекомендации

1. **Всегда проверяйте логи прокси** при возникновении проблем
2. **Используйте `giga-cors.html`** для тестирования перед использованием `giga-chat.html`
3. **Проверяйте DevTools → Network** для диагностики проблем с CORS
4. **Убедитесь, что код прокси обновлен** до последней версии из `giga-oauth-proxy-code.md`

## ССЫЛКИ

- Код прокси: `giga-oauth-proxy-code.md`
- Пошаговое руководство: `giga-oauth-proxy-steps-guide.md`
- Чеклист перед чатом: `giga-pre-chat-checklist.md`
- Тестовая страница: `giga-cors.html`
