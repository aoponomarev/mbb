# Тестирование Cloudflare Worker для GigaChat

## Важно: UI особенности Cloudflare Workers

⚠️ **Настройки HTTP-запроса не сохраняются!**

В Cloudflare Workers:
- **Preview** всегда делает GET запрос (открывает URL в браузере)
- **HTTP** вкладка сбрасывает настройки (POST, Body, Headers) после:
  - Деплоя функции
  - Перезагрузки страницы
  - Перехода на другую вкладку
  - Изменения кода

**Это нормальное поведение UI** - настройки HTTP-запроса не сохраняются между сессиями.

**Решение**: Используйте `giga-cors.html` для тестирования - там все настройки сохраняются!

## Способы тестирования

### Способ 1: Через giga-cors.html ⭐ (РЕКОМЕНДУЕТСЯ!)

**Лучший способ** - настройки сохраняются, удобный интерфейс, видно все детали ответа:

1. Откройте файл `docs/archive/gigachat/giga-cors.html` в браузере
2. В поле **"URL прокси"** введите: `https://gigachat-api-proxy.ponomarev-ux.workers.dev`
3. Поле **"Authorization Key"** оставьте **пустым** (ключ уже в переменных окружения Worker)
4. Выберите модель: `GigaChat`
5. Введите запрос: "Привет! Расскажи о себе."
6. Нажмите **"Отправить запрос"**
7. Проверьте результат в области "Логи запросов"

**Преимущества:**
- ✅ Все настройки сохраняются (URL, ключ)
- ✅ Удобный интерфейс с логами
- ✅ Видно детали запроса и ответа
- ✅ Автоматически правильный формат запроса

### Способ 2: Через вкладку HTTP в Preview (временно, настройки не сохраняются)

1. В редакторе Worker откройте вкладку **"HTTP"** (рядом с "Preview")
2. Выберите метод: **POST**
3. URL должен быть: `https://gigachat-api-proxy.ponomarev-ux.workers.dev`
4. В разделе **"Body"** выберите **"raw"** → **"JSON"**
5. Вставьте тестовый запрос:
   ```json
   {
     "model": "GigaChat",
     "messages": [
       {
         "role": "user",
         "content": "Привет! Расскажи о себе."
       }
     ],
     "temperature": 0.6,
     "max_tokens": 2000
   }
   ```
6. Нажмите **"Send"** или **"Отправить"**
7. Проверьте ответ

### Способ 3: Через curl (для быстрой проверки)

1. Откройте файл `docs/archive/gigachat/giga-cors.html` в браузере
2. В поле **"URL прокси"** введите: `https://gigachat-api-proxy.ponomarev-ux.workers.dev`
3. Поле **"Authorization Key"** можно оставить пустым (ключ в переменных окружения)
4. Выберите модель: `GigaChat`
5. Введите запрос: "Привет! Расскажи о себе."
6. Нажмите **"Отправить запрос"**
7. Проверьте результат в логах

### Способ 3: Через curl (для быстрой проверки)

```bash
curl -X POST https://gigachat-api-proxy.ponomarev-ux.workers.dev \
  -H "Content-Type: application/json" \
  -d '{
    "model": "GigaChat",
    "messages": [
      {
        "role": "user",
        "content": "Привет!"
      }
    ]
  }'
```

## Проверка настроек

### ✅ Переменные окружения

В настройках Worker (Settings → Variables and Secrets):
- ✅ **Имя**: `GIGACHAT_AUTH_KEY` (точное совпадение!)
- ✅ **Тип**: `Secret` (рекомендуется)
- ✅ **Значение**: Base64 ключ (без префикса "Basic ")

### ✅ Код функции

Проверьте, что в коде:
- ✅ Функция `handleRequest(request, env)` получает параметр `env`
- ✅ Используется `env.GIGACHAT_AUTH_KEY` (не `process.env`)
- ✅ Экспорт: `export default { async fetch(request, env) { return handleRequest(request, env); } }`

### ✅ Домены и Routes

В настройках (Settings → Domains & Routes):
- ✅ Должен быть активный route: `gigachat-api-proxy.ponomarev-ux.workers.dev`

## Типичные ошибки и решения

### Ошибка: "Authorization Key не настроен"

**Причины:**
1. Переменная не добавлена или названа неправильно
2. Worker не переразвернут после добавления переменной

**Решение:**
1. Проверьте название переменной: должно быть точно `GIGACHAT_AUTH_KEY`
2. Перейдите на вкладку **"Code"**
3. Нажмите **"Save and deploy"** (даже если код не менялся)

### Ошибка: "Метод не поддерживается" в Preview

**Это нормально!** Preview делает GET запрос. Используйте:
- Вкладку **"HTTP"** в Preview
- Или тестируйте через `giga-cors.html`

### Ошибка: OAuth error 400

**Причины:**
1. Неправильный формат Authorization Key
2. Ключ содержит префикс "Basic "

**Решение:**
1. Убедитесь, что ключ в Base64 формате (без "Basic ")
2. Ключ должен быть: `ClientID:ClientSecret` в Base64

### Ошибка: CORS error

**Причины:**
1. CORS заголовки не возвращаются
2. OPTIONS запрос не обрабатывается

**Решение:**
1. Проверьте, что функция возвращает CORS заголовки во всех ответах
2. Проверьте обработку OPTIONS запросов

## ССЫЛКИ

- Код Worker: `giga-oauth-proxy-code.md` (раздел "Вариант 1")
- Настройка переменных: `giga-cloudflare-env-setup.md`
- Тестовая страница: `giga-cors.html`
