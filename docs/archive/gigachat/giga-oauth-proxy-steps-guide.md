# Пошаговое руководство: Создание прокси-функции GigaChat API

## Выбор платформы

Выберите платформу для прокси:
- **Cloudflare Workers** (рекомендуется для начала)
- **Yandex Cloud Functions** (если уже используете Yandex Cloud)
- Другие serverless-платформы

## Вариант A: Cloudflare Workers

### Шаг 1: Создание Worker

1. Войдите в Cloudflare Dashboard: https://dash.cloudflare.com
2. Выберите ваш аккаунт
3. Перейдите в раздел **Workers & Pages**
4. Нажмите **"Create application"** → **"Create Worker"**
5. Заполните параметры:
   - Имя: `gigachat-proxy` (или другое)
   - Описание: "Прокси для GigaChat API с поддержкой CORS и OAuth"
6. Нажмите **"Deploy"**

### Шаг 2: Вставка кода

1. Откройте созданный Worker в редакторе
2. Откройте файл `giga-oauth-proxy-code.md`
3. Скопируйте код из раздела **"Вариант 1: Cloudflare Workers"**
4. Замените код в редакторе Cloudflare Workers
5. Нажмите **"Save and deploy"**

### Шаг 3: Настройка переменных окружения

1. В настройках Worker найдите раздел **"Settings"** → **"Variables"**
2. Перейдите на вкладку **"Environment Variables"**
3. Нажмите **"Add variable"**
4. Заполните:
   - **Variable name:** `GIGACHAT_AUTH_KEY`
   - **Value:** ваш Authorization Key (Base64) из `giga-get-api-key.md`
   - **Type:** Secret (рекомендуется) или Plain text
5. Нажмите **"Save"**

### Шаг 4: Настройка Routes (опционально)

1. В настройках Worker найдите раздел **"Triggers"**
2. Добавьте Route (если нужно использовать свой домен):
   - Route: `yourdomain.com/gigachat/*`
   - Zone: выберите ваш домен
   - Path: `/gigachat/*`
3. Или используйте стандартный URL Worker: `https://your-worker.your-subdomain.workers.dev`

### Шаг 5: Тестирование

1. Откройте `giga-cors.html` в браузере
2. Введите URL Worker (например: `https://gigachat-proxy.your-subdomain.workers.dev`)
3. Введите тестовый запрос
4. Нажмите **"Отправить запрос"**
5. Проверьте логи Worker в разделе **"Logs"**

## Вариант B: Yandex Cloud Functions

### Шаг 1: Подготовка аккаунта Yandex Cloud

1. Войдите в Yandex Cloud Console: https://console.yandex.cloud
2. Убедитесь, что у вас есть каталог (folder) для проекта
3. Запишите Folder ID

### Шаг 2: Создание функции

1. Перейдите в раздел **Cloud Functions** (или **Serverless** → **Functions**)
2. Нажмите **"Создать функцию"**
3. Заполните параметры:
   - Имя: `mbb-gigachat-proxy` (или другое)
   - Описание: "Прокси для GigaChat API с поддержкой CORS и OAuth"
   - Среда выполнения: Node.js 18 (или новее)
4. Выберите способ создания: **"Редактор кода"**
5. Нажмите **"Создать"**

### Шаг 3: Вставка кода

1. На странице создания версии функции выберите среду выполнения: **Node.js** (версия 18 или новее)
2. Снимите галочку **"Добавить файлы с примерами кода"** (если отмечено)
3. Нажмите **"Продолжить"**
4. В редакторе кода удалите пример кода (если есть)
5. Откройте файл `giga-oauth-proxy-code.md`
6. Скопируйте код из раздела **"Вариант 2: Yandex Cloud Functions"**
7. Вставьте код в редактор

### Шаг 4: Настройка переменных окружения

1. Прокрутите страницу вниз до раздела **"Переменные окружения"**
2. Нажмите кнопку **"Добавить"** или **"Добавить переменную"**
3. В поле **"Ключ"** введите: `GIGACHAT_AUTH_KEY`
4. В поле **"Значение"** введите ваш Authorization Key (Base64) из `giga-get-api-key.md`
5. Тип: **"Секрет"** (если доступно) или **"Переменная"**
6. Нажмите **"Сохранить"**

### Шаг 5: Установка таймаута

1. Найдите раздел **"Ресурсы"** или **"Параметры выполнения"**
2. Найдите поле **"Таймаут, с"** или **"Timeout"**
3. Установите значение: **30** секунд (рекомендуется для OAuth + API запросов)
4. Остальные параметры можно оставить по умолчанию:
   - Память: 128 МБ
   - Сервисный аккаунт: не требуется (или оставить пустым)

### Шаг 6: Настройка HTTP-триггера

1. Перейдите в раздел **"Триггеры"**
2. Создайте HTTP-триггер:
   - Тип: HTTP
   - Метод: POST, OPTIONS (для CORS preflight)
   - URL: сохранить для использования в конфигурации
3. Записать URL функции (формат: `https://functions.yandexcloud.net/...`)

### Шаг 7: Публичный доступ

1. На странице функции найдите переключатель **"Публичная функция"**
2. Переключатель должен быть **ВКЛЮЧЕН** (зеленый/активный)
3. Если выключен — включите его и сохраните изменения

**Важно:** Без публичного доступа функция недоступна из браузера!

### Шаг 8: Сохранение и деплой

1. Прокрутите страницу вниз до кнопки **"Создать версию"**
2. Нажмите кнопку **"Создать версию"**
3. Дождитесь завершения деплоя
4. Статус должен измениться на **"Активна"**

### Шаг 9: Тестирование

1. Откройте `giga-cors.html` в браузере
2. В поле **"URL прокси"** введите URL функции (например: `https://functions.yandexcloud.net/d4erd8d1pttbufsl26s1`)
3. Введите тестовый запрос: "Привет! Расскажи о себе."
4. Нажмите **"Отправить запрос"**
5. Проверьте логи на странице — должен быть успешный ответ от GigaChat
6. Проверьте логи функции в разделе **"Логи"** на наличие ошибок

## Общие шаги (для всех платформ)

### Проверка работы OAuth

В логах прокси должны быть записи о:
- Получении OAuth токена
- Использовании кэшированного токена (при повторных запросах)
- Обновлении токена при истечении

### Проверка CORS

1. Откройте DevTools → Network
2. Выполните запрос через `giga-cors.html`
3. Проверьте заголовки ответа:
   - `Access-Control-Allow-Origin: *`
   - `Access-Control-Allow-Methods: POST, OPTIONS`
   - `Access-Control-Allow-Headers: Content-Type`

### Устранение проблем

Если возникают ошибки:
1. Проверьте логи прокси на наличие ошибок
2. Убедитесь, что Authorization Key корректный
3. Проверьте, что OAuth endpoint доступен из прокси
4. Проверьте, что Chat API endpoint доступен
5. См. `giga-cors-troubleshooting.md` (после создания)

## ССЫЛКИ

- Код прокси: `giga-oauth-proxy-code.md`
- Задание для создания прокси: `giga-oauth-proxy-task.md`
- Получение API ключа: `giga-get-api-key.md`
- Тестовая страница: `giga-cors.html`
- План интеграции: `giga-integration-mbb-plan.md`
