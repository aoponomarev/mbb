# Интеграция MBB с GigaChat API

> Оглавление `giga-integration-mbb.md`
- § Текущее состояние — описание текущей ситуации и требований
- § Целевая архитектура — решение на базе прокси-сервиса
- § Преимущества проксирования — преимущества использования прокси для OAuth и API
- § Проверка возможностей — подтверждение возможностей проксирования
- § Технические детали — детали реализации

> § <br> ТЕКУЩЕЕ СОСТОЯНИЕ

## Проблема

Приложение работает из папки на ПК (file:// протокол) или развернуто на GitHub Pages (статический хостинг). Для работы с некоторыми функциями требуется использование данных, поставляемых чат-ботом (GigaChat).

GigaChat API блокирует CORS-запросы из браузера, поэтому требуется проксирование запросов. Кроме того, GigaChat использует двухэтапную аутентификацию: сначала получение токена доступа через OAuth, затем использование токена для запросов к API.

## Решение

Использование прокси-сервиса (например, Cloudflare Workers, Yandex Cloud Functions или другой serverless-платформы) для:
- Обработки CORS-запросов от клиентских приложений
- Получения OAuth токена доступа
- Проксирования запросов к GigaChat API
- Возврата ответов с корректными CORS-заголовками

> § <br> ЦЕЛЕВАЯ АРХИТЕКТУРА

## Схема интеграции

```
┌─────────────────┐
│  Приложение     │
│  (file:// или   │
│   GitHub Pages) │
└────────┬────────┘
         │ HTTPS (CORS разрешен)
         ▼
┌─────────────────────────────┐
│  Прокси-сервис              │
│  (Cloudflare Workers /      │
│   Yandex Cloud Functions)   │
│  - Обрабатывает CORS        │
│  - Получает OAuth токен     │
│  - Проксирует запросы       │
│  - Хранит API ключ          │
└────────┬────────────────────┘
         │ HTTPS (без CORS проблем)
         ▼
┌─────────────────────────────┐
│  GigaChat API               │
│  - OAuth: получение токена  │
│  - Chat API: чат-запросы    │
└─────────────────────────────┘
```

## Процесс работы

### Этап 1: Получение OAuth токена (на прокси)

1. Клиент отправляет запрос на прокси с Authorization Key (Base64)
2. Прокси получает OAuth токен доступа через GigaChat OAuth API
3. Прокси кэширует токен (до истечения срока действия)
4. Прокси возвращает токен клиенту (или использует его для следующих запросов)

### Этап 2: Запрос к GigaChat API (через прокси)

1. Клиент отправляет запрос с сообщением на прокси
2. Прокси использует OAuth токен для запроса к GigaChat Chat API
3. Прокси возвращает ответ с CORS заголовками клиенту

## Варианты проксирования

### 1. Cloudflare Workers (рекомендуется для начала)

Serverless-функции на грани Cloudflare с поддержкой CORS.

**Преимущества**:
- ✅ Бесплатный тариф для небольших проектов
- ✅ Глобальная CDN-сеть
- ✅ Встроенная поддержка CORS
- ✅ HTTPS по умолчанию
- ✅ Простое развертывание через Wrangler CLI

### 2. Yandex Cloud Functions

Serverless-функции для проксирования запросов с поддержкой CORS.

**Преимущества**:
- ✅ Единая платформа (если уже используется Yandex Cloud)
- ✅ Встроенная аутентификация через Service Account
- ✅ Безопасное хранение API-ключей через переменные окружения
- ✅ HTTPS по умолчанию

### 3. Другие платформы

- AWS Lambda
- Vercel Functions
- Netlify Functions

> § <br> ПРЕИМУЩЕСТВА ПРОКСИРОВАНИЯ

## Безопасность

- **Хранение API-ключей**: API-ключи хранятся в переменных окружения прокси, а не передаются через клиент
- **OAuth токены**: Обработка OAuth происходит на сервере, токены не передаются через браузер
- **HTTPS по умолчанию**: весь трафик шифруется

## Мониторинг и логирование

- **Централизованные логи**: логи OAuth и API в одном месте
- **Трейсинг**: отслеживание запросов от клиента до API
- **Обработка ошибок**: единая точка обработки ошибок

## Производительность

- **Кэширование токенов**: токены доступа могут кэшироваться до истечения срока действия
- **Оптимизация**: возможность кэширования и оптимизации на уровне прокси
- **Глобальная сеть**: использование CDN для уменьшения задержки

> § <br> ПРОВЕРКА ВОЗМОЖНОСТЕЙ

## Подтвержденные возможности проксирования

На основе официальной документации GigaChat API и возможностей serverless-платформ подтверждено, что проксирование **полностью поддерживает** все необходимые возможности:

### ✅ Обработка CORS

**Подтверждено**: Прокси может обрабатывать CORS-запросы и добавлять необходимые заголовки в ответы (`Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, `Access-Control-Allow-Headers`).

### ✅ Получение OAuth токена

**Подтверждено**: Прокси может выполнять запросы к GigaChat OAuth API для получения токена доступа.

**Endpoint**: `https://ngw.devices.sberbank.ru:9443/api/v2/oauth`

**Формат запроса**:
```
POST https://ngw.devices.sberbank.ru:9443/api/v2/oauth
Headers:
  Authorization: Basic {base64_credentials}
  Content-Type: application/x-www-form-urlencoded
  Accept: application/json
  RqUID: {uuid}
Body: scope=GIGACHAT_API_PERS
```

### ✅ Запросы к GigaChat Chat API

**Подтверждено**: Прокси может отправлять запросы к GigaChat Chat API с использованием полученного OAuth токена.

**Endpoint**: `https://gigachat.devices.sberbank.ru/api/v1/chat/completions`

**Формат запроса**:
```
POST https://gigachat.devices.sberbank.ru/api/v1/chat/completions
Headers:
  Authorization: Bearer {access_token}
  Content-Type: application/json
Body: {
  "model": "GigaChat",
  "messages": [...],
  "temperature": 0.6,
  "max_tokens": 2000
}
```

### ✅ Кэширование токенов

**Подтверждено**: Прокси может кэшировать OAuth токены до истечения срока действия (`expires_in`), что уменьшает количество запросов к OAuth API.

> § <br> ТЕХНИЧЕСКИЕ ДЕТАЛИ

*Раздел будет дополняться по мере обсуждения деталей интеграции*

## Формат запроса к прокси

*Будет определен в процессе обсуждения*

## Формат ответа от прокси

*Будет определен в процессе обсуждения*

## Обработка CORS

Прокси должен обрабатывать CORS-запросы, включая:
- Добавление заголовков `Access-Control-Allow-Origin: *` (или конкретный домен)
- Обработка preflight-запросов (OPTIONS)
- Настройка заголовков `Access-Control-Allow-Methods` и `Access-Control-Allow-Headers`

*Детали реализации будут определены в процессе обсуждения*

## Безопасное хранение API-ключей

API-ключи должны храниться в переменных окружения прокси, что исключает необходимость передачи их через клиентское приложение.

*Детали реализации будут определены в процессе обсуждения*

## ССЫЛКИ НА ДОКУМЕНТАЦИЮ

- GigaChat API: https://developers.sber.ru/help
- Cloudflare Workers: https://developers.cloudflare.com/workers/
- Yandex Cloud Functions: https://yandex.cloud/ru/docs/functions/

## ССЫЛКИ

- План интеграции: `giga-integration-mbb-plan.md`
- Задание для создания прокси: `giga-oauth-proxy-task.md`
