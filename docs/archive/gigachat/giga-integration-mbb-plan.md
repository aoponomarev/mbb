# План интеграции MBB с GigaChat API

> Оглавление `giga-integration-mbb-plan.md`
- § Подготовка — подготовительные шаги, включая получение API ключа
- § Создание прокси — создание прокси-функции
- § Настройка проекта — обновление конфигурации проекта
- § Тестирование — проверка работы интеграции
- § Чеклист — проверочный список задач

> § <br> ПОДГОТОВКА

## Шаг 1: Получение API ключа GigaChat

- [ ] Зарегистрироваться/войти в аккаунт SberDevices: https://developers.sber.ru
- [ ] Перейти в раздел GigaChat API
- [ ] Создать приложение (если еще не создано)
- [ ] Получить Authorization Key (Base64)
  - Перейти в настройки приложения
  - Создать новый ключ доступа
  - Скопировать и сохранить ключ (формат: Base64 строка)
- [ ] Сохранить ключ в безопасное место (понадобится для переменных окружения прокси)

**Как получить API ключ:** Подробная инструкция в `giga-get-api-key.md`

## Шаг 2: Выбор платформы прокси

Выберите платформу для прокси:

### Вариант A: Cloudflare Workers (рекомендуется для начала)

- [ ] Зарегистрироваться/войти в аккаунт Cloudflare
- [ ] Установить Wrangler CLI (если планируется локальная разработка)
- [ ] Создать новый Worker через панель управления или CLI

### Вариант B: Yandex Cloud Functions

- [ ] Зарегистрироваться/войти в аккаунт Yandex Cloud
- [ ] Создать каталог (folder) для проекта, если еще не создан
- [ ] Настроить Service Account (если требуется)

## Шаг 3: Подготовка инструментов для тестирования

- [ ] Изучить документацию GigaChat API: https://developers.sber.ru/help
- [ ] Изучить документацию выбранной платформы прокси
- [ ] Подготовить тестовую страницу для проверки CORS

> § <br> СОЗДАНИЕ ПРОКСИ

## Шаг 1: Создание прокси-функции

Выберите платформу и следуйте соответствующему руководству:

### Cloudflare Workers

- [ ] Создать новый Worker через панель управления Cloudflare
- [ ] Следовать инструкциям из `giga-cloudflare-worker-task.md` (если будет создан)

### Yandex Cloud Functions

- [ ] Перейти в раздел Cloud Functions в Yandex Cloud Console
- [ ] Нажать "Создать функцию"
- [ ] Заполнить параметры:
  - Имя: `mbb-gigachat-proxy` (или другое)
  - Описание: "Прокси для GigaChat API с поддержкой CORS и OAuth"
  - Среда выполнения: Node.js 18 (или новее)
- [ ] Выбрать способ создания: "Редактор кода"
- [ ] Нажать "Создать"
- [ ] Следовать инструкциям из `giga-oauth-proxy-steps-guide.md`

## Шаг 2: Написание кода прокси

- [ ] Изучить задание из `giga-oauth-proxy-task.md`
- [ ] Создать код прокси-функции:
  - Обработка CORS (preflight OPTIONS запросы)
  - Получение OAuth токена
  - Проксирование запросов к GigaChat API
  - Обработка ошибок
- [ ] Использовать код из `giga-oauth-proxy-code.md` (после создания)

**⚠️ ВАЖНО**: Обратите внимание на особенности:
- В Node.js 18+ `fetch` доступен глобально, не требуется `require('node-fetch')`
- OAuth токены должны кэшироваться до истечения срока действия
- Необходимо обрабатывать обновление токенов при истечении

## Шаг 3: Настройка переменных окружения

- [ ] Перейти в настройки прокси → "Переменные окружения"
- [ ] Добавить переменную:
  - Ключ: `GIGACHAT_AUTH_KEY`
  - Значение: Authorization Key (Base64) из подготовительного шага
  - Тип: "Секрет" (если доступно) или "Переменная"
- [ ] Сохранить изменения

**Важно**: Authorization Key не должен передаваться через клиентское приложение.

## Шаг 4: Настройка HTTP-триггера / Routes

### Cloudflare Workers

- [ ] Настроить Route для Worker
- [ ] Убедиться, что Worker доступен по HTTPS

### Yandex Cloud Functions

- [ ] Перейти в раздел "Триггеры"
- [ ] Создать HTTP-триггер:
  - Тип: HTTP
  - Метод: POST, OPTIONS (для CORS preflight)
  - URL: сохранить для использования в конфигурации
- [ ] Записать URL функции (формат: `https://functions.yandexcloud.net/...`)

## Шаг 5: Публичный доступ

- [ ] Включить публичный доступ к прокси (если требуется настройка)
- [ ] Убедиться, что прокси доступен из интернета

## Шаг 6: Деплой прокси

- [ ] Сохранить код прокси
- [ ] Задеплоить прокси (нажать "Deploy" / "Создать версию")
- [ ] Дождаться успешного деплоя
- [ ] Проверить статус прокси (должен быть "Active" / "Активна")

> § <br> НАСТРОЙКА ПРОЕКТА

## Шаг 1: Обновление конфигурации

- [ ] Открыть файл `core/config/app-config.js`
- [ ] Добавить конфигурацию GigaChat:
```javascript
gigachat: {
    oauthUrl: 'https://ngw.devices.sberbank.ru:9443/api/v2/oauth',
    chatApiUrl: 'https://gigachat.devices.sberbank.ru/api/v1/chat/completions',
    proxyUrl: 'https://your-proxy-url.com', // URL прокси
    model: 'GigaChat',
    models: ['GigaChat', 'GigaChat-Pro', 'GigaChat-Max']
}
```

## Шаг 2: Создание провайдера GigaChat

- [ ] Создать файл `core/api/ai-providers/gigachat-provider.js`
- [ ] Реализовать класс `GigachatProvider` наследуя от `BaseAIProvider`
- [ ] Реализовать методы:
  - `sendRequest()` - отправка запроса через прокси
  - `getDefaultModel()` - возврат модели по умолчанию
  - `getAvailableModels()` - список доступных моделей
  - `getName()` - имя провайдера ('gigachat')
  - `getDisplayName()` - отображаемое имя ('GigaChat')

## Шаг 3: Регистрация провайдера

- [ ] Обновить `core/api/ai-provider-manager.js`:
  - Добавить импорт `GigachatProvider`
  - Зарегистрировать провайдер в списке доступных
- [ ] Обновить `core/modules-config.js`:
  - Добавить модуль `gigachat-provider`
  - Обновить зависимости

## Шаг 4: Обновление компонента настроек

- [ ] Обновить `app/components/ai-api-settings.js`:
  - Добавить поддержку GigaChat в список провайдеров
  - Добавить поля для настройки GigaChat (если требуются)
- [ ] Обновить `app/templates/ai-api-settings-template.js`:
  - Добавить UI для настройки GigaChat

> § <br> ТЕСТИРОВАНИЕ

## Шаг 1: Тестирование через giga-cors.html

- [ ] Открыть `giga-cors.html` в браузере (file:// протокол)
- [ ] Ввести URL прокси
- [ ] (Опционально) Ввести Authorization Key, если не хранится в env прокси
- [ ] Ввести тестовый запрос
- [ ] Нажать "Отправить запрос"
- [ ] Проверить в логах:
  - [ ] OAuth токен получен успешно
  - [ ] Запрос к Chat API отправлен успешно
  - [ ] CORS заголовки присутствуют в ответе
  - [ ] Ответ от API корректный
  - [ ] Нет ошибок CORS в консоли браузера

## Шаг 2: Тестирование через giga-chat.html

- [ ] Открыть `giga-chat.html` в браузере
- [ ] Настроить параметры (URL прокси, Authorization Key)
- [ ] Отправить несколько сообщений
- [ ] Проверить:
  - [ ] История диалога сохраняется
  - [ ] Ответы приходят корректно
  - [ ] Метаданные отображаются (токены, время)
  - [ ] Обработка ошибок работает

## Шаг 3: Локальное тестирование в приложении

- [ ] Открыть приложение локально (file://)
- [ ] Открыть DevTools → Network
- [ ] Переключиться на провайдер GigaChat в настройках
- [ ] Выполнить запрос через интерфейс приложения
- [ ] Проверить:
  - [ ] Запрос идет на URL прокси
  - [ ] CORS заголовки присутствуют в ответе
  - [ ] Ответ от API корректный
  - [ ] Нет ошибок в консоли

## Шаг 4: Тестирование на GitHub Pages

- [ ] Закоммитить изменения с обновленной конфигурацией
- [ ] Запушить в репозиторий
- [ ] Дождаться деплоя на GitHub Pages
- [ ] Проверить работу на https://your-username.github.io/repo-name/
- [ ] Убедиться, что CORS работает корректно

## Шаг 5: Тестирование обработки ошибок

- [ ] Проверить обработку неправильного Authorization Key
- [ ] Проверить обработку недоступности API
- [ ] Проверить обработку истечения OAuth токена
- [ ] Проверить обработку таймаутов
- [ ] Проверить обработку некорректного формата запроса
- [ ] Проверить логирование ошибок в прокси

> § <br> ЧЕКЛИСТ

## Подготовка

- [ ] Аккаунт SberDevices создан
- [ ] Authorization Key получен и сохранен
- [ ] Платформа прокси выбрана и настроена
- [ ] Инструменты для тестирования подготовлены

## Создание прокси

- [ ] Прокси создан и задеплоен
- [ ] Код прокси написан и работает
- [ ] Переменные окружения настроены (Authorization Key)
- [ ] HTTP-триггер / Route настроен и URL записан
- [ ] Публичный доступ включен

## Настройка проекта

- [ ] Конфигурация обновлена (`app-config.js`)
- [ ] Провайдер GigaChat создан
- [ ] Провайдер зарегистрирован в менеджере
- [ ] Компонент настроек обновлен

## Тестирование

- [ ] Тестирование через `giga-cors.html` пройдено успешно
- [ ] Тестирование через `giga-chat.html` пройдено успешно
- [ ] Локальное тестирование в приложении пройдено
- [ ] Тестирование на GitHub Pages пройдено
- [ ] Обработка ошибок проверена

## Документация

- [ ] Документация обновлена (`giga-integration-mbb.md`)
- [ ] План миграции выполнен
- [ ] Результаты тестирования задокументированы

## ССЫЛКИ

- Документация интеграции: `giga-integration-mbb.md`
- Задание для создания прокси: `giga-oauth-proxy-task.md`
- Код прокси: `giga-oauth-proxy-code.md` (после создания)
- Пошаговое руководство: `giga-oauth-proxy-steps-guide.md` (после создания)
- Тестовая страница CORS: `giga-cors.html` (после создания)
- Тестовая страница чата: `giga-chat.html` (после создания)
- Получение API ключа: `giga-get-api-key.md` (после создания)
