<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GigaChat CORS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .field-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        textarea {
            font-family: monospace;
            resize: vertical;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }
        .button-group {
            margin: 10px 0;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ccc;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #d32f2f;
        }
        .log-entry.success {
            border-left-color: #388e3c;
        }
    </style>
</head>
<body>

    <h1>GigaChat CORS Test</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã GigaChat API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏</p>

    <div class="info">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
        1. –í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏ (Cloudflare Workers, Yandex Cloud Functions –∏–ª–∏ –¥—Ä—É–≥–æ–π)<br>
        2. –í–≤–µ–¥–∏—Ç–µ Authorization Key GigaChat (Base64, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ env –ø—Ä–æ–∫—Å–∏)<br>
        3. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è GigaChat<br>
        4. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å" –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è URL –ø—Ä–æ–∫—Å–∏ -->
    <div class="field-group">
        <label for="proxy-url-input">URL –ø—Ä–æ–∫—Å–∏:</label>
        <input type="text" id="proxy-url-input" placeholder="https://your-proxy-url.com" value="">
        <button id="save-proxy-url">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è Authorization Key -->
    <div class="field-group">
        <label for="auth-key-input">Authorization Key GigaChat (Base64, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ env –ø—Ä–æ–∫—Å–∏):</label>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="password" id="auth-key-input" style="flex: 1;" placeholder="Base64 —Å—Ç—Ä–æ–∫–∞...">
            <button id="toggle-auth-key-visibility">üëÅÔ∏è</button>
            <button id="save-auth-key">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è –º–æ–¥–µ–ª–∏ -->
    <div class="field-group">
        <label for="model-select">–ú–æ–¥–µ–ª—å:</label>
        <select id="model-select" style="width: 100%; padding: 8px;">
            <option value="GigaChat">GigaChat</option>
            <option value="GigaChat-Pro">GigaChat-Pro</option>
            <option value="GigaChat-Max">GigaChat-Max</option>
        </select>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ -->
    <div class="field-group">
        <label for="query-input">–ó–∞–ø—Ä–æ—Å –∫ GigaChat:</label>
        <input type="text" id="query-input" placeholder="–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?" value="–ü—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ.">
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
    <div class="button-group">
        <button id="send-button" style="background: #2196f3; color: white; font-weight: bold;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –ª–æ–≥–æ–≤ -->
    <div class="field-group">
        <label for="log-textarea">–õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:</label>
        <textarea id="log-textarea" rows="20" readonly style="font-size: 12px;"></textarea>
    </div>

    <script>
        // –ö–ª—é—á–∏ –¥–ª—è localStorage
        const STORAGE_KEYS = {
            proxyUrl: 'giga-cors-proxy-url',
            authKey: 'giga-cors-auth-key'
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            const savedProxyUrl = localStorage.getItem(STORAGE_KEYS.proxyUrl);
            const savedAuthKey = localStorage.getItem(STORAGE_KEYS.authKey);

            if (savedProxyUrl) {
                document.getElementById('proxy-url-input').value = savedProxyUrl;
            }
            if (savedAuthKey) {
                document.getElementById('auth-key-input').value = savedAuthKey;
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL –ø—Ä–æ–∫—Å–∏
        document.getElementById('save-proxy-url').addEventListener('click', function() {
            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            if (proxyUrl) {
                localStorage.setItem(STORAGE_KEYS.proxyUrl, proxyUrl);
                log('‚úÖ URL –ø—Ä–æ–∫—Å–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', { url: proxyUrl });
            } else {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º');
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Authorization Key
        document.getElementById('save-auth-key').addEventListener('click', function() {
            const authKey = document.getElementById('auth-key-input').value.trim();
            if (authKey) {
                localStorage.setItem(STORAGE_KEYS.authKey, authKey);
                log('‚úÖ Authorization Key —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            } else {
                log('‚ö†Ô∏è Authorization Key –æ—á–∏—â–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–∑ env –ø—Ä–æ–∫—Å–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)');
                localStorage.removeItem(STORAGE_KEYS.authKey);
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ Authorization Key
        document.getElementById('toggle-auth-key-visibility').addEventListener('click', function() {
            const authKeyInput = document.getElementById('auth-key-input');
            if (authKeyInput.type === 'password') {
                authKeyInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                authKeyInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        document.getElementById('clear-button').addEventListener('click', function() {
            document.getElementById('log-textarea').value = '';
            logs.length = 0;
        });

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        const logs = [];
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const entry = {
                time: timestamp,
                message,
                data
            };
            logs.push(entry);

            const logText = logs.map(l => {
                let line = `[${l.time}] ${l.message}`;
                if (l.data) {
                    line += '\n' + JSON.stringify(l.data, null, 2);
                }
                return line;
            }).join('\n\n');

            document.getElementById('log-textarea').value = logText;
            document.getElementById('log-textarea').scrollTop = document.getElementById('log-textarea').scrollHeight;

            console.log(`[${timestamp}] ${message}`, data || '');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        document.getElementById('send-button').addEventListener('click', async function() {
            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            const authKey = document.getElementById('auth-key-input').value.trim();
            const model = document.getElementById('model-select').value;
            const query = document.getElementById('query-input').value.trim() || '–ü—Ä–∏–≤–µ—Ç!';

            if (!proxyUrl) {
                log('‚ùå –û—à–∏–±–∫–∞: URL –ø—Ä–æ–∫—Å–∏ –Ω–µ —É–∫–∞–∑–∞–Ω', { error: '–í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏' });
                return;
            }

            log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat', {
                proxyUrl,
                hasAuthKey: !!authKey,
                model,
                query
            });

            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–∫—Å–∏
                const requestBody = {
                    model: model,
                    messages: [
                        {
                            role: 'user',
                            content: query
                        }
                    ],
                    temperature: 0.6,
                    max_tokens: 500 // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–æ–≤ GigaChat API (~60 —Å–µ–∫)
                };

                // –ï—Å–ª–∏ Authorization Key —É–∫–∞–∑–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∑–∞–ø—Ä–æ—Å
                // (–∏–Ω–∞—á–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–∑ env –ø—Ä–æ–∫—Å–∏)
                if (authKey) {
                    requestBody.authKey = authKey;
                }

                log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ø—Ä–æ–∫—Å–∏', {
                    url: proxyUrl,
                    method: 'POST',
                    body: {
                        ...requestBody,
                        authKey: authKey ? authKey.substring(0, 10) + '...' : '(–∏–∑ env)'
                    }
                });

                const startTime = Date.now();

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–∫—Å–∏
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const endTime = Date.now();
                const duration = endTime - startTime;

                log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    duration: `${duration}ms`,
                    headers: {
                        'content-type': response.headers.get('content-type'),
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods')
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('access-control-allow-origin'),
                    'Access-Control-Allow-Methods': response.headers.get('access-control-allow-methods'),
                    'Access-Control-Allow-Headers': response.headers.get('access-control-allow-headers')
                };

                const hasCorsHeaders = corsHeaders['Access-Control-Allow-Origin'] !== null;
                if (hasCorsHeaders) {
                    log('‚úÖ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç', corsHeaders);
                } else {
                    log('‚ö†Ô∏è CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ—Ç–≤–µ—Ç–µ', { note: '–≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ CORS –≤ –±—Ä–∞—É–∑–µ—Ä–µ' });
                }

                const responseText = await response.text();

                log('üìÑ –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (raw)', {
                    length: responseText.length,
                    preview: responseText.substring(0, 200)
                });

                if (!response.ok) {
                    log('‚ùå –û—à–∏–±–∫–∞ HTTP', {
                        status: response.status,
                        statusText: response.statusText,
                        body: responseText
                    });
                    return;
                }

                // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON', {
                        error: parseError.message,
                        responseText: responseText.substring(0, 500)
                    });
                    return;
                }

                log('‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω', {
                    hasChoices: !!data.choices,
                    choicesCount: data.choices?.length || 0,
                    hasUsage: !!data.usage
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç API
                if (data.error) {
                    log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç GigaChat API', {
                        error: data.error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
                        code: data.error.code
                    });
                    return;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
                if (data.choices && data.choices.length > 0) {
                    const answer = data.choices[0].message.content;
                    const usage = data.usage;

                    log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç GigaChat', {
                        answer: answer,
                        usage: usage,
                        tokens: {
                            prompt: usage?.prompt_tokens,
                            completion: usage?.completion_tokens,
                            total: usage?.total_tokens
                        }
                    });
                } else {
                    log('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', { data });
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ', {
                    error: error.message,
                    name: error.name,
                    stack: error.stack?.split('\n').slice(0, 5).join('\n')
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º CORS –æ—à–∏–±–∫—É
                if (error.message === 'Failed to fetch' ||
                    (error.name === 'TypeError' && error.message?.includes('fetch'))) {
                    log('‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞—è CORS –æ—à–∏–±–∫–∞', {
                        note: '–ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–æ–∫—Å–∏.',
                        origin: window.location.origin,
                        protocol: window.location.protocol
                    });
                }
            }
        });
    </script>

</body>
</html>
