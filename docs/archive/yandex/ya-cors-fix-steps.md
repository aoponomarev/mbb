# Исправление проблемы CORS в Yandex Cloud Function

## Проблема

Ошибка: "Response to preflight request doesn't pass access control check: It does not have HTTP ok status"

**Причина:** Функция не публичная, поэтому браузер не может выполнить preflight OPTIONS запрос.

## Решение

### Шаг 1: Включить публичный доступ к функции

1. Откройте функцию `yandexgpt-proxy` в Yandex Cloud Console
2. Найдите переключатель **"Публичная функция"** (Public function) на странице обзора
3. **Включите** переключатель (он должен стать зеленым/активным)
4. Сохраните изменения (если требуется подтверждение)

После включения функция будет доступна по URL:
```
https://functions.yandexcloud.net/d4erd8d1pttbufs126s1
```

И будет автоматически поддерживать POST и OPTIONS методы.

### Шаг 2: Проверить код функции

Убедитесь, что код функции правильный (из `ya-cloud-function-code.md`):

**Важные моменты:**
- ✅ Обработка OPTIONS запросов (preflight)
- ✅ Возврат CORS заголовков во всех ответах
- ✅ Правильное определение HTTP метода

**Текущий код уже содержит:**
- Обработку OPTIONS
- CORS заголовки
- Логирование для отладки

### Шаг 3: Обновить код функции (если нужно)

Если в функции еще нет кода с логированием из `ya-cloud-function-code.md`:

1. Откройте **"Редактор"** функции
2. Скопируйте код из `ya-cloud-function-code.md` (весь код, начиная с `exports.handler = ...`)
3. Вставьте в редактор, заменив старый код
4. Нажмите **"Создать версию"** (или "Сохранить")

### Шаг 4: Протестировать

1. Откройте `ya-cors.html` в браузере
2. В поле **"URL прокси Cloud Function"** введите:
   ```
   https://functions.yandexcloud.net/d4erd8d1pttbufs126s1
   ```
3. Поле **"API ключ"** можно оставить пустым (если он в переменных окружения)
4. Введите Folder ID: `b1gv03a122le5a934cqj`
5. Выберите модель
6. Введите тестовый запрос
7. Нажмите **"Отправить запрос"**

### Шаг 5: Проверить логи (если проблема сохраняется)

1. Откройте раздел **"Логи"** (Logs) функции
2. Проверьте, появляются ли записи при отправке запроса
3. Посмотрите формат `event` в логах

## Ожидаемый результат

После включения публичного доступа:
- ✅ Preflight OPTIONS запрос проходит успешно
- ✅ POST запросы обрабатываются корректно
- ✅ CORS заголовки присутствуют в ответах
- ✅ Запросы из браузера работают без ошибок

## Если проблема сохраняется

Если после включения публичного доступа проблема сохраняется:

1. **Проверьте логи функции** - должны быть записи о вызове
2. **Проверьте формат event** - посмотрите логи, какой формат приходит
3. **Проверьте код функции** - убедитесь, что обработка OPTIONS присутствует
4. Сообщите о результатах для дальнейшей отладки

## ССЫЛКИ

- Код функции: `ya-cloud-function-code.md`
- Руководство по отладке: `ya-cors-debug-guide.md`
- Тестовая страница: `ya-cors.html`
