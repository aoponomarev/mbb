# План миграции: YandexGPT как дефолтный провайдер

> Оглавление `ya-migration-default-plan.md`
- § Обзор миграции — цель, задачи, текущее состояние
- § Этап 1: Обновление настроек AI API — добавление полей для YandexGPT
- § Этап 2: Проверка и обновление дефолтного провайдера — установка YandexGPT как дефолтного
- § Этап 3: Миграция перевода tooltips — переход с Perplexity на YandexGPT
- § Этап 4: Миграция новостей в футере — переход с Perplexity на YandexGPT
- § Этап 5: Тестирование и проверка — финальное тестирование функциональности
- § Чеклист миграции — список проверок

> § <br> ОБЗОР МИГРАЦИИ

## Цель миграции

Перевести приложение на использование YandexGPT как основного (дефолтного) AI провайдера вместо Perplexity для:
- Перевода всплывающих подсказок (tooltips)
- Перевода новостей крипты в футере

## Задачи

1. **Обновить настройки AI API:**
   - Добавить поле Folder ID для YandexGPT в модальное окно настроек
   - Убедиться, что все необходимые поля присутствуют (API ключ, модель, Folder ID)
   - Сделать YandexGPT дефолтным провайдером в настройках

2. **Проверить дефолтный провайдер:**
   - Убедиться, что `ai-provider-manager.js` использует 'yandex' как дефолтный
   - Проверить, что `app-config.js` содержит дефолтные значения для YandexGPT

3. **Мигрировать функциональность:**
   - Перевод tooltips: убедиться, что `tooltips-translator.js` использует `aiProviderManager`
   - Новости в футере: убедиться, что `app-footer.js` использует `aiProviderManager`

## Текущее состояние

### Что уже работает:

✅ **Архитектура провайдеров:**
- `ai-provider-manager.js` — менеджер провайдеров существует и работает
- Дефолтный провайдер уже установлен как 'yandex'
- Провайдеры YandexGPT и Perplexity зарегистрированы

✅ **Интеграция Yandex Cloud Functions:**
- `yandex-provider.js` поддерживает прокси через Cloud Functions
- `app-config.js` содержит `proxyUrl` для YandexGPT

✅ **Использование aiProviderManager:**
- `tooltips-translator.js` использует `aiProviderManager` для перевода tooltips
- `app-footer.js` использует `aiProviderManager` для получения новостей

### Что сделано:

✅ **Настройки AI API:**
- Добавлено поле Folder ID для YandexGPT в шаблон настроек
- Добавлена поддержка Folder ID в компонент настроек
- Folder ID сохраняется в кэш
- Исправлено чтение старых значений API ключа (оборачивание в формат cacheManager)
- Исправлена кнопка "Сохранено, закрыть?"

✅ **Проверка дефолтного провайдера:**
- Дефолтный провайдер установлен как 'yandex' во всех местах
- Настройки по умолчанию корректны

✅ **Реактивность:**
- Добавлен watch на currentTranslationLanguage для автоматического обновления tooltips
- Tooltips обновляются сразу при смене языка

✅ **Тестирование:**
- Протестирован перевод tooltips через YandexGPT (работает, реактивность улучшена)
- Протестировано получение новостей через YandexGPT (новости отображаются, переводы работают)
- Удалена вся отладочная инструментация

### Что осталось (опционально):

❓ **Дополнительное тестирование:**
- Протестировать переключение между провайдерами (YandexGPT ↔ Perplexity)
- Убедиться, что кэш переводов корректно перезапрашивается при смене провайдера

> § <br> ЭТАП 1: ОБНОВЛЕНИЕ НАСТРОЕК AI API

## Шаг 1.1: Обновить шаблон настроек

**Файл:** `app/templates/ai-api-settings-template.js`

**Задача:** Добавить поле Folder ID для YandexGPT

**Действия:**
1. В разделе "Настройки YandexGPT" (после поля "API ключ", перед полем "Модель") добавить:
   ```html
   <div class="mb-3">
       <label for="yandex-folder-id" class="form-label">Folder ID</label>
       <input
           class="form-control"
           id="yandex-folder-id"
           v-model="yandexFolderId"
           type="text"
           placeholder="b1gv03a122le5a934cqj">
       <small class="form-text text-muted">ID папки в Yandex Cloud</small>
   </div>
   ```

**Ожидаемый результат:**
- В шаблоне настроек YandexGPT появилось поле Folder ID

## Шаг 1.2: Обновить компонент настроек

**Файл:** `app/components/ai-api-settings.js`

**Задача:** Добавить поддержку Folder ID в компонент

**Действия:**
1. В `data()` добавить:
   ```javascript
   yandexFolderId: '',
   initialYandexFolderId: '',
   ```

2. В `computed.hasChanges` добавить проверку:
   ```javascript
   this.yandexFolderId !== this.initialYandexFolderId ||
   ```

3. В `loadSettings()` добавить загрузку Folder ID:
   ```javascript
   const savedYandexFolderId = await window.cacheManager.get('yandex-folder-id');
   if (savedYandexFolderId) {
       this.yandexFolderId = savedYandexFolderId;
       this.initialYandexFolderId = savedYandexFolderId;
   } else {
       // Дефолтное значение из конфига
       const defaultFolderId = window.appConfig?.get('defaults.yandex.folderId', 'b1gv03a122le5a934cqj');
       this.yandexFolderId = defaultFolderId;
       this.initialYandexFolderId = defaultFolderId;
   }
   ```

4. В `saveSettings()` добавить сохранение Folder ID:
   ```javascript
   await window.cacheManager.set('yandex-folder-id', this.yandexFolderId);
   ```

5. В `handleCancel()` добавить восстановление:
   ```javascript
   this.yandexFolderId = this.initialYandexFolderId;
   ```

6. В `watch` добавить отслеживание изменений:
   ```javascript
   yandexFolderId() {
       this.$nextTick(() => {
           this.onFieldChange();
       });
   },
   ```

**Ожидаемый результат:**
- Компонент поддерживает поле Folder ID
- Folder ID сохраняется и загружается из кэша
- Изменения Folder ID отслеживаются для кнопки "Сохранить"

## Шаг 1.3: Добавить Folder ID в кэш-конфигурацию

**Файл:** `core/cache/cache-config.js`

**Задача:** Добавить ключ 'yandex-folder-id' в конфигурацию кэша

**Действия:**
1. Проверить, есть ли ключ 'yandex-folder-id' в TTL
2. Если нет — добавить в TTL с стратегией 'cache-only' (как для других настроек)

**Ожидаемый результат:**
- Ключ 'yandex-folder-id' добавлен в конфигурацию кэша

## Шаг 1.4: Обновить провайдер для использования Folder ID из кэша

**Файл:** `core/api/ai-provider-manager.js`

**Задача:** Обеспечить получение Folder ID для Yandex провайдера

**Действия:**
1. Добавить метод `getFolderId(providerName)` для получения Folder ID из кэша
2. Обновить `sendRequest()` для передачи Folder ID провайдеру (если необходимо)

**Примечание:** YandexProvider уже может извлекать folderId из modelUri, но лучше хранить отдельно для гибкости.

**Ожидаемый результат:**
- Провайдер может получить Folder ID из кэша

## Шаг 1.5: Тестирование настроек

**Задача:** Протестировать работу настроек

**Действия:**
1. Открыть приложение
2. Открыть настройки AI API (шестеренка → AI API)
3. Проверить:
   - [ ] YandexGPT выбран по умолчанию (первый в radio buttons)
   - [ ] Поле Folder ID присутствует и заполнено дефолтным значением
   - [ ] Поле API ключ присутствует
   - [ ] Поле Модель присутствует с выбором моделей
   - [ ] После сохранения настройки сохраняются в кэш
   - [ ] После перезагрузки настройки загружаются из кэша

**Ожидаемый результат:**
- Все поля YandexGPT работают корректно
- Настройки сохраняются и загружаются

> § <br> ЭТАП 2: ПРОВЕРКА И ОБНОВЛЕНИЕ ДЕФОЛТНОГО ПРОВАЙДЕРА

## Шаг 2.1: Проверить дефолтный провайдер в менеджере

**Файл:** `core/api/ai-provider-manager.js`

**Задача:** Убедиться, что дефолтный провайдер установлен как 'yandex'

**Действия:**
1. Проверить строку 43: `this.defaultProvider = 'yandex';`
2. Убедиться, что значение 'yandex'

**Ожидаемый результат:**
- Дефолтный провайдер = 'yandex'

## Шаг 2.2: Проверить дефолтный провайдер в конфигурации

**Файл:** `core/config/app-config.js`

**Задача:** Убедиться, что дефолтный провайдер в конфиге = 'yandex'

**Действия:**
1. Проверить значение `defaults.aiProvider`
2. Убедиться, что значение = 'yandex'

**Ожидаемый результат:**
- Дефолтный провайдер в конфиге = 'yandex'

## Шаг 2.3: Проверить компонент настроек

**Файл:** `app/components/ai-api-settings.js`

**Задача:** Убедиться, что дефолтный провайдер = 'yandex'

**Действия:**
1. Проверить строку 66: `const defaultProvider = window.appConfig?.get('defaults.aiProvider', 'yandex');`
2. Убедиться, что дефолт = 'yandex'

**Ожидаемый результат:**
- При открытии настроек YandexGPT выбран по умолчанию

> § <br> ЭТАП 3: МИГРАЦИЯ ПЕРЕВОДА TOOLTIPS

## Шаг 3.1: Проверить использование aiProviderManager

**Файл:** `core/api/tooltips-translator.js`

**Задача:** Убедиться, что переводчик использует `aiProviderManager`

**Действия:**
1. Проверить строку 128: `const providerName = await window.aiProviderManager.getCurrentProviderName();`
2. Убедиться, что используется `aiProviderManager.sendRequest()` (строка ~157)

**Ожидаемый результат:**
- Переводчик уже использует `aiProviderManager`
- При дефолтном провайдере 'yandex' будет использоваться YandexGPT

## Шаг 3.2: Проверить кэширование переводов

**Файл:** `core/api/tooltips-translator.js`

**Задача:** Убедиться, что кэширование учитывает провайдера

**Действия:**
1. Проверить ключ кэша (строка ~170): `tooltips-{provider}-{versionHash}-{language}`
2. Убедиться, что провайдер включен в ключ

**Ожидаемый результат:**
- Переводы кэшируются отдельно для каждого провайдера
- При смене провайдера переводы будут перезапрошены

## Шаг 3.3: Тестирование перевода tooltips

**Задача:** Протестировать перевод tooltips через YandexGPT

**Действия:**
1. Открыть приложение
2. Убедиться, что API ключ YandexGPT настроен
3. Изменить язык перевода (например, на английский)
4. Проверить:
   - [ ] Tooltips переводятся на новый язык
   - [ ] Переводы кэшируются
   - [ ] После перезагрузки переводы загружаются из кэша
   - [ ] В консоли нет ошибок

**Ожидаемый результат:**
- Tooltips переводятся через YandexGPT
- Переводы работают корректно

> § <br> ЭТАП 4: МИГРАЦИЯ НОВОСТЕЙ В ФУТЕРЕ

## Шаг 4.1: Проверить использование aiProviderManager

**Файл:** `app/components/app-footer.js`

**Задача:** Убедиться, что футер использует `aiProviderManager`

**Действия:**
1. Найти метод `fetchSingleCryptoNews()`
2. Проверить, что используется `window.aiProviderManager.sendRequest()`

**Ожидаемый результат:**
- Футер уже использует `aiProviderManager`
- При дефолтном провайдере 'yandex' будет использоваться YandexGPT

## Шаг 4.2: Проверить промпт для новостей

**Файл:** `app/components/app-footer.js`

**Задача:** Убедиться, что промпт корректно работает с YandexGPT

**Действия:**
1. Найти метод формирования промпта для новостей
2. Проверить формат промпта (должен работать с YandexGPT)
3. При необходимости адаптировать промпт под YandexGPT

**Ожидаемый результат:**
- Промпт корректно работает с YandexGPT

## Шаг 4.3: Тестирование новостей

**Задача:** Протестировать получение новостей через YandexGPT

**Действия:**
1. Открыть приложение
2. Убедиться, что API ключ YandexGPT настроен
3. Подождать загрузки новостей в футере
4. Проверить:
   - [ ] Новости загружаются
   - [ ] Переводы новостей работают
   - [ ] Переключение между новостями работает
   - [ ] В консоли нет ошибок

**Ожидаемый результат:**
- Новости получаются через YandexGPT
- Функциональность работает корректно

> § <br> ЭТАП 5: ТЕСТИРОВАНИЕ И ПРОВЕРКА

## Шаг 5.1: Комплексное тестирование

**Задача:** Протестировать всю функциональность

**Действия:**
1. **Настройки:**
   - [ ] Открыть настройки AI API
   - [ ] Проверить, что YandexGPT выбран по умолчанию
   - [ ] Проверить наличие всех полей (API ключ, Folder ID, модель)
   - [ ] Сохранить настройки
   - [ ] Перезагрузить страницу
   - [ ] Проверить, что настройки загрузились

2. **Перевод tooltips:**
   - [ ] Изменить язык на английский
   - [ ] Проверить, что tooltips переведены
   - [ ] Перезагрузить страницу
   - [ ] Проверить, что переводы загрузились из кэша

3. **Новости в футере:**
   - [ ] Проверить, что новости загружаются
   - [ ] Проверить переводы новостей
   - [ ] Проверить переключение между новостями

4. **Переключение провайдеров:**
   - [ ] Переключиться на Perplexity
   - [ ] Проверить, что переводы перезапросились
   - [ ] Переключиться обратно на YandexGPT
   - [ ] Проверить, что переводы перезапросились

**Ожидаемый результат:**
- Вся функциональность работает корректно
- YandexGPT используется как дефолтный провайдер

## Шаг 5.2: Проверка логов

**Задача:** Проверить, что нет ошибок в консоли

**Действия:**
1. Открыть DevTools → Console
2. Выполнить все действия из шага 5.1
3. Проверить наличие ошибок

**Ожидаемый результат:**
- Нет ошибок в консоли
- Все запросы проходят успешно

> § <br> ЧЕКЛИСТ МИГРАЦИИ

## Подготовка

- [ ] Прочитать план миграции полностью
- [ ] Убедиться, что API ключ YandexGPT настроен в Yandex Cloud Function
- [ ] Убедиться, что Cloud Function работает (протестировано через ya-cors.html)

## Этап 1: Настройки AI API

- [x] Обновлен шаблон настроек (добавлено поле Folder ID)
- [x] Обновлен компонент настроек (поддержка Folder ID)
- [x] Добавлен ключ 'yandex-folder-id' в cache-config
- [x] Протестированы настройки

## Этап 2: Дефолтный провайдер

- [x] Проверен дефолтный провайдер в ai-provider-manager.js (= 'yandex')
- [x] Проверен дефолтный провайдер в app-config.js (= 'yandex')
- [x] Проверен дефолтный провайдер в компоненте настроек (= 'yandex')

## Этап 3: Перевод tooltips

- [x] Проверено использование aiProviderManager в tooltips-translator.js
- [x] Проверено кэширование с учетом провайдера
- [x] Протестирован перевод tooltips через YandexGPT (реактивность улучшена, работает корректно)

## Этап 4: Новости в футере

- [x] Проверено использование aiProviderManager в app-footer.js
- [x] Проверен промпт для новостей
- [x] Протестированы новости через YandexGPT (новости отображаются, переводы работают)

## Этап 5: Финальное тестирование

- [x] Проведено комплексное тестирование всех функций
- [x] Проверены логи (нет критических ошибок, CORS ошибки для VIX - внешние проблемы)
- [ ] Проверено переключение между провайдерами (требуется дополнительное тестирование)

## ССЫЛКИ

- План интеграции: `ya-integration-mbb-plan.md`
- Документация интеграции: `ya-integration-mbb.md`
- Код провайдера: `core/api/ai-providers/yandex-provider.js`
- Менеджер провайдеров: `core/api/ai-provider-manager.js`
