# Решение проблемы с правами доступа при создании Cloud Function

## Проблема

При попытке создания Cloud Function через ИИ-ассистента Yandex Cloud возникает ошибка:
```
PermissionDenied: отсутствуют права доступа у сервисного аккаунта на папку
```

## Причина

Сервисному аккаунту не назначена роль `editor` **на папку** (folder), где должна быть создана функция.

**Важно**: Есть разница между:
- ❌ Ролью **на сервисном аккаунте** (управление самим аккаунтом)
- ✅ Ролью **на папке** (создание ресурсов внутри папки)

Нам нужен второй вариант — роль на папке.

## Решение

### Шаг 1: Определить ID сервисного аккаунта

Найдите ID сервисного аккаунта, от имени которого создается функция. Пример: `ajeudqscq65r5d5u7ras`

### Шаг 2: Проверить текущие права доступа на папке

**Важно**: Проверяем права **на папке**, а не на сервисном аккаунте!

Через CLI:
```bash
yc resource-manager folder list-access-bindings b1gv03a122le5a934cqj
```

В выводе должна быть строка с ролью `editor` для вашего сервисного аккаунта:
```json
{
  "roleId": "editor",
  "subject": {
    "id": "ajeudqscq65r5d5u7ras",
    "type": "serviceAccount"
  }
}
```

Если такой строки нет — роль не назначена **на папку**.

**Как отличить правильную страницу в веб-интерфейсе:**
- ❌ Неправильно: `.../iam/service-account/ajeudqscq65r5d5u7ras/resource-acl` — это права **на сервисном аккаунте**
- ✅ Правильно: `.../folders/b1gv03a122le5a934cqj` → раздел **"Права доступа"** — это права **на папке**

### Шаг 3: Назначить роль на папку через CLI

**Команда назначает роль НА ПАПКУ, а не на сервисный аккаунт:**

```bash
yc resource-manager folder add-access-binding b1gv03a122le5a934cqj \
  --role editor \
  --subject serviceAccount:ajeudqscq65r5d5u7ras
```

**Важно**:
- Замените `ajeudqscq65r5d5u7ras` на реальный ID вашего сервисного аккаунта
- Команда `folder add-access-binding` назначает роль **на папку**, сервисный аккаунт указывается как **субъект**, которому выдается эта роль

### Шаг 4: Проверить применение прав

Снова выполните команду проверки:
```bash
yc resource-manager folder list-access-bindings b1gv03a122le5a934cqj
```

Убедитесь, что роль назначена корректно.

## Альтернативный способ: через веб-интерфейс

Если CLI недоступен:

1. Откройте Yandex Cloud Console
2. **Перейдите в каталог (folder)**: `https://console.yandex.cloud/folders/b1gv03a122le5a934cqj`
   - ⚠️ Важно: это страница ПАПКИ, а не сервисного аккаунта!
3. В левой панели выберите **"Права доступа"** (Access bindings)
   - Или перейдите по прямой ссылке: `https://console.yandex.cloud/folders/b1gv03a122le5a934cqj/access`
4. На странице "Права доступа" **переключитесь на вкладку "Каталог"** (Catalog)
   - ⚠️ **КРИТИЧЕСКИ ВАЖНО**: Должна быть выбрана вкладка **"Каталог"**, а не **"Облако"**!
   - Вкладка "Облако" назначает роли на облако, а нам нужна роль на папку
5. Нажмите кнопку **"+ Настроить доступ"** (Configure Access) в верхней части страницы
   - Эта кнопка находится под заголовком "Права доступа", рядом с вкладками
   - Откроется модальное окно для назначения ролей
6. **Проверьте контекст в модальном окне:**
   - В верхней части модального окна должно быть указано название **папки** (например, "default" с ID `b1gv03a122le5a934cqj`)
   - ❌ Если указано "cloud-aoponomarev" или название облака — вы на вкладке "Облако", нужно закрыть окно и переключиться на "Каталог"
7. В модальном окне в поле **"Выберите пользователя"** или **"Пользователь"**:
   - Начните вводить `mbb` или `ajeudqscq65r5d5u7ras`
   - Выберите **"Сервисный аккаунт mbb"** (должен быть тип `serviceAccount`, ID: `ajeudqscq65r5d5u7ras`)
8. Проверьте список ролей:
   - Если роль `editor` уже есть в списке — нажмите **"Сохранить"**
   - Если роли `editor` нет — нажмите **"Добавить роль"**, введите `editor` или выберите **Editor** из списка
9. Нажмите **"Сохранить"** в модальном окне

**Проверка правильности:**
- URL должен быть вида: `.../folders/b1gv03a122le5a934cqj/access` → раздел "Права доступа"
- Должна быть выбрана вкладка **"Каталог"**, а не **"Облако"**
- В модальном окне в контексте должно быть указано название **папки** (например, "default"), а не облака
- НЕ должно быть URL вида: `.../iam/service-account/.../resource-acl` (это права на самом аккаунте)

## Важные моменты

### ✅ Правильная настройка

- Роль назначена **на папку** (`b1gv03a122le5a934cqj`), а не на облако, организацию или сервисный аккаунт
- Субъект — **сервисный аккаунт** (`serviceAccount`), а не пользователь
- Роль — `editor` (или `admin`, `resource-manager.editor`), а не `ai.languageModels.user`
- Страница в веб-интерфейсе: папка → "Права доступа" (НЕ сервисный аккаунт → "Права доступа")

### ❌ Частые ошибки

1. **Роль назначена на сервисный аккаунт, а не на папку** — это дает права управлять самим аккаунтом, но не создавать ресурсы в папке
   - Неправильный URL: `.../iam/service-account/.../resource-acl`
   - Правильный URL: `.../folders/b1gv03a122le5a934cqj/access` → "Права доступа" → вкладка "Каталог"
2. **Роль назначена на облако, а не на папку** — это дает права на уровне облака, но не на уровне папки
   - Неправильно: вкладка "Облако" выбрана в разделе "Права доступа"
   - Правильно: вкладка **"Каталог"** должна быть выбрана
   - В модальном окне контекст должен быть папка (например, "default"), а не облако
2. **Роль назначена на облако, а не на папку** — функция не сможет быть создана
3. **Роль назначена пользователю, а не сервисному аккаунту** — функция не сможет быть создана
4. **Назначена роль `ai.languageModels.user` вместо `editor`** — недостаточно прав для создания функции

## После исправления

Если роль `editor` уже назначена на папке (вкладка "Каталог") для сервисного аккаунта `mbb`:

1. **Убедитесь, что изменения сохранены:**
   - Если модальное окно открыто — нажмите **"Сохранить"**
   - Подождите несколько секунд для применения изменений

2. **Проверьте права через CLI** (рекомендуется):
   ```bash
   yc resource-manager folder list-access-bindings b1gv03a122le5a934cqj
   ```
   В выводе должна быть строка с ролью `editor` для сервисного аккаунта `ajeudqscq65r5d5u7ras`

3. **Если права назначены правильно, но ошибка остается:**
   - Подождите 1-2 минуты (возможна задержка применения прав)
   - Обновите страницу в консоли Yandex Cloud
   - Попробуйте выйти и войти в консоль заново
   - Убедитесь, что используете правильный сервисный аккаунт (`mbb`, ID: `ajeudqscq65r5d5u7ras`)

4. **Сообщите ИИ-ассистенту Yandex Cloud:**
   - Роль `editor` назначена сервисному аккаунту `mbb` на папке `b1gv03a122le5a934cqj`
   - Попросите создать функцию заново
   - Если ошибка повторяется — попросите проверить, какой именно сервисный аккаунт используется для создания функции

## ССЫЛКИ

- Документация Yandex Cloud IAM: https://yandex.cloud/ru/docs/iam/
- План интеграции: `ya-integration-mbb-plan.md`
- Задание для ИИ-ассистента: `ya-cloud-function-task.md`
