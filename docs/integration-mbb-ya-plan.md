# План интеграции MBB с Yandex Cloud

> Оглавление `docs/integration-mbb-ya-plan.md`
- § Подготовка — подготовительные шаги, включая настройку прав доступа
- § Создание Cloud Function — создание прокси-функции в Yandex Cloud
- § Настройка проекта — обновление конфигурации проекта
- § Тестирование — проверка работы интеграции
- § Чеклист — проверочный список задач

> § <br> ПОДГОТОВКА

## Шаг 1: Подготовка аккаунта Yandex Cloud

- [ ] Зарегистрироваться/войти в аккаунт Yandex Cloud
- [ ] Создать платежный аккаунт (если требуется)
- [ ] Создать каталог (folder) для проекта, если еще не создан
- [ ] Записать Folder ID (текущий: `b1gv03a122le5a934cqj`)

## Шаг 1.5: Настройка прав доступа для сервисного аккаунта

**Важно**: Перед созданием Cloud Function необходимо назначить права доступа сервисному аккаунту.

- [ ] Определить ID сервисного аккаунта (например: `ajeudqscq65r5d5u7ras`)
- [ ] Назначить роль `editor` сервисному аккаунту на папку (folder)

### Способ 1: Через CLI (Yandex Cloud CLI)

1. Проверить текущие права доступа:
```bash
yc resource-manager folder list-access-bindings b1gv03a122le5a934cqj
```

2. Назначить роль `editor` сервисному аккаунту:
```bash
yc resource-manager folder add-access-binding b1gv03a122le5a934cqj \
  --role editor \
  --subject serviceAccount:ajeudqscq65r5d5u7ras
```
(Заменить `ajeudqscq65r5d5u7ras` на реальный ID сервисного аккаунта)

3. Проверить, что роль назначена:
```bash
yc resource-manager folder list-access-bindings b1gv03a122le5a934cqj
```

Должна появиться строка:
```json
{
  "roleId": "editor",
  "subject": {
    "id": "ajeudqscq65r5d5u7ras",
    "type": "serviceAccount"
  }
}
```

### Способ 2: Через веб-интерфейс

**⚠️ ВАЖНО**: Роль должна быть назначена **НА ПАПКУ**, а не на сервисный аккаунт!

1. Перейти в Yandex Cloud Console
2. Открыть каталог (folder): `https://console.yandex.cloud/folders/b1gv03a122le5a934cqj`
   - Это страница **ПАПКИ**, а не сервисного аккаунта!
   - Или перейти напрямую: `https://console.yandex.cloud/folders/b1gv03a122le5a934cqj/access`
3. В левой панели выбрать раздел **"Права доступа"** (или **"Access bindings"**)
4. **⚠️ КРИТИЧЕСКИ ВАЖНО: Переключиться на вкладку "Каталог"** (Catalog)
   - На странице "Права доступа" есть две вкладки: **"Каталог"** и **"Облако"**
   - Должна быть выбрана вкладка **"Каталог"**, а не **"Облако"**!
   - Вкладка "Облако" назначает роли на облако, а нам нужна роль на папку
5. На странице "Права доступа" найти и нажать кнопку **"+ Настроить доступ"** (Configure Access)
   - Кнопка находится в верхней части страницы, под заголовком "Права доступа"
   - Рядом с вкладками "Каталог" / "Облако"
   - После нажатия откроется модальное окно
6. **Проверить контекст в модальном окне:**
   - В верхней части модального окна должно быть указано название **папки** (например, "default" с ID `b1gv03a122le5a934cqj`)
   - ❌ Если указано "cloud-aoponomarev" или название облака — вы на вкладке "Облако", нужно закрыть окно и переключиться на "Каталог"
7. В модальном окне в поле **"Выберите пользователя"** или **"Пользователь"**:
   - Начать вводить `mbb` или `ajeudqscq65r5d5u7ras`
   - Выбрать **"Сервисный аккаунт mbb"** (тип: `serviceAccount`, ID: `ajeudqscq65r5d5u7ras`)
8. Проверить список ролей:
   - Если роль `editor` уже есть в списке — нажать **"Сохранить"**
   - Если роли `editor` нет — нажать **"Добавить роль"**, ввести `editor` или выбрать **Editor** из списка
9. Нажать **"Сохранить"** в модальном окне

**Проверка правильности:**
- URL должен быть: `.../folders/b1gv03a122le5a934cqj` → "Права доступа"
- НЕ должно быть: `.../iam/service-account/.../resource-acl` (это права на самом аккаунте, а не на папке)

**Важные моменты:**
- Роль должна быть назначена **на папку** (`b1gv03a122le5a934cqj`), а не на облако, организацию или сервисный аккаунт
- Субъект должен быть **сервисным аккаунтом** (`serviceAccount`), а не пользователем
- Роль должна быть `editor` (или `admin`, `resource-manager.editor`), а не `ai.languageModels.user`

**Частая ошибка:**
- ❌ Назначение роли **на сервисном аккаунте** (`.../iam/service-account/.../resource-acl`) — это дает права управлять самим аккаунтом, но не создавать ресурсы в папке
- ✅ Назначение роли **на папке** (`.../folders/b1gv03a122le5a934cqj` → "Права доступа") — это дает права создавать ресурсы внутри папки

**Ошибка при отсутствии прав:**
Если права не назначены, при попытке создания функции возникнет ошибка `PermissionDenied`.

## Шаг 2: Подготовка API-ключа

- [ ] Создать API-ключ в Yandex Cloud Console
  - Перейти: IAM → Service Accounts → [выбрать сервисный аккаунт] → API Keys
  - Создать новый API-ключ
  - Сохранить ключ в безопасное место (понадобится для переменных окружения)

## Шаг 3: Подготовка инструментов для тестирования

- [ ] Открыть `ya-cors.html` в браузере для тестирования CORS
- [ ] Изучить документацию Cloud Functions: https://yandex.cloud/ru/docs/functions/

> § <br> СОЗДАНИЕ CLOUD FUNCTION

## Шаг 1: Создание функции через консоль

- [ ] Перейти в раздел Cloud Functions в Yandex Cloud Console
- [ ] Нажать "Создать функцию"
- [ ] Заполнить параметры:
  - Имя: `mbb-yandex-proxy` (или другое)
  - Описание: "Прокси для YandexGPT API с поддержкой CORS"
  - Среда выполнения: Node.js 18 (или новее)
- [ ] Выбрать способ создания: "Редактор кода"
- [ ] Нажать "Создать"

## Шаг 2: Написание кода функции

- [ ] Создать файл `index.js` с кодом прокси
- [ ] Добавить обработку CORS (preflight OPTIONS запросы)
- [ ] Добавить обработку POST запросов
- [ ] Реализовать перенаправление запросов к YandexGPT API
- [ ] Добавить обработку ошибок
- [ ] Добавить логирование (опционально)

**⚠️ ВАЖНО**: Используйте исправленный код из `docs/ya-cloud-function-code.md`!
- В Node.js 18+ `fetch` доступен глобально, не требуется `require('node-fetch')`
- Код, предоставленный ИИ-ассистентом, может содержать эту строку - удалите её, если она есть

**Формат запроса к прокси:**
```javascript
POST https://functions.yandexcloud.net/your-function-id
Headers:
  Content-Type: application/json

Body:
{
  "apiKey": "AQVN...",  // Опционально, если хранится в env
  "modelUri": "gpt://b1gv03a122le5a934cqj/yandexgpt-lite/latest",
  "messages": [
    {
      "role": "user",
      "text": "Привет"
    }
  ],
  "completionOptions": {
    "temperature": 0.6,
    "maxTokens": 2000
  }
}
```

**Формат ответа от прокси:**
```javascript
Headers:
  Access-Control-Allow-Origin: *
  Access-Control-Allow-Methods: POST, OPTIONS
  Access-Control-Allow-Headers: Content-Type
  Content-Type: application/json

Body:
{
  "result": {
    "alternatives": [
      {
        "message": {
          "role": "assistant",
          "text": "Привет! Как дела?"
        },
        "status": "ALTERNATIVE_STATUS_FINAL"
      }
    ],
    "usage": {
      "inputTextTokens": "10",
      "completionTokens": "12",
      "totalTokens": "22"
    }
  }
}
```

## Шаг 3: Настройка переменных окружения

- [ ] Перейти в настройки функции → "Переменные окружения"
- [ ] Добавить переменную:
  - Ключ: `YANDEX_API_KEY`
  - Значение: API-ключ Yandex Cloud (созданный в подготовке)
  - Тип: "Секрет" (если доступно) или "Переменная"
- [ ] Сохранить изменения

**Важно**: Если API-ключ хранится в переменных окружения, его не нужно передавать в теле запроса от клиента.

## Шаг 4: Настройка HTTP-триггера

- [ ] Перейти в раздел "Триггеры"
- [ ] Создать HTTP-триггер:
  - Тип: HTTP
  - Метод: POST, OPTIONS (для CORS preflight)
  - URL: сохранить для использования в конфигурации
- [ ] Записать URL функции (формат: `https://functions.yandexcloud.net/...`)

## Шаг 5: Деплой функции

- [ ] Сохранить код функции
- [ ] Нажать "Создать версию" или "Опубликовать"
- [ ] Дождаться успешного деплоя
- [ ] Проверить статус функции (должен быть "Активна")

> § <br> НАСТРОЙКА ПРОЕКТА

## Шаг 1: Обновление конфигурации

- [ ] Открыть файл `core/config/app-config.js`
- [ ] Найти секцию `defaults.yandex.proxyUrl`
- [ ] Заменить значение на URL Cloud Function:
```javascript
yandex: {
    folderId: 'b1gv03a122le5a934cqj',
    model: 'gpt://b1gv03a122le5a934cqj/yandexgpt-lite/latest',
    models: [...],
    proxyUrl: 'https://functions.yandexcloud.net/your-function-id' // ← новый URL
}
```

## Шаг 2: Проверка провайдера

- [ ] Проверить, что `core/api/ai-providers/yandex-provider.js` корректно работает с новым прокси
- [ ] Убедиться, что формат запроса соответствует ожидаемому прокси
- [ ] Убедиться, что обработка ответа корректна

**Текущий формат запроса провайдера к прокси:**
- Провайдер формирует `proxyRequestBody` с полями: `apiKey`, `modelUri`, `messages`, `completionOptions`
- Если API-ключ хранится в env функции, можно убрать передачу `apiKey` из клиента

> § <br> ТЕСТИРОВАНИЕ

## Шаг 1: Тестирование через ya-cors.html

- [ ] Открыть `ya-cors.html` в браузере (file:// протокол)
- [ ] Ввести URL прокси Cloud Function
- [ ] (Опционально) Ввести API-ключ, если не хранится в env функции
- [ ] Ввести Folder ID и выбрать модель
- [ ] Ввести тестовый запрос
- [ ] Нажать "Отправить запрос"
- [ ] Проверить в логах:
  - [ ] Запрос отправлен успешно
  - [ ] CORS заголовки присутствуют в ответе
  - [ ] Ответ от API корректный
  - [ ] Нет ошибок CORS в консоли браузера

## Шаг 2: Локальное тестирование в приложении

- [ ] Открыть приложение локально (file://)
- [ ] Открыть DevTools → Network
- [ ] Выполнить запрос к YandexGPT через интерфейс приложения
- [ ] Проверить:
  - [ ] Запрос идет на URL Cloud Function
  - [ ] CORS заголовки присутствуют в ответе
  - [ ] Ответ от API корректный
  - [ ] Нет ошибок в консоли

## Шаг 3: Тестирование на GitHub Pages

- [ ] Закоммитить изменения с обновленным `proxyUrl`
- [ ] Запушить в репозиторий
- [ ] Дождаться деплоя на GitHub Pages
- [ ] Проверить работу на https://your-username.github.io/repo-name/
- [ ] Убедиться, что CORS работает корректно

## Шаг 4: Тестирование обработки ошибок

- [ ] Проверить обработку неправильного API-ключа
- [ ] Проверить обработку недоступности API
- [ ] Проверить обработку таймаутов
- [ ] Проверить обработку некорректного формата запроса
- [ ] Проверить логирование ошибок в Cloud Functions

> § <br> ЧЕКЛИСТ

## Подготовка

- [ ] Аккаунт Yandex Cloud создан и настроен
- [ ] API-ключ создан и сохранен
- [ ] Инструменты для тестирования подготовлены

## Создание Cloud Function

- [ ] Функция создана в Yandex Cloud
- [ ] Код прокси написан и задеплоен
- [ ] Переменные окружения настроены (API-ключ)
- [ ] HTTP-триггер создан и URL записан

## Настройка проекта

- [ ] Конфигурация обновлена (`app-config.js` с новым `proxyUrl`)
- [ ] Провайдер проверен на совместимость

## Тестирование

- [ ] Тестирование через `ya-cors.html` пройдено успешно
- [ ] Локальное тестирование в приложении пройдено
- [ ] Тестирование на GitHub Pages пройдено
- [ ] Обработка ошибок проверена

## Документация

- [ ] Документация обновлена (`integration-mbb-ya.md`)
- [ ] План миграции выполнен
- [ ] Результаты тестирования задокументированы

## ССЫЛКИ

- Документация интеграции: `docs/integration-mbb-ya.md`
- Исправленный код функции: `docs/ya-cloud-function-code.md` ⚠️ **Используйте этот код!**
- Тестовая страница CORS: `ya-cors.html`
- Документация Cloud Functions: https://yandex.cloud/ru/docs/functions/
- Провайдер YandexGPT: `core/api/ai-providers/yandex-provider.js`
- Конфигурация: `core/config/app-config.js`
