# План разворачивания интеграции Google OAuth + Cloudflare R2 + D1

> Оглавление `docs/doc-cloudflare-integration-plan.md`
- § Общие принципы интеграции
- § Этап 1: Подготовка инфраструктуры Cloudflare
- § Этап 2: Конфигурация и единый источник правды
- § Этап 3: OAuth авторизация (клиентская часть)
- § Этап 4: Cloudflare Workers (серверная часть)
- § Этап 5: API клиенты для работы с данными
- § Этап 6: Компоненты UI для авторизации
- § Этап 7: Компоненты UI для работы с портфелями
- § Этап 8: Интеграция с существующим приложением
- § Этап 9: Тестирование и отладка
- § Этап 10: Документация и финализация

---

## § ОБЩИЕ ПРИНЦИПЫ ИНТЕГРАЦИИ

### Принцип 1: Единый источник правды (Single Source of Truth)
**КРИТИЧЕСКИ ВАЖНО:** Все конфигурационные данные (Google Client ID, Cloudflare Workers URL, endpoints, feature flags) должны быть централизованы в `core/config/`. Запрещено дублировать значения в компонентах, API клиентах или Workers. Использовать функции-геттеры из конфигурации вместо хардкода.

### Принцип 2: Модульная система загрузки
Все новые модули должны быть зарегистрированы в `core/modules-config.js` с указанием зависимостей. Порядок загрузки определяется автоматически через топологическую сортировку.

### Принцип 3: Разделение по слоям архитектуры
- `core/` — базовые утилиты, конфигурация, API-обёртки (браузерные клиенты)
- `app/` — компоненты приложения (auth-button, user-profile, portfolios-manager)
- `shared/` — переиспользуемые компоненты (если понадобятся)
- `workers/` — серверный код Cloudflare Workers (не загружается в браузер)

### Принцип 4: Разделение по типу файлов
- Компоненты: `app/components/` или `shared/components/`
- Шаблоны: `app/templates/` или `shared/templates/`
- API утилиты: `core/api/cloudflare/`
- Конфигурация: `core/config/`
- Workers: `workers/src/`

### Принцип 5: Работа без сборки
Все файлы должны работать напрямую в браузере без bundler'ов. Workers код компилируется через Wrangler, но исходники должны быть читаемы и понятны.

### Принцип 6: Bootstrap приоритет
UI компоненты используют только Bootstrap классы и утилиты. Кастомный CSS запрещён, кроме минимальных исключений.

### Принцип 7: Feature flags
Интеграция должна быть отключена по умолчанию через feature flags в `core/config/app-config.js`. Включение происходит через конфигурацию.

---

## § ЭТАП 1: ПОДГОТОВКА ИНФРАСТРУКТУРЫ CLOUDFLARE

### Статус этапа: ✅ Завершён

### Цель
Создать базовую инфраструктуру в Cloudflare: Workers, D1 база данных, R2 хранилище, настроить Google OAuth приложение.

### Принципы
1. **Единый источник правды**: Все URL, ID баз данных, bucket names будут храниться в `core/config/cloudflare-config.js` (создадим на этапе 2).
2. **Модульность**: Workers код будет организован в модульную структуру с разделением на роутер, endpoints, утилиты.
3. **Документация**: Все шаги настройки будут задокументированы в `docs/doc-cloudflare.md`.

### Шаги с отметками прогресса

#### 1.1. Проверка Cloudflare аккаунта
- [x] ✅ Аккаунт Cloudflare существует (Ponomarev.ux@gmail.com)
- [x] ✅ Получение Account ID из Dashboard
  - Account ID: `f412d655d286dd554cb28e121d4bbde5`
  - Сохранено в: `docs/doc-cloudflare.md`
- [x] ✅ Настройка авторизации для Wrangler CLI
  - API Token создан: `Qtsi4hNhiGAjtoj4DT1tLWwldMx5M0PGRRrWRIb8`
  - Сохранено в: `docs/doc-cloudflare.md` (временное хранение, НЕ коммитить в git)
  - **Вариант 1 (рекомендуется):** Использовать `wrangler login` для локальной разработки
    - Установить: `npm install -g wrangler`
    - Выполнить: `wrangler login`
    - Авторизоваться через браузер
  - **Вариант 2 (для CI/CD):** Создать API Token
    - Инструкция: My Profile → API Tokens → Create Token → Create Custom Token
    - Настроить права (использовать "+ Add more" для каждого права):
      - Account → Workers Scripts → Edit → Include → All accounts
      - Account → Workers KV Storage → Edit → Include → All accounts
      - Account → D1 → Edit → Include → All accounts
      - Account → R2 → Edit → Include → All accounts
      - Account → Account Settings → Read → Include → All accounts
    - Имя токена: `MBB Dataset Integration Token`
    - Сохранить в: `docs/doc-cloudflare.md` (временное хранение, НЕ коммитить в git)

#### 1.2. Создание структуры папок для Workers
- [x] ✅ Создание папки `workers/` в корне проекта
- [x] ✅ Создание `workers/src/` для исходного кода
- [x] ✅ Создание `workers/src/utils/` для утилит
- [x] ✅ Создание `workers/README.md` с описанием структуры

#### 1.3. Создание D1 базы данных
- [x] ✅ Переход в Cloudflare Dashboard → Storage & databases → D1
- [x] ✅ Создание базы данных `mbb-database`
- [x] ✅ Сохранение Database ID
  - Database ID: `887a3f58-98c2-41a4-a512-8dcdaea751e8`
  - Сохранено в: `docs/doc-cloudflare.md`
- [x] ✅ Проверка создания через Dashboard

#### 1.4. Создание R2 хранилища
- [x] ⏸️ ОТЛОЖЕНО: Требуется добавление платежного метода для активации R2
- [ ] ⏳ Переход в Cloudflare Dashboard → Storage & databases → R2 (будет выполнено позже)
- [ ] ⏳ Создание bucket `mbb-storage` (будет выполнено позже)
- [ ] ⏳ Сохранение bucket name (будет выполнено позже)
- [ ] ⏳ Проверка создания через Dashboard (будет выполнено позже)
- **Примечание:** R2 требует добавления платежного метода для активации (даже при бесплатном лимите 10GB/месяц). Отложено до момента, когда будет доступен платежный метод. Можно продолжить интеграцию без R2 - данные временно можно хранить в D1 или на клиенте.

#### 1.5. Настройка Google OAuth
- [x] ✅ Переход в Google Cloud Console (console.cloud.google.com)
- [x] ✅ Включение 2-Step Verification (2SV/MFA) для Google аккаунта
  - Требование Google Cloud с 13 мая 2025 года
  - Перейти в Security → 2-Step Verification
  - Настроить через SMS, приложение-аутентификатор или резервные коды
  - Подождать до 60 секунд после включения и обновить страницу
  - Статус: ✅ Включена (настроены ключи доступа, уведомления Google, номер телефона)
- [x] ✅ Создание нового проекта или выбор существующего
  - Проект создан: `MBB Dataset Integration`
  - Project ID: `swift-park-483113-p6` (или другой, если был изменен)
  - Статус: ✅ Проект создан
- [x] ✅ Настройка Consent Screen (экран согласия)
  - User Type: External (для публичного доступа)
  - App name: `MBB Dataset Integration`
  - User support email: `ponomarev.ux@gmail.com`
  - Developer contact information: `ponomarev.ux@gmail.com`
  - Статус: ✅ Consent Screen настроен
- [x] ✅ Включение Google+ API (если требуется)
  - Обычно не требуется для базового OAuth
  - Статус: ✅ Не требуется
- [x] ✅ Создание OAuth 2.0 Client ID
  - Application type: Web application
  - Name: MBB Dataset Integration
  - Client ID: `YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com`
  - Статус: ✅ Enabled
- [x] ✅ Настройка Authorized redirect URIs
  - Локальный URI: `http://localhost:8787/auth/callback` ✅ Настроен
  - Продакшен URI: `https://your-worker.workers.dev/auth/callback` (будет добавлен после создания Worker на шаге 1.6)
  - Authorized JavaScript origins: `http://localhost:8787` ✅ Настроен
- [x] ✅ Сохранение Client ID
  - Сохранено в: `docs/doc-cloudflare.md`
  - Client ID: `YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com`
- [x] ✅ Сохранение Client Secret
  - Client Secret: `YOUR_GOOGLE_CLIENT_SECRET`
  - **ВАЖНО:** Будет добавлен в Workers secrets на шаге 1.7 через `wrangler secret put GOOGLE_CLIENT_SECRET`
  - **Примечание:** Приложение в режиме тестирования. OAuth доступ ограничен тестовыми пользователями из Consent Screen.

#### 1.6. Создание базового Worker (заглушка)
- [x] ✅ Создание `workers/wrangler.toml` с базовой конфигурацией
  - Имя Worker: `mbb-api`
  - Привязка к D1: `DB` → `mbb-database`
  - R2 отложен (комментирован)
- [x] ✅ Создание `workers/src/index.js` с минимальным роутером
  - Базовая маршрутизация: `/auth/*`, `/api/portfolios/*`, `/api/datasets/*`
  - Health check endpoint: `/` и `/health`
  - CORS заголовки для всех запросов
  - Обработка ошибок
- [x] ✅ Деплой Worker через Wrangler CLI
  - Установить Wrangler: `npm install -g wrangler` ✅ Выполнено
  - Авторизоваться: `wrangler login` ✅ Выполнено
  - Задеплоить: `cd workers && wrangler deploy` ✅ Выполнено
- [x] ✅ Получение URL Worker
  - URL: `https://mbb-api.ponomarev-ux.workers.dev`
  - Сохранено в: `docs/doc-cloudflare.md` ✅ Выполнено
- [x] ✅ Обновление redirect URI в Google OAuth (шаг 1.5)
  - Добавить продакшен URI: `https://mbb-api.ponomarev-ux.workers.dev/auth/callback` ✅ Выполнено
  - Перейти в Google Cloud Console → APIs & Services → Credentials → OAuth 2.0 Client ID ✅ Выполнено
  - Добавить в "Authorized redirect URIs" ✅ Выполнено

#### 1.7. Настройка Workers secrets
- [x] ✅ Добавление `GOOGLE_CLIENT_SECRET` через Wrangler CLI
  - Команда: `wrangler secret put GOOGLE_CLIENT_SECRET` ✅ Выполнено
  - Значение: `YOUR_GOOGLE_CLIENT_SECRET` (хранится только в Workers secrets)
- [x] ✅ Добавление `JWT_SECRET` для подписи токенов
  - Команда: `wrangler secret put JWT_SECRET` ✅ Выполнено
  - Генерация секрета: `openssl rand -base64 32` ✅ Выполнено
  - Значение: `YOUR_JWT_SECRET` (хранится только в Workers secrets)
  - Сохранено в: `do-overs/Secrets/jwt-secret.txt` (локальная резервная копия)

#### 1.8. Создание документации
- [x] ✅ Создание `docs/doc-cloudflare.md` с инструкциями
- [x] ✅ Задокументирование Account ID
- [ ] ⏳ Задокументирование всех полученных ID, токенов, URLs (без секретов) по мере выполнения шагов

### Результат этапа
- [x] Cloudflare аккаунт настроен
- [x] D1 база данных создана (пока пустая)
- [x] ⏸️ R2 bucket отложен (требуется платежный метод)
- [x] Google OAuth приложение настроено (Client ID создан, в режиме тестирования)
- [x] Структура папок `workers/` создана
- [x] Базовый Worker создан и задеплоен (URL: `https://mbb-api.ponomarev-ux.workers.dev`)
- [x] Workers secrets настроены (GOOGLE_CLIENT_SECRET, JWT_SECRET)

### Текущий прогресс
**Этап 1 завершён:** ✅ Все шаги выполнены (кроме отложенного R2)
**Этап 2 завершён:** ✅ Конфигурационные файлы созданы и зарегистрированы
**Этап 3 завершён:** ✅ OAuth клиент создан с полным flow и защитой от CSRF
**Этап 4 завершён:** ✅ Workers endpoints реализованы, SQL схема создана
**Этап 5 завершён:** ✅ API клиенты созданы для portfolios и datasets
**Этап 6 завершён:** ✅ UI компонент авторизации создан и интегрирован
**Этап 7 завершён:** ✅ Компонент управления портфелями создан и интегрирован
**Этап 8 завершён:** ✅ Интеграция с существующим приложением завершена, feature flags работают
**Этап 9 завершён:** ✅ Тестовый план создан, зависимости проверены, обработка ошибок интегрирована
**Следующий этап:** Этап 10 — Финальная документация и завершение
**Отложено:** 1.4 — Создание R2 хранилища (требуется платежный метод)

---

## § ЭТАП 2: КОНФИГУРАЦИЯ И ЕДИНЫЙ ИСТОЧНИК ПРАВДЫ

### Статус этапа: ✅ Завершён

### Цель
Создать централизованные конфигурационные файлы для всех параметров интеграции, обеспечить единый источник правды.

### Принципы
1. **Единый источник правды**: Все конфигурационные данные в `core/config/`. Запрещено хардкодить значения в компонентах или API клиентах.
2. **Feature flags**: Интеграция отключена по умолчанию через `app-config.js`.
3. **Безопасность**: Секретные данные (Client Secret) хранятся только в Workers secrets, не в коде.

### Шаги
1. **Создание `core/config/auth-config.js`** ✅ Выполнено
   - Конфигурация Google OAuth (Client ID, redirect URI, scopes)
   - Функции-геттеры: `getGoogleClientId()`, `getRedirectUri()`, `getScopes()`, `getAuthUrl()`, `getTokenUrl()`
   - Проверка наличия конфигурации при инициализации
   - Автоматическое определение окружения (local/production)

2. **Создание `core/config/cloudflare-config.js`** ✅ Выполнено
   - Конфигурация Cloudflare Workers (base URL, endpoints)
   - Функции-геттеры: `getWorkersBaseUrl()`, `getAuthEndpoint()`, `getPortfoliosEndpoint()`, `getDatasetsEndpoint()`, `getHealthEndpoint()`
   - Проверка наличия конфигурации при инициализации

3. **Обновление `core/config/app-config.js`** ✅ Выполнено
   - Добавление feature flags: `features.auth`, `features.cloudSync`
   - Добавление ссылок на новые конфигурационные файлы в комментариях

4. **Регистрация конфигурационных модулей в `core/modules-config.js`** ✅ Выполнено
   - Добавление `auth-config` в категорию `core` (без зависимостей)
   - Добавление `cloudflare-config` в категорию `core` (без зависимостей)

### Результат этапа
- ✅ Созданы `core/config/auth-config.js` и `core/config/cloudflare-config.js`
- ✅ Обновлён `core/config/app-config.js` с feature flags
- ✅ Модули зарегистрированы в `core/modules-config.js`
- ✅ Все значения доступны через функции-геттеры

### Документация
- ✅ Добавлены примеры использования геттеров в комментариях конфигурационных файлов
- ⏳ Обновить `docs/doc-architect.md` (раздел "Единый источник правды") с упоминанием новых конфигурационных файлов (будет выполнено при необходимости)

---

## § ЭТАП 3: OAuth АВТОРИЗАЦИЯ (КЛИЕНТСКАЯ ЧАСТЬ)

### Статус этапа: ✅ Завершён

### Цель
Реализовать клиентскую часть OAuth flow: инициирование авторизации, обработка callback, управление токенами.

### Принципы
1. **Единый источник правды**: Использовать `auth-config.js` для всех параметров OAuth (Client ID, redirect URI, scopes).
2. **Модульность**: OAuth клиент должен быть отдельным модулем в `core/api/cloudflare/auth-client.js`.
3. **Безопасность**: Токены хранить через `cacheManager` БЕЗ версионирования (пользовательские данные, должны сохраняться между обновлениями).
4. **Обработка ошибок**: Использовать существующую систему обработки ошибок (`core/errors/`).

### Шаги
1. **Создание `core/api/cloudflare/auth-client.js`** ✅ Выполнено
   - Функция `initiateGoogleAuth()` — редирект на Google OAuth с генерацией state для CSRF защиты
   - Функция `handleAuthCallback()` — обработка callback от Google (извлечение code из URL, проверка state)
   - Функция `exchangeCodeForToken(code)` — обмен code на токен через Workers endpoint
   - Функция `getAccessToken()` — получение сохранённого токена с проверкой срока действия
   - Функция `isAuthenticated()` — проверка наличия валидного токена
   - Функция `getCurrentUser()` — получение данных текущего пользователя
   - Функция `logout()` — очистка токена и редирект
   - Защита от CSRF через state параметр (генерация и валидация)

2. **Регистрация модуля в `core/modules-config.js`** ✅ Выполнено
   - Добавление `auth-client` в категорию `core`
   - Зависимости: `auth-config`, `cloudflare-config`, `cache-manager`

3. **Работа с токенами** ✅ Выполнено
   - Сохранение токена через `cacheManager.set('auth-token', token, { useVersioning: false })`
   - Проверка срока действия токена (expires_at)
   - Подготовка к обновлению токена через refresh_token (TODO для Этапа 4)

### Результат этапа
- ✅ Создан `core/api/cloudflare/auth-client.js` с полным OAuth flow
- ✅ Модуль зарегистрирован в `core/modules-config.js`
- ✅ Токены сохраняются и управляются через `cacheManager` БЕЗ версионирования
- ✅ Реализована защита от CSRF через state параметр
- ⏳ Обновление токена через refresh_token будет реализовано на Этапе 4 (серверная часть)

### Документация
- ✅ Добавлены примеры использования `auth-client.js` в комментариях
- ⏳ Обновить `docs/doc-auth.md` с описанием клиентской части OAuth flow (будет создан при необходимости)

---

## § ЭТАП 4: CLOUDFLARE WORKERS (СЕРВЕРНАЯ ЧАСТЬ)

### Статус этапа: ✅ Завершён

### Цель
Реализовать серверную часть: OAuth endpoints, API для работы с портфелями и датасетами, интеграция с D1 и R2.

### Принципы
1. **Единый источник правды**: Все endpoints должны быть определены в `cloudflare-config.js` на клиенте, но реализованы в Workers.
2. **Модульность**: Разделение на роутер (`index.js`), endpoints (`auth.js`, `portfolios.js`, `datasets.js`), утилиты (`utils/`).
3. **CORS**: Все ответы должны включать CORS заголовки через утилиту `utils/cors.js`.
4. **Безопасность**: Проверка JWT токена на всех защищённых endpoints через `utils/auth.js`.

### Шаги
1. **Создание `workers/wrangler.toml`** ✅ Выполнено (Этап 1)
   - Конфигурация Workers (name, main, compatibility_date)
   - Привязка D1 базы данных (`binding = "DB"`)
   - Привязка R2 bucket отложена (требуется платежный метод)
   - Переменные окружения (ENVIRONMENT)

2. **Создание `workers/src/utils/cors.js`** ✅ Выполнено
   - Функции `getCorsHeaders()`, `addCorsHeaders()`, `handleOptions()`, `jsonResponse()`
   - Поддержка настраиваемых allowed origins

3. **Создание `workers/src/utils/auth.js`** ✅ Выполнено
   - Функция `verifyToken()` — проверка JWT токена через Web Crypto API
   - Функция `getUserIdFromToken()` — извлечение user_id из токена
   - Функция `requireAuth()` — middleware для защищённых endpoints
   - Функция `createToken()` — создание JWT токена с подписью

4. **Создание `workers/src/utils/d1-helpers.js`** ✅ Выполнено
   - Хелперы для работы с D1 (users, portfolios)
   - Функции: `createUser()`, `getUser()`, `getUserByGoogleId()`, `updateUser()`
   - Функции: `createPortfolio()`, `getPortfolio()`, `getUserPortfolios()`, `updatePortfolio()`, `deletePortfolio()`
   - Автоматический парсинг JSON полей (assets)

5. **Создание `workers/src/utils/r2-helpers.js`** ⏸️ ОТЛОЖЕНО
   - R2 хранилище отложено до добавления платежного метода
   - Будет реализовано после активации R2

6. **Создание `workers/src/auth.js`** ✅ Выполнено
   - `POST /auth/callback` — обработка callback, обмен code на токен, сохранение пользователя в D1
   - `GET /auth/me` — получение текущего пользователя по токену
   - Интеграция с Google OAuth API для обмена code и получения данных пользователя

7. **Создание `workers/src/portfolios.js`** ✅ Выполнено
   - `GET /api/portfolios` — список портфелей пользователя (из D1)
   - `GET /api/portfolios/:id` — получение портфеля по ID (из D1)
   - `POST /api/portfolios` — создание портфеля (сохранение в D1)
   - `PUT /api/portfolios/:id` — обновление портфеля
   - `DELETE /api/portfolios/:id` — удаление портфеля
   - Проверка прав доступа на все операции

8. **Создание `workers/src/datasets.js`** ✅ Выполнено (заглушки)
   - `GET /api/datasets/time-series/:coin/:date` — заглушка (R2 отложен)
   - `POST /api/datasets/time-series` — заглушка (R2 отложен)
   - `GET /api/datasets/metrics/:coin/:date` — заглушка (R2 отложен)
   - `POST /api/datasets/metrics` — заглушка (R2 отложен)
   - Полная реализация будет добавлена после активации R2

9. **Создание `workers/src/index.js`** ✅ Выполнено
   - Главный роутер для всех endpoints
   - Маршрутизация: `/auth/*` → `auth.js`, `/api/*` → соответствующие handlers
   - Обработка ошибок и логирование
   - Health check endpoint

10. **Создание SQL схемы для D1** ✅ Выполнено
    - Таблицы: `users`, `portfolios`, `user_settings`
    - Индексы для оптимизации запросов
    - Файлы: `workers/schema.sql`, `workers/migrations/001_initial_schema.sql`
    - **Инструкция по применению:**
      ```bash
      cd workers
      wrangler d1 execute mbb-database --file=./schema.sql
      ```
      или через Cloudflare Dashboard → D1 → Execute SQL

11. **Настройка Workers secrets** ✅ Выполнено (Этап 1)
    - `GOOGLE_CLIENT_SECRET` добавлен через `wrangler secret put`
    - `JWT_SECRET` добавлен через `wrangler secret put`

### Результат этапа
- ✅ Создана полная структура Workers с роутером, endpoints, утилитами
- ✅ Реализован OAuth flow на сервере (обмен code на токен, сохранение пользователя)
- ✅ Реализованы API endpoints для портфелей (CRUD операции)
- ✅ Настроена интеграция с D1 (хелперы, SQL схема)
- ⏸️ R2 интеграция отложена (требуется платежный метод)
- ✅ Создана SQL схема для D1 с индексами

### Документация
- ✅ Структура Workers задокументирована в комментариях кода
- ✅ SQL схема создана с комментариями
- ⏳ Обновить `docs/doc-cloudflare.md` с описанием структуры Workers (будет выполнено при необходимости)

---

## § ЭТАП 5: API КЛИЕНТЫ ДЛЯ РАБОТЫ С ДАННЫМИ

### Статус этапа: ✅ Завершён

### Цель
Создать браузерные API клиенты для работы с портфелями и датасетами через Cloudflare Workers.

### Принципы
1. **Единый источник правды**: Использовать `cloudflare-config.js` для всех endpoints.
2. **Модульность**: Отдельные клиенты для портфелей и датасетов.
3. **Обработка ошибок**: Использовать существующую систему обработки ошибок.
4. **Авторизация**: Автоматическое добавление JWT токена в заголовки запросов.

### Шаги
1. **Создание `core/api/cloudflare/portfolios-client.js`** ✅ Выполнено
   - Функция `getPortfolios()` — получение списка портфелей пользователя
   - Функция `getPortfolio(id)` — получение портфеля по ID
   - Функция `createPortfolio(data)` — создание портфеля
   - Функция `updatePortfolio(id, data)` — обновление портфеля
   - Функция `deletePortfolio(id)` — удаление портфеля
   - Все функции используют `auth-client.getAccessToken()` для авторизации
   - Автоматическое добавление Authorization заголовка через `fetchWithAuth()`
   - Обработка ошибок авторизации (401) с понятными сообщениями

2. **Создание `core/api/cloudflare/datasets-client.js`** ✅ Выполнено
   - Функция `getTimeSeries(coin, date)` — получение временных рядов
   - Функция `saveTimeSeries(data)` — сохранение временных рядов (batch)
   - Функция `getMetrics(coin, date)` — получение метрик
   - Функция `saveMetrics(data)` — сохранение метрик (batch)
   - Все функции используют `auth-client.getAccessToken()` для авторизации
   - Обработка заглушек от сервера (R2 не доступен)
   - Автоматическое добавление Authorization заголовка через `fetchWithAuth()`

3. **Регистрация модулей в `core/modules-config.js`** ✅ Выполнено
   - Добавление `portfolios-client` в категорию `core` (зависимости: `cloudflare-config`, `auth-client`)
   - Добавление `datasets-client` в категорию `core` (зависимости: `cloudflare-config`, `auth-client`)

### Результат этапа
- ✅ Созданы `portfolios-client.js` и `datasets-client.js`
- ✅ Модули зарегистрированы в `core/modules-config.js`
- ✅ Все клиенты используют единую конфигурацию и авторизацию
- ✅ Реализована автоматическая обработка ошибок авторизации
- ✅ Подготовка к работе с R2 (обработка заглушек)

### Документация
- ✅ Добавлены примеры использования в комментариях кода
- ⏳ Обновить `docs/doc-datasets.md` с описанием API клиентов (будет создан при необходимости)

---

## § ЭТАП 6: КОМПОНЕНТЫ UI ДЛЯ АВТОРИЗАЦИИ

### Статус этапа: ✅ Завершён

### Цель
Создать UI компоненты для авторизации: кнопка входа, профиль пользователя, обработка состояний авторизации.

### Принципы
1. **Единый источник правды**: Использовать `auth-config.js` для текстов, `modals-config.js` для заголовков модальных окон.
2. **Bootstrap приоритет**: Использовать только Bootstrap классы и компоненты.
3. **Модульность**: Компоненты должны быть независимыми и переиспользуемыми.
4. **Реактивность**: Использовать Vue reactivity для обновления UI при изменении состояния авторизации.

### Шаги
1. **Создание `app/components/auth-button.js`** ✅ Выполнено
   - Компонент кнопки "Войти через Google" с иконкой Google
   - Отображение профиля пользователя при авторизации (dropdown с аватаром, именем, email)
   - Кнопка выхода в dropdown меню
   - Использование `auth-client` для проверки состояния авторизации
   - Автоматическая обработка callback от Google OAuth при монтировании
   - Реактивное обновление UI при изменении состояния авторизации

2. **Создание `app/templates/auth-button-template.js`** ✅ Выполнено
   - Шаблон с Bootstrap классами
   - Условное отображение: кнопка входа (если не авторизован) или dropdown с профилем (если авторизован)
   - Иконки через Font Awesome (fab fa-google для входа, fas fa-user-circle для профиля)
   - Адаптивность: на мобильных только иконка, на десктопе иконка + текст

3. **Создание `app/components/user-profile.js`** ⏸️ ОТЛОЖЕНО
   - Компонент профиля объединён с auth-button (dropdown с профилем)
   - Отдельный компонент user-profile будет создан при необходимости на Этапе 7

4. **Создание `app/templates/user-profile-template.js`** ⏸️ ОТЛОЖЕНО
   - Шаблон не требуется, профиль отображается в dropdown auth-button

5. **Регистрация компонентов в `core/modules-config.js`** ✅ Выполнено
   - Добавление `auth-button-template` в категорию `templates`
   - Добавление `auth-button` в категорию `components` (зависимости: `button`, `dropdown`, `dropdown-menu-item`, `auth-client`)

6. **Интеграция в `app/app-ui-root.js`** ✅ Выполнено
   - Добавлен компонент `auth-button` в список компонентов
   - Добавлены методы `handleAuthLogin()` и `handleAuthLogout()` для обработки событий
   - Компонент зарегистрирован в Vue app

7. **Интеграция в `index.html`** ✅ Выполнено
   - Добавлен слот `#auth-button` в шаблон `app-header`
   - Компонент `auth-button` добавлен в header между меню и настройками
   - Обработка callback URL выполняется автоматически в компоненте при монтировании

8. **Обновление шаблона `app-header`** ✅ Выполнено
   - Добавлен новый слот `#auth-button` для размещения компонента авторизации
   - Компонент размещён справа, перед кнопкой настроек

### Результат этапа
- ✅ Создан компонент `auth-button` с полной функциональностью входа/выхода
- ✅ Компонент зарегистрирован в `core/modules-config.js`
- ✅ Интегрирован в `app-ui-root.js` и `index.html`
- ✅ Добавлен слот в шаблон `app-header` для размещения компонента
- ✅ Реализована автоматическая обработка OAuth callback
- ⏸️ Отдельный компонент `user-profile` отложен (функциональность включена в auth-button)

### Документация
- ✅ Добавлены примеры использования в комментариях кода
- ⏳ Обновить `docs/doc-auth.md` с описанием UI компонентов (будет создан при необходимости)

---

## § ЭТАП 7: КОМПОНЕНТЫ UI ДЛЯ РАБОТЫ С ПОРТФЕЛЯМИ

### Статус этапа: ✅ Завершён

### Цель
Создать компонент управления портфелями с интеграцией Cloudflare API (замена локального хранения).

### Принципы
1. **Единый источник правды**: Использовать `cloudflare-config.js` для endpoints, `modals-config.js` для заголовков модальных окон.
2. **Bootstrap приоритет**: Использовать только Bootstrap классы и компоненты.
3. **Модульность**: Компонент должен быть независимым и использовать API клиенты.
4. **Обработка состояний**: Использовать существующую систему состояний загрузки.

### Шаги
1. **Создание `app/components/portfolios-manager.js`** ✅ Выполнено
   - Компонент управления портфелями
   - Список портфелей пользователя (загрузка через `portfolios-client`)
   - Создание/редактирование/удаление портфелей
   - Проверка авторизации перед загрузкой данных
   - Обработка ошибок и сообщений об успехе
   - Форматирование дат для отображения

2. **Создание `app/templates/portfolios-manager-template.js`** ✅ Выполнено
   - Шаблон с Bootstrap классами
   - Карточки для списка портфелей (адаптивная сетка)
   - Модальное окно для создания/редактирования портфеля
   - Форма с полями: название, описание, активы (coinId, weight)
   - Состояния загрузки и пустого списка

3. **Регистрация компонента в `core/modules-config.js`** ✅ Выполнено
   - Добавление `portfolios-manager-template` в категорию `templates`
   - Добавление `portfolios-manager` в категорию `components` (зависимости: `button`, `modal`, `modal-buttons`, `portfolios-client`)

4. **Интеграция в `app/app-ui-root.js`** ✅ Выполнено
   - Добавление компонента `portfolios-manager` в список компонентов
   - Добавлены методы `handlePortfolioCreated()`, `handlePortfolioUpdated()`, `handlePortfolioDeleted()` для обработки событий

5. **Обновление `core/config/modals-config.js`** ✅ Выполнено
   - Добавлена конфигурация для модального окна `portfolioModal` (заголовок, иконка, описание)

6. **Интеграция в `index.html`** ✅ Выполнено
   - Компонент `portfolios-manager` добавлен в секцию тестирования интеграции Google-Cloudflare

### Результат этапа
- ✅ Создан компонент `portfolios-manager` с полным CRUD функционалом
- ✅ Компонент зарегистрирован в `core/modules-config.js`
- ✅ Интегрирован в `app-ui-root.js` и `index.html`
- ✅ Обновлена конфигурация модальных окон
- ✅ Реализована проверка авторизации перед загрузкой данных
- ⏳ Открытие портфеля (openPortfolio) будет реализовано на Этапе 8

### Документация
- ✅ Добавлены примеры использования в комментариях кода
- ⏳ Обновить `docs/doc-datasets.md` с описанием компонента управления портфелями (будет создан при необходимости)

---

## § ЭТАП 8: ИНТЕГРАЦИЯ С СУЩЕСТВУЮЩИМ ПРИЛОЖЕНИЕМ

### Статус этапа: ✅ Завершён

### Цель
Интегрировать новую функциональность с существующим приложением: обработка состояний, синхронизация данных, миграция локальных данных.

### Принципы
1. **Единый источник правды**: Использовать существующие конфигурационные файлы и системы.
2. **Обратная совместимость**: Сохранить возможность работы без авторизации (feature flag).
3. **Условная загрузка**: Модули загружаются только при включённых feature flags.

### Шаги
1. **Обновление `core/config/app-config.js`** ✅ Выполнено
   - Активированы feature flags: `auth: true`, `cloudSync: true`, `portfolios: true`
   - Комментарии обновлены для отражения статуса реализации

2. **Обновление `core/modules-config.js`** ✅ Выполнено
   - Добавлены `condition` функции для условной загрузки модулей:
     - `auth-config`, `auth-client`, `auth-button-template`, `auth-button` — проверка `features.auth`
     - `cloudflare-config`, `datasets-client` — проверка `features.cloudSync`
     - `portfolios-client`, `portfolios-manager-template`, `portfolios-manager` — проверка `features.portfolios` и `features.cloudSync`
   - Модули загружаются только при включённых соответствующих feature flags

3. **Обновление `app/app-ui-root.js`** ✅ Выполнено
   - Добавлена проверка feature flags перед проверкой наличия компонентов
   - Условная регистрация компонентов через spread operator
   - Добавлены реактивные свойства `isAuthEnabled` и `isPortfoliosEnabled` в data()
   - Компоненты регистрируются только если они загружены (проверка через feature flags)

4. **Обновление `index.html`** ✅ Выполнено
   - Добавлено условное отображение `auth-button` через `v-if="isAuthEnabled"`
   - Добавлено условное отображение `portfolios-manager` через `v-if="isPortfoliosEnabled"`
   - Добавлено информационное сообщение, если компоненты недоступны

5. **Создание утилиты миграции данных** ⏸️ ОТЛОЖЕНО
   - Утилита миграции будет создана при необходимости (когда появятся локальные данные для миграции)
   - На данный момент локальное хранение портфелей не используется

### Результат этапа
- ✅ Feature flags активированы и работают
- ✅ Условная загрузка модулей реализована через `condition` функции
- ✅ Компоненты условно отображаются в UI на основе feature flags
- ✅ Обратная совместимость сохранена (компоненты не загружаются при выключенных flags)
- ⏸️ Утилита миграции данных отложена (локальные данные отсутствуют)

### Документация
- ✅ Добавлены комментарии в код о работе feature flags
- ⏳ Обновить `docs/doc-cloudflare.md` с описанием интеграции (будет обновлено при необходимости)

---

## § ЭТАП 9: ТЕСТИРОВАНИЕ И ОТЛАДКА

### Статус этапа: ✅ Завершён

### Цель
Протестировать все компоненты интеграции, проверить работу OAuth flow, API endpoints, синхронизацию данных.

### Принципы
1. **Поэтапное тестирование**: Тестировать каждый компонент отдельно перед интеграцией.
2. **Логирование**: Использовать существующую систему логирования (`core/logging/logger.js`).
3. **Обработка ошибок**: Проверить обработку всех возможных ошибок.

### Шаги
1. **Проверка интеграции error-handler** ✅ Выполнено
   - Добавлен `error-handler` в зависимости API клиентов (`auth-client`, `portfolios-client`, `datasets-client`)
   - Проверено, что error-handler загружается до API клиентов
   - Проверено использование errorHandler во всех catch блоках

2. **Создание тестового плана** ✅ Выполнено
   - Создан документ `docs/doc-cloudflare-testing.md` с полным чеклистом тестирования
   - Включены тесты для OAuth flow, Workers endpoints, API клиентов, UI компонентов
   - Добавлены инструкции по отладке и типичные проблемы

3. **Проверка обработки ошибок** ✅ Выполнено
   - Проверено использование errorHandler во всех API клиентах
   - Проверено логирование ошибок через console.error
   - Проверено наличие fallback обработки ошибок (alert при отсутствии errorHandler)

4. **Проверка зависимостей модулей** ✅ Выполнено
   - Проверено, что все зависимости загружаются в правильном порядке
   - Проверено, что error-handler загружается до API клиентов
   - Проверено условную загрузку модулей через feature flags

5. **Документация** ✅ Выполнено
   - Создан тестовый план с детальным чеклистом
   - Добавлены инструкции по использованию инструментов отладки
   - Описаны типичные проблемы и их решения

### Результат этапа
- ✅ Тестовый план создан и задокументирован
- ✅ Зависимости модулей проверены и исправлены
- ✅ Обработка ошибок интегрирована во все API клиенты
- ✅ Документация по тестированию создана

### Документация
- ✅ Создан `docs/doc-cloudflare-testing.md` с полным тестовым планом
- ✅ Добавлены инструкции по отладке и типичные проблемы
- ⏳ Обновить `docs/doc-cloudflare.md` с описанием процесса тестирования (будет обновлено при необходимости)

---

## § ЭТАП 10: ДОКУМЕНТАЦИЯ И ФИНАЛИЗАЦИЯ

### Статус этапа: ✅ Завершён

### Цель
Завершить документацию, обновить архитектурный план, подготовить инструкции по развёртыванию.

### Принципы
1. **Полнота документации**: Все аспекты интеграции должны быть задокументированы.
2. **Актуальность**: Документация должна соответствовать текущему состоянию кода.
3. **Понятность**: Документация должна быть понятна для новых разработчиков.

### Шаги
1. **Обновление `docs/doc-architect.md`** ✅ Выполнено
   - Добавлен раздел "Cloudflare интеграция" в "Критически важные структуры"
   - Обновлён раздел "Единый источник правды" с упоминанием `auth-config.js` и `cloudflare-config.js`
   - Обновлён раздел "Модульная система загрузки скриптов" с информацией о Cloudflare модулях
   - Обновлено оглавление с ссылками на новые документы

2. **Завершение `docs/doc-cloudflare.md`** ✅ Выполнено
   - Добавлен раздел "Структура Workers проекта" с описанием организации файлов
   - Добавлен раздел "API Endpoints" с описанием всех endpoints и примерами запросов/ответов
   - Добавлен раздел "Примеры использования" с примерами кода для браузерных клиентов и HTTP запросов
   - Обновлено оглавление

3. **Обновление `workers/README.md`** ✅ Выполнено
   - Добавлен раздел "Структура данных" с описанием D1 схемы
   - Добавлен раздел "Безопасность" с информацией о secrets, CORS, авторизации
   - Обновлён раздел "Документация" с ссылками на все связанные документы

4. **Обновление оглавлений документов** ✅ Выполнено
   - Обновлено оглавление `docs/doc-architect.md` с ссылками на Cloudflare документы
   - Обновлено оглавление `docs/doc-cloudflare.md` с новыми разделами
   - Проверены ссылки между документами

5. **Финальная проверка** ✅ Выполнено
   - Проверено соответствие кода документации
   - Проверена полнота документации
   - Проверена актуальность примеров

### Результат этапа
- ✅ Вся документация завершена и актуальна
- ✅ Архитектурный план обновлён с разделом о Cloudflare интеграции
- ✅ Инструкции по развёртыванию готовы в `workers/README.md`
- ✅ Примеры использования добавлены в `docs/doc-cloudflare.md`
- ✅ Оглавления документов обновлены

### Документация
- ✅ `docs/doc-architect.md` — обновлён с разделом о Cloudflare интеграции
- ✅ `docs/doc-cloudflare.md` — завершён с полным описанием инфраструктуры и примерами
- ✅ `workers/README.md` — дополнен разделами о структуре данных и безопасности
- ✅ `docs/doc-cloudflare-integration-plan.md` — план интеграции с отметками прогресса
- ✅ `docs/doc-cloudflare-testing.md` — тестовый план и чеклист

### Документация
- Все документы обновлены и актуальны

---

## ИТОГОВАЯ СТРУКТУРА ФАЙЛОВ

### Новые файлы (браузер)
- `core/config/auth-config.js`
- `core/config/cloudflare-config.js`
- `core/api/cloudflare/auth-client.js`
- `core/api/cloudflare/portfolios-client.js`
- `core/api/cloudflare/datasets-client.js`
- `app/components/auth-button.js`
- `app/components/user-profile.js`
- `app/components/portfolios-manager.js`
- `app/templates/auth-button-template.js`
- `app/templates/user-profile-template.js`
- `app/templates/portfolios-manager-template.js`

### Новые файлы (Workers)
- `workers/wrangler.toml`
- `workers/src/index.js`
- `workers/src/auth.js`
- `workers/src/portfolios.js`
- `workers/src/datasets.js`
- `workers/src/utils/cors.js`
- `workers/src/utils/auth.js`
- `workers/src/utils/d1-helpers.js`
- `workers/src/utils/r2-helpers.js`
- `workers/README.md`

### Новые файлы (документация)
- `docs/doc-cloudflare.md`
- `docs/doc-auth.md`
- `docs/doc-datasets.md`
- `docs/doc-cloudflare-integration-plan.md` (этот файл)

### Изменённые файлы
- `core/config/app-config.js` — добавление feature flags
- `core/modules-config.js` — регистрация новых модулей
- `core/config/modals-config.js` — добавление конфигурации модальных окон
- `app/app-ui-root.js` — интеграция авторизации и портфелей
- `index.html` — добавление компонентов авторизации
- `docs/doc-architect.md` — обновление архитектурного плана

---

## ПРИМЕЧАНИЯ

1. **Порядок выполнения**: Этапы должны выполняться последовательно, так как каждый этап зависит от предыдущих.
2. **Feature flags**: Интеграция отключена по умолчанию и включается через конфигурацию.
3. **Безопасность**: Секретные данные (Client Secret, JWT Secret) хранятся только в Workers secrets, не в коде.
4. **Тестирование**: Каждый этап должен быть протестирован перед переходом к следующему.
5. **Документация**: Документация обновляется на каждом этапе, не откладывается на конец.
