# Тестирование интеграции Google OAuth + Cloudflare

## Обзор

Данный документ описывает процесс тестирования интеграции Google OAuth с Cloudflare Workers, D1 и R2.

## Предварительные требования

1. ✅ Cloudflare Worker развёрнут и доступен
2. ✅ Google OAuth Client ID создан и настроен
3. ✅ D1 база данных создана и схема применена
4. ✅ Feature flags активированы (`auth: true`, `cloudSync: true`, `portfolios: true`)

## Чеклист тестирования

### 1. Тестирование OAuth Flow

#### 1.1 Проверка редиректа на Google
- [ ] Открыть приложение в браузере
- [ ] Нажать кнопку "Войти через Google"
- [ ] Проверить, что происходит редирект на Google OAuth страницу
- [ ] Проверить, что в URL есть параметры: `client_id`, `redirect_uri`, `response_type=code`, `scope`, `state`

#### 1.2 Проверка обработки callback
- [ ] После авторизации на Google проверить редирект обратно на приложение
- [ ] Проверить, что в URL есть параметры `code` и `state`
- [ ] Проверить, что токен сохраняется в кэше
- [ ] Проверить, что пользователь видит свой профиль в header

#### 1.3 Проверка сохранения токена
- [ ] Открыть DevTools → Application → Local Storage
- [ ] Проверить наличие ключа `google-auth-token` с данными токена
- [ ] Проверить наличие ключа `google-user-profile` с данными пользователя
- [ ] Проверить, что `expiresAt` установлен корректно

#### 1.4 Проверка выхода
- [ ] Нажать на профиль пользователя в header
- [ ] Нажать "Выйти"
- [ ] Проверить, что токены удалены из кэша
- [ ] Проверить, что отображается кнопка "Войти через Google"

### 2. Тестирование Workers Endpoints

#### 2.1 Health Check
```bash
curl https://mbb-api.ponomarev-ux.workers.dev/health
```
- [ ] Проверить, что возвращается статус 200
- [ ] Проверить, что в ответе есть `status: 'ok'`

#### 2.2 OAuth Callback Endpoint
```bash
# Получить authorization code вручную через браузер, затем:
curl -X POST https://mbb-api.ponomarev-ux.workers.dev/auth/callback \
  -H "Content-Type: application/json" \
  -d '{"code": "AUTHORIZATION_CODE", "redirect_uri": "https://mbb-api.ponomarev-ux.workers.dev/auth/callback"}'
```
- [ ] Проверить, что возвращается JWT токен
- [ ] Проверить, что возвращается `user_profile`
- [ ] Проверить, что пользователь создан в D1

#### 2.3 CORS Headers
- [ ] Проверить, что все ответы содержат CORS заголовки:
  - `Access-Control-Allow-Origin: *`
  - `Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS`
  - `Access-Control-Allow-Headers: Content-Type, Authorization`

#### 2.4 Protected Endpoints (требуют авторизации)
```bash
# Получить JWT токен из браузера после авторизации
curl -X GET https://mbb-api.ponomarev-ux.workers.dev/api/portfolios \
  -H "Authorization: Bearer JWT_TOKEN"
```
- [ ] Проверить, что без токена возвращается 401
- [ ] Проверить, что с валидным токеном возвращается список портфелей

### 3. Тестирование API Клиентов

#### 3.1 Portfolios Client

##### 3.1.1 Получение списка портфелей
- [ ] Вызвать `window.portfoliosClient.getPortfolios()`
- [ ] Проверить, что возвращается массив портфелей
- [ ] Проверить обработку ошибки при отсутствии авторизации

##### 3.1.2 Создание портфеля
- [ ] Вызвать `window.portfoliosClient.createPortfolio({ name: 'Test', assets: [] })`
- [ ] Проверить, что портфель создан
- [ ] Проверить обработку ошибок валидации

##### 3.1.3 Обновление портфеля
- [ ] Вызвать `window.portfoliosClient.updatePortfolio(id, { name: 'Updated' })`
- [ ] Проверить, что портфель обновлён
- [ ] Проверить обработку ошибки при отсутствии портфеля

##### 3.1.4 Удаление портфеля
- [ ] Вызвать `window.portfoliosClient.deletePortfolio(id)`
- [ ] Проверить, что портфель удалён
- [ ] Проверить обработку ошибки при отсутствии портфеля

#### 3.2 Auth Client

##### 3.2.1 Проверка авторизации
- [ ] Вызвать `window.authClient.isAuthenticated()`
- [ ] Проверить, что возвращается `true` после входа
- [ ] Проверить, что возвращается `false` после выхода

##### 3.2.2 Получение токена
- [ ] Вызвать `window.authClient.getAccessToken()`
- [ ] Проверить, что возвращается токен
- [ ] Проверить обработку истёкшего токена

##### 3.2.3 Получение профиля пользователя
- [ ] Вызвать `window.authClient.getCurrentUser()`
- [ ] Проверить, что возвращается профиль пользователя

### 4. Тестирование UI Компонентов

#### 4.1 Auth Button Component

##### 4.1.1 Отображение кнопки входа
- [ ] Проверить, что кнопка отображается когда пользователь не авторизован
- [ ] Проверить, что кнопка содержит иконку Google
- [ ] Проверить, что текст кнопки "Войти через Google"

##### 4.1.2 Отображение профиля
- [ ] Проверить, что после входа отображается dropdown с профилем
- [ ] Проверить, что отображается аватар пользователя
- [ ] Проверить, что отображается имя и email
- [ ] Проверить наличие кнопки "Выйти"

##### 4.1.3 Реактивность
- [ ] Проверить, что UI обновляется при входе/выходе
- [ ] Проверить, что состояние сохраняется при перезагрузке страницы

#### 4.2 Portfolios Manager Component

##### 4.2.1 Отображение списка портфелей
- [ ] Проверить, что список портфелей отображается после авторизации
- [ ] Проверить, что пустое состояние отображается когда портфелей нет
- [ ] Проверить состояние загрузки

##### 4.2.2 Создание портфеля
- [ ] Нажать "Создать портфель"
- [ ] Проверить, что открывается модальное окно
- [ ] Заполнить форму и сохранить
- [ ] Проверить, что портфель появился в списке

##### 4.2.3 Редактирование портфеля
- [ ] Нажать "Редактировать" на портфеле
- [ ] Проверить, что модальное окно открывается с предзаполненными данными
- [ ] Изменить данные и сохранить
- [ ] Проверить, что изменения отражены в списке

##### 4.2.4 Удаление портфеля
- [ ] Нажать "Удалить" на портфеле
- [ ] Подтвердить удаление
- [ ] Проверить, что портфель удалён из списка

##### 4.2.5 Обработка ошибок
- [ ] Проверить отображение ошибок при неудачных операциях
- [ ] Проверить сообщения об успехе при успешных операциях

### 5. Тестирование Интеграции

#### 5.1 Полный Flow
- [ ] Войти через Google OAuth
- [ ] Создать портфель
- [ ] Редактировать портфель
- [ ] Удалить портфель
- [ ] Выйти из системы
- [ ] Проверить, что данные сохраняются в D1

#### 5.2 Проверка Feature Flags
- [ ] Выключить `features.auth` в `app-config.js`
- [ ] Проверить, что компоненты авторизации не загружаются
- [ ] Включить обратно
- [ ] Проверить, что компоненты загружаются

#### 5.3 Проверка Условной Загрузки
- [ ] Проверить в DevTools → Network, что модули загружаются только при включённых feature flags
- [ ] Проверить, что зависимости загружаются в правильном порядке

### 6. Отладка

#### 6.1 Логирование
- [ ] Проверить консоль браузера на наличие ошибок
- [ ] Проверить логи Cloudflare Worker (через Dashboard → Workers → Logs)
- [ ] Проверить логи D1 (через Dashboard → D1 → Logs)

#### 6.2 Типичные проблемы

##### Проблема: "auth-client не загружен"
**Решение:** Проверить, что `auth-config` и `cloudflare-config` загружены до `auth-client`

##### Проблема: "CORS error"
**Решение:** Проверить, что Worker возвращает правильные CORS заголовки

##### Проблема: "401 Unauthorized"
**Решение:**
- Проверить, что токен не истёк
- Проверить, что токен передаётся в заголовке Authorization
- Проверить, что JWT_SECRET в Worker совпадает с тем, что использовался при создании токена

##### Проблема: "Portfolio not found"
**Решение:**
- Проверить, что portfolioId правильный
- Проверить, что портфель принадлежит текущему пользователю
- Проверить логи D1 на наличие ошибок SQL

## Инструменты для тестирования

1. **Браузер DevTools**
   - Console — для проверки ошибок JavaScript
   - Network — для проверки HTTP запросов
   - Application → Local Storage — для проверки кэша

2. **Cloudflare Dashboard**
   - Workers → Logs — для проверки логов Worker
   - D1 → Execute SQL — для проверки данных в базе
   - D1 → Logs — для проверки логов D1

3. **curl / Postman**
   - Для тестирования API endpoints напрямую

## Результаты тестирования

После завершения тестирования заполните:

- [ ] Все тесты OAuth Flow пройдены
- [ ] Все тесты Workers Endpoints пройдены
- [ ] Все тесты API Клиентов пройдены
- [ ] Все тесты UI Компонентов пройдены
- [ ] Все тесты Интеграции пройдены
- [ ] Найденные ошибки исправлены
- [ ] Документация обновлена

## Известные ограничения

1. **R2 Storage**: Отложено до добавления платежного метода
2. **Refresh Token**: Обновление токена пока не реализовано (требуется повторный вход при истечении)
3. **Миграция данных**: Утилита миграции отложена (локальные данные отсутствуют)
