# Протокол работы с libs-репозиторием

> Оглавление `docs/doc-lib-github.md`
- § Активация протокола — когда и как запускается протокол
- § Автоматическая активация — автоматическая загрузка библиотек при изменении core/lib-loader.js
- § Последовательность действий — пошаговый сценарий работы с libs-репозиторием
- § Структура libs-репозитория — организация файлов и версий
- § Интеграция с MBB — обновление конфигурации в основном проекте

> § <br> АКТИВАЦИЯ ПРОТОКОЛА

## Условия активации
Протокол активируется в следующих случаях:
- При необходимости добавить новую библиотеку в `libs`-репозиторий
- При обновлении версии существующей библиотеки
- При обнаружении, что библиотека отсутствует в `core/lib-loader.js` или `docs/doc-lib-vue.md`
- По явной команде пользователя: "добавить библиотеку в libs", "обновить библиотеку" или аналогичной

## Определение необходимости
Перед активацией протокола проверь:
1. Требуется ли библиотека для текущей задачи
2. Наличие библиотеки в `docs/doc-lib-vue.md`
3. Загружается ли библиотека через `core/lib-loader.js`
4. Есть ли UMD-сборка библиотеки (для работы через CDN)

> § <br> АВТОМАТИЧЕСКАЯ АКТИВАЦИЯ

## Условия автоматической активации
Протокол автоматически активируется при:
- Добавлении новой библиотеки в `LIB_SOURCES` в `core/lib-loader.js`
- Изменении версии существующей библиотеки в `LIB_SOURCES`
- Обнаружении библиотеки в `LIB_SOURCES`, которой нет в libs-репозитории

## Алгоритм автоматической загрузки

### Шаг 1: Обнаружение изменений
1. При изменении `core/lib-loader.js` сравни старую и новую версию `LIB_SOURCES`
2. Найди новые библиотеки или изменённые версии существующих
3. Для каждой новой/изменённой библиотеки извлеки:
   - `libName` — имя библиотеки (ключ в `LIB_SOURCES`)
   - `version` — версия из URL источника (jsdelivr/cdnjs) или из структуры папок
   - `sourceUrl` — URL для загрузки из внешнего CDN (jsdelivr или cdnjs, приоритет jsdelivr)
   - `filename` — имя файла из URL или стандартное имя (см. "Определение имени файла")

### Шаг 2: Проверка наличия в libs-репозитории и документации
1. Переключись на libs-репозиторий: `cd ../libs` (из MBB) или используй абсолютный путь
2. Проверь существование файла: `libs/<library-name>/<version>/<filename>`
3. Вернись в MBB-репозиторий: `cd ../MBB` (из libs)
4. Проверь наличие библиотеки в `docs/doc-lib-vue.md`:
   - Если библиотека уже описана — обнови версию при необходимости
   - Если библиотека не описана — будет добавлено описание на шаге 5
5. Если файл существует в libs и библиотека описана в документации — пропусти библиотеку
6. Если файла нет в libs или библиотека не описана — переходи к загрузке

### Шаг 3: Загрузка файла библиотеки
1. Создай структуру папок: `libs/<library-name>/<version>/`
2. Загрузи файл из `sourceUrl` через `curl` или `wget`:
   ```bash
   curl -L -o "libs/<library-name>/<version>/<filename>" "<sourceUrl>"
   ```
3. Проверь успешность загрузки (файл существует и не пустой)
4. Если загрузка не удалась — попробуй альтернативный источник (cdnjs, если использовался jsdelivr)

### Шаг 4: Определение имени файла
Если имя файла не указано явно в URL, используй стандартные имена:
- `vue.global.js` для Vue.js
- `<library-name>.umd.js` для большинства библиотек (если есть UMD-сборка)
- `<library-name>.min.js` для минифицированных версий
- `<library-name>.js` как последний вариант

Порядок проверки:
1. Извлечь имя из URL (последний сегмент пути)
2. Если не удалось — использовать стандартное имя по типу библиотеки
3. Если файл не загрузился — попробовать альтернативные имена

### Шаг 5: Обновление документации в MBB
1. Вернись в MBB-репозиторий: `cd ../MBB` (из libs)
2. Проверь наличие библиотеки в `docs/doc-lib-vue.md`:
   - Если библиотека уже описана — обнови версию и источники
   - Если библиотека не описана — добавь описание в соответствующий раздел (критически важные, очень полезные, полезные)
3. При добавлении описания укажи:
   - Назначение библиотеки
   - Версию
   - Расширяемость (плагины, composables, кастомизация)
   - Источники загрузки
   - Примечания (если есть)

### Шаг 6: Уведомление пользователя
После успешной загрузки уведоми пользователя:
- "Библиотека `<name>@<version>` загружена в libs-репозиторий"
- "Файл сохранён: `libs/<name>/<version>/<filename>`"
- "Выполните коммит в libs-репозитории для применения изменений: `cd ../libs && git add . && git commit -m 'Добавлена библиотека <name> версии <version>'`"

## Ограничения автоматизации
- **Коммиты**: Файлы загружаются в libs-репозиторий, но коммит выполняется только по явной команде пользователя (следуй общему правилу о коммитах)
- **Проверка UMD**: Перед загрузкой проверь наличие UMD-сборки (если библиотека не имеет UMD — предупреди пользователя)
- **Ошибки загрузки**: Если загрузка не удалась — предупреди пользователя и предложи ручную загрузку
- **Версионирование**: Автоматическое извлечение версии из URL может быть неточным — проверь результат

## Примеры автоматической активации

### Пример 1: Добавление новой библиотеки
```javascript
// В core/lib-loader.js добавлено:
'new-library': [
    { url: 'https://aoponomarev.github.io/libs/new-library/1.0.0/new-library.umd.js', type: 'github' },
    { url: 'https://cdn.jsdelivr.net/npm/new-library@1.0.0/dist/new-library.umd.js', type: 'jsdelivr' }
]
```
**Действия агента**:
1. Обнаружена новая библиотека `new-library` версии `1.0.0`
2. Проверка наличия в libs: `libs/new-library/1.0.0/new-library.umd.js` — не существует
3. Проверка наличия в документации: `docs/doc-lib-vue.md` — библиотека не описана
4. Загрузка из jsdelivr: `curl -L -o "libs/new-library/1.0.0/new-library.umd.js" "https://cdn.jsdelivr.net/npm/new-library@1.0.0/dist/new-library.umd.js"`
5. Обновление `docs/doc-lib-vue.md` с описанием библиотеки
6. Уведомление пользователя о необходимости коммита

### Пример 2: Изменение версии
```javascript
// В core/lib-loader.js изменено:
'vue': [
    { url: 'https://aoponomarev.github.io/libs/vue/3.5.0/vue.global.js', type: 'github' },
    { url: 'https://cdn.jsdelivr.net/npm/vue@3.5.0/dist/vue.global.js', type: 'jsdelivr' }
]
```
**Действия агента**:
1. Обнаружено изменение версии `vue` с `3.4.0` на `3.5.0`
2. Проверка наличия в libs: `libs/vue/3.5.0/vue.global.js` — не существует
3. Проверка наличия в документации: `docs/doc-lib-vue.md` — библиотека описана с версией 3.4.0
4. Загрузка новой версии
5. Обновление документации (версия в `docs/doc-lib-vue.md` обновлена на 3.5.0)

> § <br> ПОСЛЕДОВАТЕЛЬНОСТЬ ДЕЙСТВИЙ

## Шаг 1: Переключение на libs-репозиторий

### Если workspace содержит оба репозитория
- Работай с папкой `libs` в том же workspace
- В терминале переключись: `cd ../libs` (из MBB) или используй абсолютный путь

### Если libs не открыт в workspace
- Предупреди пользователя о необходимости открыть libs-репозиторий
- Предложи открыть multi-root workspace или переключиться вручную

## Шаг 2: Добавление/обновление библиотеки

### Создание структуры папок
1. Создай структуру: `libs/<library-name>/<version>/`
2. Примеры:
   - `libs/vue/3.4.0/`
   - `libs/chartjs/4.4.0/`
   - `libs/numeral/2.0.6/`

### Загрузка файлов библиотеки
1. Загрузи UMD-сборку библиотеки (не ES modules)
2. Размести файлы в соответствующей папке версии
3. Используй стандартные имена файлов:
   - `vue.global.js` для Vue.js
   - `<library-name>.umd.js` для большинства библиотек
   - `<library-name>.min.js` для минифицированных версий

### Обновление README.md (опционально)
Если требуется, обнови `README.md` в libs-репозитории с описанием новой библиотеки.

## Шаг 3: Обновление конфигурации в MBB

### Возврат в MBB-репозиторий
- Вернись в MBB-репозиторий: `cd ../MBB` (из libs) или используй абсолютный путь

### Обновление core/lib-loader.js
1. Добавь источники для новой библиотеки в `LIB_SOURCES`:
   ```javascript
   '<library-name>': [
       { url: 'https://aoponomarev.github.io/libs/<library-name>/<version>/<file>.js', type: 'github' },
       { url: 'https://cdn.jsdelivr.net/npm/<library-name>@<version>/dist/<file>.js', type: 'jsdelivr' },
       { url: 'https://cdnjs.cloudflare.com/ajax/libs/<library-name>/<version>/<file>.js', type: 'cdnjs' },
       { url: './libs/<library-name>@<version>.js', type: 'local' }
   ]
   ```
2. Порядок источников: GitHub Pages → jsdelivr → cdnjs → local

### Обновление docs/doc-lib-vue.md
1. Добавь описание библиотеки в соответствующий раздел (критически важные, очень полезные, полезные)
2. Укажи:
   - Назначение библиотеки
   - Версию
   - Расширяемость (плагины, composables, кастомизация)
   - Источники загрузки
   - Примечания (если есть)

## Шаг 4: Коммит изменений

### Порядок коммитов
1. **Сначала** закоммить изменения в libs-репозитории (если есть изменения):
   - Переключись в libs: `cd ../libs`
   - `git add .`
   - `git commit -m "Добавлена библиотека <name> версии <version>"`
   - `git push` (если требуется)

2. **Затем** закоммить изменения в MBB-репозитории:
   - Вернись в MBB: `cd ../MBB`
   - Следуй протоколу коммитов из `.cursorrules`
   - Обнови соответствующие тематические логи

### Важно
- Не коммить изменения в libs без явной команды пользователя (следуй общему правилу о коммитах)
- При работе с libs всегда возвращайся в MBB для обновления конфигурации
- Документируй все изменения библиотек в `docs/doc-lib-vue.md`

> § <br> СТРУКТУРА LIBS-РЕПОЗИТОРИЯ

## Организация файлов
```
libs/
├── <library-name>/
│   └── <version>/
│       └── <file>.js
├── README.md
└── index.html
```

## Правила именования
- Папки библиотек: kebab-case (`vue-chartjs`, `vuedraggable`)
- Папки версий: семантическое версионирование (`3.4.0`, `4.4.0`)
- Файлы: стандартные имена UMD-сборок

## Версионирование
- Каждая версия библиотеки хранится в отдельной папке
- Старые версии не удаляются (для совместимости)
- Новые версии добавляются без изменения существующих

> § <br> ИНТЕГРАЦИЯ С MBB

## Связь между репозиториями
- **libs-репозиторий**: хранит файлы библиотек, раздаёт через GitHub Pages CDN
- **MBB-репозиторий**: использует библиотеки через `core/lib-loader.js`, документирует в `docs/doc-lib-vue.md`

## Обновление после изменений в libs
После добавления/обновления библиотеки в libs:
1. Обнови `core/lib-loader.js` в MBB (добавь источники)
2. Обнови `docs/doc-lib-vue.md` в MBB (добавь описание)
3. Проверь работоспособность загрузки библиотеки

## Проверка доступности
После push в libs-репозиторий проверь доступность через GitHub Pages:
```
https://aoponomarev.github.io/libs/<library-name>/<version>/<file>.js
```

