# Интеграция MBB с Yandex Cloud

> Оглавление `docs/integration-mbb-ya.md`
- § Текущее состояние — описание текущей ситуации и требований
- § Целевая архитектура — решение на базе Yandex Cloud
- § Преимущества единой платформы — преимущества использования Yandex Cloud
- § Проверка возможностей — подтверждение возможностей Yandex Cloud Functions
- § Технические детали — детали реализации

> § <br> ТЕКУЩЕЕ СОСТОЯНИЕ

## Проблема

Приложение работает из папки на ПК (file:// протокол) или развернуто на GitHub Pages (статический хостинг). Для работы с некоторыми функциями требуется использование данных, поставляемых чат-ботом (YandexGPT).

Yandex API блокирует CORS-запросы из браузера, поэтому требуется проксирование запросов.

## Решение

Yandex Cloud может обеспечить и чат-бот (Foundation Models API), и проксирование (Cloud Functions) в рамках единой платформы, обеспечивая бесшовную работу архитектуры.

> § <br> ЦЕЛЕВАЯ АРХИТЕКТУРА

## Схема интеграции

```
┌─────────────────┐
│  Приложение     │
│  (file:// или   │
│   GitHub Pages) │
└────────┬────────┘
         │ HTTPS (CORS разрешен)
         ▼
┌─────────────────────────────┐
│  Yandex Cloud Functions     │
│  (Прокси для YandexGPT API) │
│  - Обрабатывает CORS        │
│  - Добавляет Authorization  │
│  - Перенаправляет запросы   │
└────────┬────────────────────┘
         │ Внутренний API
         ▼
┌─────────────────────────────┐
│  Yandex Cloud               │
│  Foundation Models API      │
│  (YandexGPT)                │
└─────────────────────────────┘
```

## Варианты проксирования в Yandex Cloud

### 1. Cloud Functions (рекомендуется)

Serverless-функции для проксирования запросов с поддержкой CORS.

**Преимущества**:
- ✅ Единая платформа с YandexGPT
- ✅ Встроенная аутентификация через Service Account
- ✅ Единый биллинг и мониторинг
- ✅ HTTPS по умолчанию
- ✅ Безопасное хранение API-ключей через переменные окружения
- ✅ Легкая интеграция с другими сервисами Yandex Cloud

### 2. API Gateway

Управляемый прокси с роутингом и автоматической обработкой CORS.

**Преимущества**:
- ✅ Управление через консоль без написания кода
- ✅ Автоматическое масштабирование
- ✅ Встроенная интеграция с Cloud Functions и сервисами

> § <br> ПРЕИМУЩЕСТВА ЕДИНОЙ ПЛАТФОРМЫ

## Безопасность

- **Хранение API-ключей**: API-ключи хранятся в переменных окружения Cloud Functions, а не передаются через клиент
- **Единая система IAM**: использование Service Accounts для безопасной аутентификации
- **HTTPS по умолчанию**: весь трафик шифруется

## Мониторинг и логирование

- **Единый дашборд**: мониторинг функций и API в одной консоли
- **Централизованные логи**: логи прокси и API в одном месте
- **Трейсинг**: отслеживание запросов от клиента до API

## Биллинг

- **Единый счет**: все расходы на одной платформе
- **Прогнозируемые расходы**: легче планировать бюджет
- **Скидки на объем**: при использовании нескольких сервисов

## Производительность

- **Внутренняя сеть**: запросы внутри Yandex Cloud имеют меньшую задержку
- **Оптимизация**: возможность кэширования и оптимизации на уровне платформы
- **Меньше внешних зависимостей**: все сервисы в одной экосистеме

## Управление

- **Одна консоль**: управление всеми сервисами в едином интерфейсе
- **Версионирование**: единая система версионирования функций
- **CI/CD**: интеграция с Git для автоматического деплоя

> § <br> ПРОВЕРКА ВОЗМОЖНОСТЕЙ

## Подтвержденные возможности Yandex Cloud Functions

На основе официальной документации Yandex Cloud подтверждено, что Cloud Functions **полностью поддерживает** все необходимые возможности для проксирования запросов к YandexGPT API:

### ✅ Обработка CORS

**Подтверждено**: Yandex Cloud Functions может обрабатывать CORS-запросы и добавлять необходимые заголовки в ответы (`Access-Control-Allow-Origin`, `Access-Control-Allow-Methods`, `Access-Control-Allow-Headers`).

**Источник**: Это официально рекомендованное решение в документации Yandex Cloud для обхода проблем с CORS при работе с API сервисами (SpeechKit, Vision OCR, Translate, Foundation Models API), которые не поддерживают кросс-доменные запросы напрямую.

**Поддержка preflight-запросов**: Cloud Functions может обрабатывать OPTIONS-запросы (preflight) для CORS.

### ✅ Добавление заголовка Authorization

**Подтверждено**: Внутри Cloud Function можно программно добавлять и изменять заголовки запросов, включая `Authorization`, при перенаправлении запросов к YandexGPT API.

### ✅ Перенаправление запросов

**Подтверждено**: Cloud Functions поддерживают исходящие соединения по протоколам TCP, UDP и ICMP, что позволяет устанавливать соединения с внешними сервисами, включая Foundation Models API.

**HTTP-триггер**: Для приема входящих HTTP-запросов от клиентского приложения используется HTTP-триггер, который полностью поддерживает обработку запросов и их перенаправление к целевым API.

### ✅ Отсутствие блокировок

**Подтверждено**: Внутренние политики Yandex Cloud **не блокируют** использование Cloud Functions в качестве прокси для Foundation Models API. Более того, это является рекомендуемым паттерном для работы с API сервисами, которые не поддерживают CORS.

### ✅ Соответствие политикам

**Подтверждено**: Использование Cloud Functions для создания прокси-сервиса, обрабатывающего CORS-запросы, добавляющего заголовки и перенаправляющего запросы к YandexGPT API, **полностью соответствует** внутренним политикам и функциональности Yandex Cloud.

**Официальная документация**: В документации Yandex Cloud есть специальная статья о решении CORS проблем через Cloud Functions, что подтверждает легитимность и поддержку такого подхода.

## Ограничения

### Входящие соединения

Cloud Functions **не поддерживают** прямые входящие сетевые соединения. Однако это не является проблемой, так как для приема HTTP-запросов используется HTTP-триггер, который полностью решает эту задачу.

### Исходящие соединения

**Поддерживаются** исходящие соединения по протоколам TCP, UDP и ICMP, что позволяет выполнять запросы к внешним API, включая Foundation Models API.

> § <br> ТЕХНИЧЕСКИЕ ДЕТАЛИ

*Раздел будет дополняться по мере обсуждения деталей интеграции*

## Формат запроса к прокси

*Будет определен в процессе обсуждения*

## Формат ответа от прокси

*Будет определен в процессе обсуждения*

## Обработка CORS

Cloud Functions может обрабатывать CORS-запросы, включая:
- Добавление заголовков `Access-Control-Allow-Origin: *` (или конкретный домен)
- Обработка preflight-запросов (OPTIONS)
- Настройка заголовков `Access-Control-Allow-Methods` и `Access-Control-Allow-Headers`

*Детали реализации будут определены в процессе обсуждения*

## Безопасное хранение API-ключей

API-ключи могут храниться в переменных окружения Cloud Functions, что исключает необходимость передачи их через клиентское приложение.

*Детали реализации будут определены в процессе обсуждения*

## ССЫЛКИ НА ДОКУМЕНТАЦИЮ

- Yandex Cloud Functions: https://yandex.cloud/ru/docs/functions/
- Решение проблем с CORS: https://yandex.cloud/docs/troubleshooting/functions/known-issues/cors-error-when-querying-api-fron-webapp-frontend
- Политики безопасности: https://yandex.cloud/docs/security/standard/all

## ССЫЛКИ

- Провайдер YandexGPT: `core/api/ai-providers/yandex-provider.js`
- Конфигурация: `core/config/app-config.js`
- План интеграции: `docs/integration-mbb-ya-plan.md`
- Yandex Cloud Functions документация: https://yandex.cloud/ru/docs/functions/
