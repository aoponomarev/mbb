<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YandexGPT Chat</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }
        .header {
            background: #2196f3;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 20px;
        }
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .sidebar-content {
            padding: 20px;
            flex: 1;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        .message {
            margin-bottom: 15px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message.user {
            justify-content: flex-end;
        }
        .message.assistant {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .message.user .message-bubble {
            background: #2196f3;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.assistant .message-bubble {
            background: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .message-info {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            padding: 0 4px;
        }
        .input-area {
            padding: 15px 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .input-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        #message-input {
            width: 100%;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        #message-input:focus {
            border-color: #2196f3;
        }
        .input-actions {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            font-size: 12px;
            color: #999;
        }
        .send-button {
            padding: 10px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
            height: 40px;
        }
        .send-button:hover:not(:disabled) {
            background: #1976d2;
        }
        .send-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .field-group {
            margin-bottom: 15px;
        }
        .field-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 13px;
            color: #666;
        }
        .field-group input,
        .field-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
        }
        .field-group input[type="password"] {
            font-family: monospace;
        }
        .button-small {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
        }
        .button-small:hover {
            background: #f5f5f5;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-indicator.connected {
            background: #4caf50;
        }
        .status-indicator.disconnected {
            background: #f44336;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top-color: #2196f3;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px 20px;
        }
        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #666;
        }
        .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üí¨ YandexGPT Chat</h1>
    </div>

    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="sidebar">
            <div class="sidebar-content">
                <div class="field-group">
                    <label for="proxy-url-input">
                        <span class="status-indicator connected"></span>
                        URL –ø—Ä–æ–∫—Å–∏ Cloud Function:
                    </label>
                    <input type="text" id="proxy-url-input" placeholder="https://functions.yandexcloud.net/...">
                    <button class="button-small" id="save-proxy-url">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>

                <div class="field-group">
                    <label for="api-key-input">API –∫–ª—é—á (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <div style="display: flex; gap: 5px;">
                        <input type="password" id="api-key-input" placeholder="AQVN..." style="flex: 1;">
                        <button class="button-small" id="toggle-api-key-visibility" style="width: auto;">üëÅÔ∏è</button>
                    </div>
                    <button class="button-small" id="save-api-key">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>

                <div class="field-group">
                    <label for="folder-id-input">Folder ID:</label>
                    <input type="text" id="folder-id-input" placeholder="b1gv03a122le5a934cqj" value="b1gv03a122le5a934cqj">
                </div>

                <div class="field-group">
                    <label for="model-select">–ú–æ–¥–µ–ª—å:</label>
                    <select id="model-select">
                        <option value="yandexgpt-lite">YandexGPT Lite</option>
                        <option value="yandexgpt">YandexGPT</option>
                    </select>
                </div>

                <div class="divider"></div>

                <div class="field-group">
                    <button class="button-small" id="clear-chat" style="width: 100%; background: #f44336; color: white; border: none;">
                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                    </button>
                </div>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-area">
            <div class="messages-container" id="messages-container">
                <div class="empty-state">
                    <h3>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
                    <p>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å YandexGPT</p>
                </div>
            </div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="1"></textarea>
                    <div class="input-actions">
                        <span>–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏</span>
                    </div>
                </div>
                <button class="send-button" id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ö–ª—é—á–∏ –¥–ª—è localStorage
        const STORAGE_KEYS = {
            proxyUrl: 'ya-chat-proxy-url',
            apiKey: 'ya-chat-api-key',
            folderId: 'ya-chat-folder-id',
            model: 'ya-chat-model',
            chatHistory: 'ya-chat-history'
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let chatHistory = [];
        let isSending = false;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        window.addEventListener('DOMContentLoaded', function() {
            const savedProxyUrl = localStorage.getItem(STORAGE_KEYS.proxyUrl);
            const savedApiKey = localStorage.getItem(STORAGE_KEYS.apiKey);
            const savedFolderId = localStorage.getItem(STORAGE_KEYS.folderId);
            const savedModel = localStorage.getItem(STORAGE_KEYS.model);
            const savedHistory = localStorage.getItem(STORAGE_KEYS.chatHistory);

            if (savedProxyUrl) {
                document.getElementById('proxy-url-input').value = savedProxyUrl;
            } else {
                // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('proxy-url-input').value = 'https://functions.yandexcloud.net/d4erd8d1pttbufsl26s1';
            }
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
            if (savedFolderId) {
                document.getElementById('folder-id-input').value = savedFolderId;
            }
            if (savedModel) {
                document.getElementById('model-select').value = savedModel;
            }
            if (savedHistory) {
                try {
                    chatHistory = JSON.parse(savedHistory);
                    renderChatHistory();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', e);
                }
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        const messageInput = document.getElementById('message-input');
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter, –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ Shift+Enter
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isSending) {
                    sendMessage();
                }
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL –ø—Ä–æ–∫—Å–∏
        document.getElementById('save-proxy-url').addEventListener('click', function() {
            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            if (proxyUrl) {
                localStorage.setItem(STORAGE_KEYS.proxyUrl, proxyUrl);
                showNotification('‚úÖ URL –ø—Ä–æ–∫—Å–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API –∫–ª—é—á–∞
        document.getElementById('save-api-key').addEventListener('click', function() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem(STORAGE_KEYS.apiKey, apiKey);
                showNotification('‚úÖ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            } else {
                localStorage.removeItem(STORAGE_KEYS.apiKey);
                showNotification('‚ö†Ô∏è API –∫–ª—é—á –æ—á–∏—â–µ–Ω');
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ API –∫–ª—é—á–∞
        document.getElementById('toggle-api-key-visibility').addEventListener('click', function() {
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                apiKeyInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        document.getElementById('clear-chat').addEventListener('click', function() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞?')) {
                chatHistory = [];
                localStorage.removeItem(STORAGE_KEYS.chatHistory);
                renderChatHistory();
                showNotification('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('model-select').addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.model, this.value);
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Folder ID –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        document.getElementById('folder-id-input').addEventListener('change', function() {
            localStorage.setItem(STORAGE_KEYS.folderId, this.value);
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('send-button').addEventListener('click', sendMessage);

        async function sendMessage() {
            const messageText = messageInput.value.trim();
            if (!messageText || isSending) return;

            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            const folderId = document.getElementById('folder-id-input').value.trim();

            if (!proxyUrl) {
                showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏');
                return;
            }

            if (!folderId) {
                showNotification('‚ùå –£–∫–∞–∂–∏—Ç–µ Folder ID');
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            addMessage('user', messageText);
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            isSending = true;
            const sendButton = document.getElementById('send-button');
            sendButton.disabled = true;
            sendButton.innerHTML = '–û—Ç–ø—Ä–∞–≤–∫–∞... <span class="loading"></span>';

            try {
                const apiKey = document.getElementById('api-key-input').value.trim();
                const model = document.getElementById('model-select').value;
                const modelUri = `gpt://${folderId}/${model}/latest`;

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è API
                const apiMessages = chatHistory
                    .filter(msg => msg.role !== 'system')
                    .map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'assistant',
                        text: msg.content
                    }));

                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                apiMessages.push({
                    role: 'user',
                    text: messageText
                });

                const requestBody = {
                    modelUri: modelUri,
                    messages: apiMessages,
                    completionOptions: {
                        temperature: 0.6,
                        maxTokens: 2000
                    }
                };

                if (apiKey) {
                    requestBody.apiKey = apiKey;
                }

                const startTime = Date.now();
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const duration = Date.now() - startTime;

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message || '–û—à–∏–±–∫–∞ –æ—Ç API');
                }

                if (data.result && data.result.alternatives && data.result.alternatives.length > 0) {
                    const assistantMessage = data.result.alternatives[0].message.text;
                    const usage = data.result.usage;

                    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                    addMessage('assistant', assistantMessage, {
                        tokens: usage?.totalTokens || 0,
                        duration: duration
                    });
                } else {
                    throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞');
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                addMessage('assistant', `‚ùå –û—à–∏–±–∫–∞: ${error.message}`, {
                    isError: true
                });
            } finally {
                isSending = false;
                sendButton.disabled = false;
                sendButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        }

        function addMessage(role, content, meta = {}) {
            const message = {
                role,
                content,
                timestamp: Date.now(),
                ...meta
            };

            chatHistory.push(message);
            saveChatHistory();
            renderChatHistory();
        }

        function renderChatHistory() {
            const container = document.getElementById('messages-container');

            if (chatHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
                        <p>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å YandexGPT</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chatHistory.map(msg => {
                const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let metaInfo = '';
                if (msg.tokens) {
                    metaInfo += `–¢–æ–∫–µ–Ω—ã: ${msg.tokens}`;
                }
                if (msg.duration) {
                    if (metaInfo) metaInfo += ' ‚Ä¢ ';
                    metaInfo += `–í—Ä–µ–º—è: ${msg.duration}ms`;
                }

                const className = msg.isError ? 'error' : msg.role;
                const bubbleClass = msg.isError ? 'error-bubble' : '';

                return `
                    <div class="message ${className}">
                        <div>
                            <div class="message-bubble ${bubbleClass}">
                                ${escapeHtml(msg.content)}
                            </div>
                            ${metaInfo ? `<div class="message-info">${time}${metaInfo ? ' ‚Ä¢ ' + metaInfo : ''}</div>` : `<div class="message-info">${time}</div>`}
                        </div>
                    </div>
                `;
            }).join('');

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
            container.scrollTop = container.scrollHeight;
        }

        function saveChatHistory() {
            localStorage.setItem(STORAGE_KEYS.chatHistory, JSON.stringify(chatHistory));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        function showNotification(message) {
            // –ü—Ä–æ—Å—Ç–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª–∏, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
            console.log(message);
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        }
    </script>

</body>
</html>
