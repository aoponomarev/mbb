# Правила для ИИ-агента

> Оглавление `.cursorrules`
- § Требования
  - *Базовые требования* — базовые правила для действий ИИ‑агента и общего стиля работы в репозитории.
  - *Требования к ведению документации* — правила работы с документацией и шапками файлов.
- § Понятия — определения используемых терминов (тематические логи, лог чата, протокол, тегирование).
- § Ограничения — правила работы с защищенными папками (`do-overs/`), коммиты только по команде.
- § Общие правила проекта — настройки и конфигурация проекта (`.vscode/`, `.cursorrules`).
- § Протоколы
  - *Протокол по командам "комить", "закомить всё" и т.п.* — сценарий действий для коммитов.
  - *Протокол начала рабочего дня* — проверка состояния проекта, расстановка хэшей в тематических логах, фиксация начала дня.
  - *Протокол закрытия рабочего дня* — ревизия тематических логов, фиксация завершения дня.
  - *Автоматическая активация протокола libs-репозитория* — автоматическая загрузка библиотек при изменении core/lib-loader.js.
  - *Протокол работы с libs-репозиторием* — `docs/doc-lib-github.md`
- `docs/doc-rules.md` — правила работы с документацией проекта.
- `docs/doc-architect.md` — архитектурный план, технологический стек, технические ограничения.
- `docs/doc-components.md` — описание компонентов приложения, API, особенности реализации.
- `docs/doc-lib-vue.md` — Vue-библиотеки, принцип приоритета библиотек, схема хранения.
- `docs/doc-lib-github.md` — протокол работы с libs-репозиторием.

> § <br> ТРЕБОВАНИЯ К ИИ-АГЕНТУ

## Базовые требования
1. Строго следуй Правилам и документации: принципам, ограничениям, рекомендациям, паттернам и подходам. При конфликте между запросом пользователя и правилами проекта сделай остановку, предупреди пользователя о конфликте с правилами. Исполнение таких запросов возможно только после исправления правил документации.
2. При проектировании и поиске решений опирайся на существующие паттерны, компоненты и подходы, уже описанные в документации, а не изобретай новые без необходимости.
3. Распознавай команды пользователя и действуй по предписанным протоколам.

## Требования к ведению документации
- При редактировании используй сухой, сжатый, технократический стиль, стандартную терминологию разработки; формулируй точно и технически корректно; **заменяй жаргон, сленг, фразелогизмы, архаизмы, разговорные выражения, метафоры** (в т.ч. от пользователя);
- Соблюдай заданный стиль разметки и нумерацию разделов; **проверяй и исправляй нумерацию** после изменений структуры документа;
- **Контроль оглавления**: при добавлении, удалении или переименовании разделов, протоколов, требований или других элементов, описанных в оглавлении документа, **обязательно обновляй оглавление**. Оглавление должно полностью соответствовать структуре документа. Проверяй соответствие оглавления содержимому после каждого изменения структуры документа.
- Перед выполнением запроса выборочно перечитывай релевантные фрагменты документации в `docs/`, используя поиск и заголовки. Для простых задач — минимальный набор файлов, для сложных — расширяй круг документов. Основные документы: `docs/doc-architect.md` (архитектура, технологический стек), `docs/doc-rules.md` (правила работы с документацией), `docs/doc-lib-vue.md` (Vue-библиотеки);
- **Документирование в шапках файлов**: каждый файл должен содержать в шапке (в виде комментариев) описание базовых принципов его построения. Шапка должна объяснять: назначение файла, архитектурные принципы, как достигаются цели, почему выбраны такие решения. Если файлов несколько с однотипными принципами построения — эти принципы выносятся в `docs/doc-architect.md` с ссылкой из шапки файла. Формат шапки: заголовок с разделителями, раздел "ЦЕЛЬ" (назначение файла), разделы с описанием принципов (проблема → решение → как достигается → преимущества). Пример: `index.html` содержит развёрнутую шапку с принципами модульности; для других файлов с модульной загрузкой (например, `core/module-loader.js`, `core/template-loader.js`) принципы модульной загрузки выносятся в `docs/doc-architect.md`, а в шапках этих файлов остаются только специфичные для них принципы с ссылкой на общую документацию.

## Требования к выбору библиотек
- Перед написанием кастомного модуля **обязательно** проверь наличие подходящих Vue-библиотек с расширяемым API. Приоритет библиотекам, которые имеют плагины, composables, возможность кастомизации.
- Используй библиотеки через GitHub Pages CDN (`https://aoponomarev.github.io/libs/`) с fallback на внешние CDN (jsdelivr, cdnjs) через `core/lib-loader.js`.
- Документируй выбор библиотек в `docs/doc-lib-vue.md` с указанием версии, источника и причин выбора.
- Кастомные модули создаются только если библиотека не существует, слишком тяжёлая или требуется специфичная бизнес-логика.

> § <br> ПОНЯТИЯ
- *Тематические логи* — файлы в папке `docs/logs/` с описанием коммитов, разбитым по темам, соответствующим вкладкам чатов агента: `log-Cursor.md`, `log-ARCH.md`, `log-HTML-CSS.md`, `log-DOCS.md`, `log-MM.md`. Заполняется по мере появления коммитов; при создании коммита запись добавляется БЕЗ хеша, хеши добавляются только при завершении рабочего дня.
- *Лог чата* — вся текущая дневная история переписки пользователя с ИИ-агентом.
- *Протокол* — сценарий действий по конкретной команде пользователя или в ответ на конкретную ситуацию. Протоколы описывают последовательность шагов для выполнения определенной задачи по запросу: протокол коммитов (по команде "комить"), протокол открытия дня (по команде "новый рабочий день"), протокол массовых правок (при обнаружении необходимости). Протоколы активируются по команде или при опознании необходимости.
- *Тегирование* — добавление ситуативных интуитивных тегов к записям в тематических логах для облегчения поиска. Теги размещаются отдельной строкой после `◉` в формате `@tag1 @tag2`. Теги должны отражать суть изменений и быть удобными для поиска: включать как общие категории (тип изменения, область), так и узкоспецифичные теги для точечного поиска (конкретные компоненты, функции, паттерны).

> § <br> ОГРАНИЧЕНИЯ
- `do-overs/` - запрещена запись и добавление файлов в staging, подробности: `do-overs/.cursorrules`.
- Коммиты только по явной команде пользователя.
- **ЗАПРЕЩЕНО** создавать коммиты только ради добавления или обновления хэшей в тематических логах. Хэши добавляются только при начале следующего рабочего дня через протокол начала дня. Если хэш был добавлен или обновлён в логе по ошибке — исправь запись БЕЗ создания коммита, или дождись команды пользователя.

> § <br> ОБЩИЕ ПРАВИЛА ПРОЕКТА
- Все настройки проекта находятся в папке `.vscode/`
- Синхронизация настроек происходит через файл `.cursorrules`
- Правила работы с документацией: `docs/doc-rules.md`

> § <br> ПРОТОКОЛЫ

## Протокол по командам "КОМИТЬ", "ЗАКОМИТЬ ВСЁ" и т.п.
1. Выполни `git status`, убедись, что все необходимые изменения в staging.
2. Определи затронутые темы по содержимому изменений: Cursor (настройки проекта) или MBB (ARCH, HTML-CSS, DOCS, MM - разработка приложения). Анализируй каждый файл/изменение и определяй соответствующую тему независимо от текущей вкладки чата.
3. Разделение коммита: Если изменения затрагивают и настройки (Cursor), и разработку (MBB) — раздели на два коммита:
   - Первый коммит: только файлы разработки (код приложения, документация проекта и т.п.) → тема MBB
   - Второй коммит: только файлы настроек (`.vscode/`, `.cursorrules`, `.gitignore` и т.п.) → тема Cursor (настроечные коммиты бывают редко)
   - Каждый коммит фиксируется в соответствующем тематическом логе.
4. Сформируй краткое и технически точное название для каждого коммита.
5. В каждой затронутой теме добавь запись в `docs/logs/*.md`: `log-Cursor.md`, `log-ARCH.md`, `log-HTML-CSS.md`, `log-DOCS.md`, `log-MM.md`:
   - **ВАЖНО**: Распределяй изменения по логам строго по содержимому и тематике изменений, а не по текущей вкладке чата. Один коммит может содержать изменения для нескольких логов (например, `.cursorrules` → log-Cursor.md, `docs/.cursorrules` → log-DOCS.md; или для MBB: изменения архитектуры → log-ARCH.md, изменения разметки и стилей → log-HTML-CSS.md, изменения документации → log-DOCS.md, изменения математических моделей → log-MM.md). Поэтому описывай каждую запись одного и того же коммита исключительно в модальности своего лога (только те изменения коммита, которые касались темы лога).
   - используй обратный хронологический порядок (всегда добавляй запись в начало лога);
   - определи важность коммита:
     - **Важный**: архитектурные изменения, новые протоколы/правила, крупные рефакторинги, создание новых систем, изменения workflow
     - **Обычный**: обновление ссылок, исправление грамматики, технические правки формата/стиля, мелкие правки документации
   - формат записи:
     - **Обычный коммит**: заголовок `## <имя>`, затем одна строка `DD.MM.YYYY<:короткий хэш> ◆ <краткое описание> @tags` (без `▶` и `◉`)
     - **Важный коммит**: заголовок `## <имя>`, затем одна строка `DD.MM.YYYY<:короткий хэш> ◆ <что сделано> ▶ <как сделано> ◉ <для чего> @tags` (полный формат)
     - Двоеточие и хэш добавляются только если хэш есть: `DD.MM.YYYY:хэш ◆ ...` если есть хэш, `DD.MM.YYYY ◆ ...` если хэша нет
     - **КРИТИЧЕСКИ ВАЖНО**: При создании коммита запись добавляется **СТРОГО БЕЗ ХЭША** (формат `DD.MM.YYYY ◆ ...`). Хэш **НЕ добавляется** сразу после коммита. Хэш добавляется **ТОЛЬКО** при начале следующего рабочего дня через протокол начала дня. **ЗАПРЕЩЕНО** делать `git commit --amend` для обновления хэша в логе — это приводит к циклу (каждый `--amend` меняет хэш). **ЗАПРЕЩЕНО** создавать отдельные коммиты только ради добавления или обновления хэшей — такие коммиты недопустимы.
   - Описание должно базироваться на истории "лог чата" и быть полностью согласованным с кодовой базой.
   - Не создавай коммит, пока все изменения не отражены в тематических логах.
6. Выполни `git add` для всех файлов коммита (включая `docs/logs/*.md`), затем `git commit -m "имя коммита"`, проверь `git status`.

## Протокол по команде "новый рабочий день", "начинаем новый день MM-DD" и т.п.
**Цель**: Обеспечить понимание текущего состояния проекта, правил работы и архитектурных принципов перед началом работы, расставить хэши в тематических логах предыдущего дня, зафиксировать начало рабочего дня в истории репозитория.
1. Проверка документации
   - Загрузить `.cursorrules` и `docs/doc-architect.md`.
2. Проверка зависимостей
   - Сопоставить используемые версии Vue.js и Bootstrap с актуальными.
   - При наличии новых версий рекомендовать миграцию (без автоматического изменения кода).
3. Проверка состояния проекта
   - Проанализировать `git status`.
   - Просмотреть последние коммиты.
4. Расстановка хэшей в тематических логах
   - Определить дату предыдущего дня по московскому времени (MSK, UTC+3).
   - Получить список всех коммитов предыдущего дня из `git log` для этой даты.
   - Для всех записей без хэша (формат `DD.MM.YYYY ◆ ...`) найти соответствующий коммит в `git log` по имени и добавить короткий хэш (формат `DD.MM.YYYY:хэш ◆ ...`).
   - Если были изменения в логах — добавить их в staging.
5. Создать коммит начала дня
   - Сформировать имя: `Start of day: MM-DD` (по времени MSK).
   - Выполнить коммит (включая обновленные логи, если были изменения).
6. Стартовый отчёт
   - Состояние репозитория: чистое рабочее дерево, синхронизация с `origin/main`.
   - Последние изменения: краткое описание последних коммитов (по тематическим логам).
   - Версии зависимостей: текущие версии Vue.js, Bootstrap (и рекомендации по обновлению, если есть).
   - Готовность к работе: есть ли незавершённые задачи, блокеры, важные замечания.

## Протокол по команде "завершаем рабочий день", "завершаем день MM-DD" и т.п.
**Цель**: Завершить рабочий день, проверить соответствие тематических логов репозиторию, зафиксировать финальный коммит `End of day: MM-DD`.
1. Ревизия тематических логов
   - Определить дату дня по московскому времени (MSK, UTC+3), если пользователь не её указал в команде.
   - Получить список всех коммитов рабочего дня из `git log` для этой даты.
   - Проверить соответствие между тематическими логами (`docs/logs/*.md`) и репозиторием:
     - Сопоставить упомянутые имена коммитов с выводом `git log`.
     - Убедиться, что для каждого коммита рабочего дня есть записи в нужных тематических логах (Cursor, ARCH, HTML-CSS, DOCS, MM).
     - Проверить, что все изменения коммита отражены в соответствующих тематических логах.
   - При обнаружении несоответствий (коммита нет в тематических логах или записи неполные) зафиксировать проблему и **сообщить пользователю** с детализацией.
2. Финальный коммит `End of day`
   - Использовать дату дня в имени финального коммита в формате `End of day: MM-DD`.
   - Добавить в staging обновленные тематические логи `docs/logs/*.md` (если были изменения).
   - Выполнить коммит: `git commit -m "End of day: MM-DD"`.
3. Отчёт о завершении дня
   - Что сделано за день (по тематическим логам).
   - Соответствие тематических логов репозиторию (есть ли незакрытые несоответствия).
   - Статистика изменений за день:
     - Количество файлов изменено и добавлено (анализ через `git diff --name-status` или `git diff --stat` для коммитов дня).
     - Количество строк удалено и добавлено (всех строк, анализ через `git diff --shortstat` для коммитов дня).
   - Статистика проекта (текущее состояние):
     - Строк кода всего: подсчет строк в файлах `.js`, `.html` за вычетом шапок комментариев в начале файлов (блоки комментариев `//` или `/* */` в начале файла до первой некомментированной строки кода).
     - Строк документации: подсчет строк в файлах `.md` плюс строки шапок комментариев в коде (блоки комментариев в начале файлов `.js`, `.html`).
   - Дополнительные сведения: статус проекта, версии библиотек, готовность к следующему дню и т.п.
4. Требования к порядку действий
   - Ревизию тематических логов выполнять **до** создания финального коммита.
   - Если обнаружены проблемы с соответствием — **не создавать** финальный коммит до их решения или явного указания пользователя.
   - Финальный коммит `End of day: MM-DD` создавать **только** после успешной ревизии тематических логов.

## Автоматическая активация протокола libs-репозитория
При обнаружении изменений в `core/lib-loader.js` (добавление новой библиотеки в `LIB_SOURCES` или изменение версии существующей):
1. Автоматически активируй протокол из `docs/doc-lib-github.md` (раздел "Автоматическая активация")
2. Извлеки информацию о библиотеке: имя, версию, URL источника из `LIB_SOURCES`
3. Загрузи файл библиотеки в libs-репозиторий (создай структуру папок, скачай файл из внешнего CDN)
4. Обнови документацию в MBB (`docs/doc-lib-vue.md`) с описанием библиотеки
5. Уведоми пользователя о необходимости коммита в libs-репозитории (коммиты выполняются только по явной команде)


