# Правила для ИИ-агента

> Оглавление `.cursorrules`
- § Требования
  - *Оптимизация расхода токенов и пошаговое выполнение* — правила экономии контекста и разбиения заданий на шаги.
  - *Базовые требования* — базовые правила для действий ИИ‑агента и общего стиля работы в репозитории.
  - *Требования к ведению документации* — правила работы с документацией и шапками файлов.
- § Понятия — определения используемых терминов (тематические логи, лог чата, протокол, тегирование).
- § Ограничения — правила работы с защищенными папками (`do-overs/`), коммиты только по команде.
- § Общие правила проекта — настройки и конфигурация проекта (`.vscode/`, `.cursorrules`).
- § Протоколы
  - *Протокол по командам "комить", "закомить всё" и т.п.* — сценарий действий для коммитов.
  - *Протокол начала рабочего дня* — проверка состояния проекта, расстановка хэшей в тематических логах, ревизия логов, фиксация начала дня.
  - *Автоматическая активация протокола libs-репозитория* — автоматическая загрузка библиотек при изменении core/lib-loader.js.
  - *Протокол работы с libs-репозиторием* — `docs/doc-lib-github.md`
- `docs/doc-rules.md` — правила работы с документацией проекта.
- `docs/doc-architect.md` — архитектурный план, технологический стек, технические ограничения.
- `docs/doc-components.md` — описание компонентов приложения, API, особенности реализации.
- `docs/doc-lib-vue.md` — Vue-библиотеки, принцип приоритета библиотек, схема хранения.
- `docs/doc-lib-github.md` — протокол работы с libs-репозиторием.

> § <br> ТРЕБОВАНИЯ К ИИ-АГЕНТУ

## Оптимизация расхода токенов и пошаговое выполнение
**КРИТИЧЕСКИ ВАЖНО**: Строго соблюдай эти правила для минимизации расхода токенов на каждый запрос.

### Экономия контекста
1. **Минимальный контекст**: Читай только необходимые файлы для текущей задачи. Не загружай весь проект в контекст без явной необходимости.
2. **Точечные запросы**: Используй конкретные пути к файлам вместо общих запросов типа "весь проект" или "все компоненты".
3. **Исключения**: Файлы из `.cursorignore` и `files.exclude` в `settings.json` НЕ должны попадать в контекст. Проверяй перед чтением файлов.
4. **Закрытие файлов**: После завершения работы с файлом не оставляй его открытым в контексте, если он больше не нужен.
5. **Ограничение поиска**: При использовании `codebase_search` и `grep` ограничивай область поиска конкретными директориями через `target_directories`.
6. **Кэширование**: Не перечитывай файлы, которые уже были прочитаны в текущей сессии, если они не изменились.
7. **Запрет автоматического открытия файлов**: **ЗАПРЕЩЕНО** автоматически открывать файлы для просмотра после их изменения, создания или при обнаружении изменений. Файлы открываются **ТОЛЬКО** по явному запросу пользователя или когда это необходимо для выполнения текущей задачи. После завершения работы с файлом закрывай его из контекста, если он больше не нужен.

### Пошаговое выполнение заданий
1. **Разбиение на шаги**: Любое задание, требующее изменения более 3 файлов или затрагивающее несколько подсистем, **ОБЯЗАТЕЛЬНО** разбивай на отдельные шаги с использованием `todo_write`.
2. **Последовательность**: Выполняй шаги последовательно, завершая каждый перед переходом к следующему.
3. **Проверка после шага**: После каждого шага проверяй результат перед переходом к следующему.
4. **Информирование**: Информируй пользователя о прогрессе при выполнении многошаговых задач.
5. **Откат при ошибке**: При ошибке на шаге — остановись, сообщи пользователю, не продолжай следующие шаги до исправления.

### Приоритеты при работе
1. **Простота над сложностью**: Выбирай простые решения, которые требуют меньше контекста и изменений.
2. **Локальные изменения**: Предпочитай локальные изменения глобальным рефакторингам.
3. **Существующие паттерны**: Используй существующие паттерны из документации вместо создания новых.
4. **Минимальные чтения**: Читай только те части файлов, которые нужны для текущей задачи (используй `offset` и `limit` в `read_file`).

## Базовые требования
1. Строго следуй Правилам и документации: принципам, ограничениям, рекомендациям, паттернам и подходам. При конфликте между запросом пользователя и правилами проекта сделай остановку, предупреди пользователя о конфликте с правилами. Исполнение таких запросов возможно только после исправления правил документации.
2. **Единый источник правды (Single Source of Truth) — ОБЯЗАТЕЛЬНОЕ ТРЕБОВАНИЕ:** Перед дублированием значений (заголовки модальных окон, тексты пунктов меню, конфигурации, TTL, стратегии кэширования и т.п.) **ОБЯЗАТЕЛЬНО** проверяй наличие конфигурационных файлов в `core/config/` и `core/cache/`. Используй функции-геттеры из конфигурации (`modalsConfig.getModalTitle()`, `cacheConfig.getTTL()`, `cacheConfig.getStrategy()` и т.п.) вместо хардкода. При необходимости создавай новые конфигурационные файлы для централизации значений. **ЗАПРЕЩЕНО** дублировать значения в разных местах без использования единого источника правды. Подробности в `docs/doc-comp-principles.md` (раздел "Единый источник правды").
3. **Версионирование кэша — ОБЯЗАТЕЛЬНАЯ ПРОВЕРКА:** При добавлении нового ключа кэша через `cacheManager.get/set()` **ОБЯЗАТЕЛЬНО** определяй необходимость версионирования по критериям из `docs/doc-architect.md` (раздел "Версионирование приложения", подраздел "Критерии применения версионирования кэша"). Версионировать ключи, которые: (1) из внешних API, (2) парсятся из ответов, (3) зависят от структуры данных приложения, (4) могут вызвать ошибки при изменении формата. НЕ версионировать пользовательские данные, настройки, UI-состояние, данные с миграциями схем. При сомнениях — спрашивай пользователя или добавляй в версионируемые (безопаснее). Если ключ должен версионироваться — добавляй его в список `versionedKeys` в `core/cache/cache-manager.js` (функция `getVersionedKey`).
3. При проектировании и поиске решений опирайся на существующие паттерны, компоненты и подходы, уже описанные в документации, а не изобретай новые без необходимости.
4. Распознавай команды пользователя и действуй по предписанным протоколам.
5. **Команда "ОМК:" (Ответь Максимально Кратко)**: При получении команды "ОМК:" или "ОМК" в начале или конце запроса **ОБЯЗАТЕЛЬНО** давать максимально сжатые и точные ответы, исключительно по делу, без отвлечений, пояснений, примеров и дополнительной информации. Ответ должен содержать только суть, необходимую для выполнения задачи.
6. **Поиск решений в вебе в режиме отладки:** В режиме отладки (debug mode) при решении проблем **ОБЯЗАТЕЛЬНО** используй веб-поиск для расширения поля поиска решений, проверки известных проблем, изучения опыта других разработчиков и сокращения издержек тестирования. Не полагайся только на собственные гипотезы и интуицию — веб-поиск должен использоваться для проверки альтернативных подходов, изучения документации платформ/библиотек, поиска готовых решений и проверки ограничений технологий.

## Требования к ведению документации
- При редактировании используй сухой, сжатый, технократический стиль, стандартную терминологию разработки; формулируй точно и технически корректно; **заменяй жаргон, сленг, фразелогизмы, архаизмы, разговорные выражения, метафоры** (в т.ч. от пользователя);
- Соблюдай заданный стиль разметки и нумерацию разделов; **проверяй и исправляй нумерацию** после изменений структуры документа;
- **Контроль оглавления**: при добавлении, удалении или переименовании разделов, протоколов, требований или других элементов, описанных в оглавлении документа, **обязательно обновляй оглавление**. Оглавление должно полностью соответствовать структуре документа. Проверяй соответствие оглавления содержимому после каждого изменения структуры документа.
- Перед выполнением запроса выборочно перечитывай релевантные фрагменты документации в `docs/`, используя поиск и заголовки. Для простых задач — минимальный набор файлов, для сложных — расширяй круг документов. Основные документы: `docs/doc-architect.md` (архитектура, технологический стек), `docs/doc-rules.md` (правила работы с документацией, включая иерархию уровней документирования), `docs/doc-lib-vue.md` (Vue-библиотеки);

## Требования к выбору библиотек
- См. `docs/doc-lib-vue.md` для принципов приоритета библиотек, схемы хранения и механизма загрузки.

> § <br> ПОНЯТИЯ
- *Тематические логи* — файлы в папке `docs/logs/` с описанием коммитов, разбитым по темам, соответствующим вкладкам чатов агента: `log-Cursor.md`, `log-ARCH.md`, `log-HTML-CSS.md`, `log-DOCS.md`, `log-MM.md`. Заполняется по мере появления коммитов; при создании коммита запись добавляется БЕЗ хеша, хеши добавляются только при начале следующего рабочего дня через протокол начала дня.
- *Лог чата* — вся текущая дневная история переписки пользователя с ИИ-агентом.
- *Протокол* — сценарий действий по конкретной команде пользователя или в ответ на конкретную ситуацию. Протоколы описывают последовательность шагов для выполнения определенной задачи по запросу: протокол коммитов (по команде "комить"), протокол открытия дня (по команде "новый рабочий день"), протокол массовых правок (при обнаружении необходимости). Протоколы активируются по команде или при опознании необходимости.
- *Тегирование* — добавление ситуативных интуитивных тегов к записям в тематических логах для облегчения поиска. Теги размещаются отдельной строкой после `◉` в формате `@tag1 @tag2`. Теги должны отражать суть изменений и быть удобными для поиска: включать как общие категории (тип изменения, область), так и узкоспецифичные теги для точечного поиска (конкретные компоненты, функции, паттерны).

> § <br> ОГРАНИЧЕНИЯ
- `do-overs/` - запрещена запись и добавление файлов в staging, подробности: `do-overs/.cursorrules`.
- `drafts/` - запрещена запись, изменение, удаление и добавление файлов в staging. Папка исключена из индексации через `.cursorignore`, но доступна для просмотра пользователем. Подробности: `drafts/.cursorrules`.
- Коммиты только по явной команде пользователя.
- **ЗАПРЕЩЕНО** создавать коммиты только ради добавления или обновления хэшей в тематических логах. Хэши добавляются только при начале следующего рабочего дня через протокол начала дня. Если хэш был добавлен или обновлён в логе по ошибке — исправь запись БЕЗ создания коммита, или дождись команды пользователя.

> § <br> ОБЩИЕ ПРАВИЛА ПРОЕКТА
- Все настройки проекта находятся в папке `.vscode/`
- Синхронизация настроек происходит через файл `.cursorrules`
- Правила работы с документацией: `docs/doc-rules.md`
- Подсчет статистики проекта: При любых подсчетах строк кода, документации, количества файлов и других метрик проекта ВАЖНО исключать файлы из игнорируемых папок. Проверять `.gitignore` и `.cursorignore` и другие, указанные в файлах игнорирования. Это правило применяется ко всем протоколам и операциям, требующим подсчета статистики проекта.

> § <br> ПРОТОКОЛЫ

## Протокол по командам "КОМИТЬ", "ЗАКОМИТЬ ВСЁ" и т.п.
1. Выполни `git status`, убедись, что все необходимые изменения в staging.
2. Определи затронутые темы по содержимому изменений: Cursor (настройки проекта) или MBB (ARCH, HTML-CSS, DOCS, MM - разработка приложения). Анализируй каждый файл/изменение и определяй соответствующую тему независимо от текущей вкладки чата.
3. Разделение коммита: Если изменения затрагивают и настройки (Cursor), и разработку (MBB) — раздели на два коммита:
   - Первый коммит: только файлы разработки (код приложения, документация проекта и т.п.) → тема MBB
   - Второй коммит: только файлы настроек (`.vscode/`, `.cursorrules`, `.gitignore` и т.п.) → тема Cursor (настроечные коммиты бывают редко)
   - Каждый коммит фиксируется в соответствующем тематическом логе.
4. Сформируй краткое и технически точное название для каждого коммита.
   - **ВАЖНО**: Если коммит содержит несколько изменений, составные части названия перечисляются от наиболее значимых для проекта к наименее значимым. Порядок значимости: функциональные улучшения (UX, новые возможности) → технические улучшения (качество кода, рефакторинг) → документация и уточнения (комментарии, пометки в примерах).
5. В каждой затронутой теме добавь запись в `docs/logs/*.md`: `log-Cursor.md`, `log-ARCH.md`, `log-HTML-CSS.md`, `log-DOCS.md`, `log-MM.md`:
   - **ВАЖНО**: Распределяй изменения по логам строго по содержимому и тематике изменений, а не по текущей вкладке чата. Один коммит может содержать изменения для нескольких логов (например, `.cursorrules` → log-Cursor.md, `docs/.cursorrules` → log-DOCS.md; или для MBB: изменения архитектуры → log-ARCH.md, изменения разметки и стилей → log-HTML-CSS.md, изменения документации → log-DOCS.md, изменения математических моделей → log-MM.md). Поэтому описывай каждую запись одного и того же коммита исключительно в модальности своего лога (только те изменения коммита, которые касались темы лога).
   - используй обратный хронологический порядок (всегда добавляй запись в начало лога);
   - определи важность коммита:
     - **Важный**: архитектурные изменения, новые протоколы/правила, крупные рефакторинги, создание новых систем, изменения workflow
     - **Обычный**: обновление ссылок, исправление грамматики, технические правки формата/стиля, мелкие правки документации
   - формат записи:
     - **Обычный коммит**: заголовок `## <имя>`, затем одна строка `DD.MM.YYYY<:короткий хэш> ◆ <краткое описание> @tags` (без `▶` и `◉`)
     - **Важный коммит**: заголовок `## <имя>`, затем одна строка `DD.MM.YYYY<:короткий хэш> ◆ <что сделано> ▶ <как сделано> ◉ <для чего> @tags` (полный формат)
     - Двоеточие и хэш добавляются только если хэш есть: `DD.MM.YYYY:хэш ◆ ...` если есть хэш, `DD.MM.YYYY ◆ ...` если хэша нет
     - **КРИТИЧЕСКИ ВАЖНО**: При создании коммита запись добавляется **СТРОГО БЕЗ ХЭША** (формат `DD.MM.YYYY ◆ ...`). Хэш **НЕ добавляется** сразу после коммита. Хэш добавляется **ТОЛЬКО** при начале следующего рабочего дня через протокол начала дня. **ЗАПРЕЩЕНО** делать `git commit --amend` для обновления хэша в логе — это приводит к циклу (каждый `--amend` меняет хэш). **ЗАПРЕЩЕНО** создавать отдельные коммиты только ради добавления или обновления хэшей — такие коммиты недопустимы.
   - Описание должно базироваться на истории "лог чата" и быть полностью согласованным с кодовой базой.
   - Не создавай коммит, пока все изменения не отражены в тематических логах.
6. Выполни `git add` для всех файлов коммита (включая `docs/logs/*.md`), затем `git commit -m "имя коммита"`, проверь `git status`.

## Протокол по команде "новый рабочий день", "начинаем новый день MM-DD" и т.п.
**Цель**: Расставить хэши в тематических логах предыдущего дня, проверить их соответствие репозиторию, зафиксировать начало рабочего дня в истории репозитория.

1. Проверка состояния проекта
   - Проанализировать `git status`.
   - **Если есть незакоммиченные изменения** (в рабочем дереве или staging):
     - **Остановить выполнение протокола**.
     - **Сообщить пользователю** о наличии незакоммиченных изменений с детализацией:
       - Список изменённых файлов.
       - Статус изменений (modified, untracked, staged).
       - Предложить варианты: закоммитить изменения, отменить их, или сохранить в stash.
     - **Не продолжать** протокол до явного указания пользователя.
   - Просмотреть последние коммиты.
   - Сопоставить используемые версии Vue.js и Bootstrap с актуальными.
   - При наличии новых версий рекомендовать миграцию (без автоматического изменения кода).

2. Расстановка хэшей и ревизия тематических логов предыдущего дня
   - Для каждого тематического лога (`docs/logs/*.md`) найти последнюю запись с хэшом (формат `DD.MM.YYYY:хэш ◆ ...`).
   - Найти все записи без хэша (формат `DD.MM.YYYY ◆ ...`) после последней записи с хэшом до конца файла.
   - Для каждой записи без хэша найти соответствующий коммит в `git log` по описанию/названию и добавить короткий хэш (формат `DD.MM.YYYY:хэш ◆ ...`).
   - Проверить соответствие между тематическими логами (`docs/logs/*.md`) и репозиторием:
     - Сопоставить упомянутые имена коммитов в найденных записях без хэшей с выводом `git log`.
     - Убедиться, что для каждого найденного коммита есть записи в нужных тематических логах (Cursor, ARCH, HTML-CSS, DOCS, MM).
     - Проверить, что все изменения коммита отражены в соответствующих тематических логах.
   - **Проверить структуру Markdown**: убедиться, что между всеми записями (заголовками `##`) есть пустые строки. При обнаружении отсутствующих пустых строк — исправить структуру.
   - При обнаружении несоответствий (коммита нет в тематических логах или записи неполные) зафиксировать проблему и **сообщить пользователю** с детализацией.
   - Если были изменения в логах — добавить их в staging.

3. Создать коммит начала дня
   - Сформировать имя: `Start of day: MM-DD` (по времени MSK).
   - Выполнить коммит (включая обновленные логи, если были изменения).

4. Стартовый отчёт
   - Состояние репозитория: чистое рабочее дерево, синхронизация с `origin/main`.
   - Отчёт о предыдущем дне:
     - Что сделано (по тематическим логам).
     - Соответствие тематических логов репозиторию (есть ли незакрытые несоответствия).
     - Статистика изменений: количество файлов и строк (через `git diff --stat` и `git diff --shortstat` для коммитов предыдущего дня).
   - Статистика проекта (текущее состояние):
     - Использовать утилиту `scripts/stats-counter-node.js` для подсчета статистики: `node scripts/stats-counter-node.js`
     - Утилита возвращает JSON объект со статистикой:
       - `js`: строки кода, комментарии, файлы, всего строк
       - `html`: строки кода, комментарии, файлы, всего строк
       - `css`: строки кода, комментарии, файлы, всего строк
       - `docs`: строки контента, шапки комментариев, файлы, всего строк
     - Формат вывода: "JS: N строк кода, M строк комментариев (K файлов) | Всего строк: L"
     - Кэш статистики сохраняется в `docs/.stats-cache.json` (игнорируется git) для снижения нагрузки при повторных запросах
     - Принудительное обновление: `node scripts/stats-counter-node.js --force-refresh`
   - Версии зависимостей: текущие версии Vue.js, Bootstrap (и рекомендации по обновлению, если есть).
   - Готовность к работе: есть ли незавершённые задачи, блокеры, важные замечания.

**Примечание**: При использовании `search_replace` для обновления записей в тематических логах обязательно проверять и сохранять структуру Markdown: между каждой записью (заголовок `##` и следующая запись) должна быть пустая строка. В `old_string` и `new_string` включать пустую строку перед следующим заголовком `##`, если она должна быть там.

## Автоматическая активация протокола libs-репозитория
При обнаружении изменений в `core/lib-loader.js` (добавление новой библиотеки в `LIB_SOURCES` или изменение версии существующей):
1. Автоматически активируй протокол из `docs/doc-lib-github.md` (раздел "Автоматическая активация")
2. Извлеки информацию о библиотеке: имя, версию, URL источника из `LIB_SOURCES`
3. Загрузи файл библиотеки в libs-репозиторий (создай структуру папок, скачай файл из внешнего CDN)
4. Обнови документацию в MBB (`docs/doc-lib-vue.md`) с описанием библиотеки
5. Уведоми пользователя о необходимости коммита в libs-репозитории (коммиты выполняются только по явной команде)


