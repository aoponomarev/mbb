<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YandexGPT CORS Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .field-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        textarea {
            font-family: monospace;
            resize: vertical;
        }
        button {
            padding: 8px 16px;
            margin-right: 10px;
            cursor: pointer;
        }
        .button-group {
            margin: 10px 0;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .error {
            color: #d32f2f;
        }
        .success {
            color: #388e3c;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ccc;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #d32f2f;
        }
        .log-entry.success {
            border-left-color: #388e3c;
        }
    </style>
</head>
<body>

    <h1>YandexGPT CORS Test</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã YandexGPT API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ Yandex Cloud Functions</p>

    <div class="info">
        <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong><br>
        1. –í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏ Cloud Function (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω - –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –ø–æ–∑–∂–µ)<br>
        2. –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á Yandex Cloud (–∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ env —Ñ—É–Ω–∫—Ü–∏–∏)<br>
        3. –í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è YandexGPT<br>
        4. –ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å" –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è URL –ø—Ä–æ–∫—Å–∏ -->
    <div class="field-group">
        <label for="proxy-url-input">URL –ø—Ä–æ–∫—Å–∏ Cloud Function:</label>
        <input type="text" id="proxy-url-input" placeholder="https://functions.yandexcloud.net/your-function-id" value="">
        <button id="save-proxy-url">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å URL</button>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è API –∫–ª—é—á–∞ -->
    <div class="field-group">
        <label for="api-key-input">API –∫–ª—é—á Yandex Cloud (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ env —Ñ—É–Ω–∫—Ü–∏–∏):</label>
        <div style="display: flex; align-items: center; gap: 5px;">
            <input type="password" id="api-key-input" style="flex: 1;" placeholder="AQVN...">
            <button id="toggle-api-key-visibility">üëÅÔ∏è</button>
            <button id="save-api-key">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è Folder ID –∏ –º–æ–¥–µ–ª–∏ -->
    <div class="field-group">
        <label for="folder-id-input">Folder ID:</label>
        <input type="text" id="folder-id-input" placeholder="b1gv03a122le5a934cqj" value="b1gv03a122le5a934cqj">
    </div>

    <div class="field-group">
        <label for="model-select">–ú–æ–¥–µ–ª—å:</label>
        <select id="model-select" style="width: 100%; padding: 8px;">
            <option value="yandexgpt-lite">YandexGPT Lite</option>
            <option value="yandexgpt">YandexGPT</option>
        </select>
    </div>

    <!-- –ü–æ–ª–µ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ -->
    <div class="field-group">
        <label for="query-input">–ó–∞–ø—Ä–æ—Å –∫ YandexGPT:</label>
        <input type="text" id="query-input" placeholder="–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ –¥–µ–ª–∞?" value="–ü—Ä–∏–≤–µ—Ç! –†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ.">
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
    <div class="button-group">
        <button id="send-button" style="background: #2196f3; color: white; font-weight: bold;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
        <button id="clear-button">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –¥–ª—è –ª–æ–≥–æ–≤ -->
    <div class="field-group">
        <label for="log-textarea">–õ–æ–≥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:</label>
        <textarea id="log-textarea" rows="20" readonly style="font-size: 12px;"></textarea>
    </div>

    <script>
        // –ö–ª—é—á–∏ –¥–ª—è localStorage
        const STORAGE_KEYS = {
            proxyUrl: 'ya-cors-proxy-url',
            apiKey: 'ya-cors-api-key',
            folderId: 'ya-cors-folder-id'
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', function() {
            const savedProxyUrl = localStorage.getItem(STORAGE_KEYS.proxyUrl);
            const savedApiKey = localStorage.getItem(STORAGE_KEYS.apiKey);
            const savedFolderId = localStorage.getItem(STORAGE_KEYS.folderId);

            if (savedProxyUrl) {
                document.getElementById('proxy-url-input').value = savedProxyUrl;
            }
            if (savedApiKey) {
                document.getElementById('api-key-input').value = savedApiKey;
            }
            if (savedFolderId) {
                document.getElementById('folder-id-input').value = savedFolderId;
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ URL –ø—Ä–æ–∫—Å–∏
        document.getElementById('save-proxy-url').addEventListener('click', function() {
            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            if (proxyUrl) {
                localStorage.setItem(STORAGE_KEYS.proxyUrl, proxyUrl);
                log('‚úÖ URL –ø—Ä–æ–∫—Å–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', { url: proxyUrl });
            } else {
                log('‚ùå –í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏ –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º');
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ API –∫–ª—é—á–∞
        document.getElementById('save-api-key').addEventListener('click', function() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                localStorage.setItem(STORAGE_KEYS.apiKey, apiKey);
                log('‚úÖ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            } else {
                log('‚ö†Ô∏è API –∫–ª—é—á –æ—á–∏—â–µ–Ω (–±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–∑ env —Ñ—É–Ω–∫—Ü–∏–∏, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)');
                localStorage.removeItem(STORAGE_KEYS.apiKey);
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ API –∫–ª—é—á–∞
        document.getElementById('toggle-api-key-visibility').addEventListener('click', function() {
            const apiKeyInput = document.getElementById('api-key-input');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                this.textContent = 'üôà';
            } else {
                apiKeyInput.type = 'password';
                this.textContent = 'üëÅÔ∏è';
            }
        });

        // –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤
        document.getElementById('clear-button').addEventListener('click', function() {
            document.getElementById('log-textarea').value = '';
            logs.length = 0;
        });

        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        const logs = [];
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('ru-RU');
            const entry = {
                time: timestamp,
                message,
                data
            };
            logs.push(entry);

            const logText = logs.map(l => {
                let line = `[${l.time}] ${l.message}`;
                if (l.data) {
                    line += '\n' + JSON.stringify(l.data, null, 2);
                }
                return line;
            }).join('\n\n');

            document.getElementById('log-textarea').value = logText;
            document.getElementById('log-textarea').scrollTop = document.getElementById('log-textarea').scrollHeight;

            console.log(`[${timestamp}] ${message}`, data || '');
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        document.getElementById('send-button').addEventListener('click', async function() {
            const proxyUrl = document.getElementById('proxy-url-input').value.trim();
            const apiKey = document.getElementById('api-key-input').value.trim();
            const folderId = document.getElementById('folder-id-input').value.trim();
            const model = document.getElementById('model-select').value;
            const query = document.getElementById('query-input').value.trim() || '–ü—Ä–∏–≤–µ—Ç!';

            if (!proxyUrl) {
                log('‚ùå –û—à–∏–±–∫–∞: URL –ø—Ä–æ–∫—Å–∏ –Ω–µ —É–∫–∞–∑–∞–Ω', { error: '–í–≤–µ–¥–∏—Ç–µ URL –ø—Ä–æ–∫—Å–∏ Cloud Function' });
                return;
            }

            if (!folderId) {
                log('‚ùå –û—à–∏–±–∫–∞: Folder ID –Ω–µ —É–∫–∞–∑–∞–Ω');
                return;
            }

            log('üöÄ –ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫ YandexGPT', {
                proxyUrl,
                hasApiKey: !!apiKey,
                folderId,
                model,
                query
            });

            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º modelUri
                const modelUri = `gpt://${folderId}/${model}/latest`;

                // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è –ø—Ä–æ–∫—Å–∏
                const requestBody = {
                    modelUri: modelUri,
                    messages: [
                        {
                            role: 'user',
                            text: query
                        }
                    ],
                    completionOptions: {
                        temperature: 0.6,
                        maxTokens: 2000
                    }
                };

                // –ï—Å–ª–∏ API –∫–ª—é—á —É–∫–∞–∑–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –∑–∞–ø—Ä–æ—Å
                // (–∏–Ω–∞—á–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–∑ env —Ñ—É–Ω–∫—Ü–∏–∏)
                if (apiKey) {
                    requestBody.apiKey = apiKey;
                }

                log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ø—Ä–æ–∫—Å–∏', {
                    url: proxyUrl,
                    method: 'POST',
                    body: {
                        ...requestBody,
                        apiKey: apiKey ? apiKey.substring(0, 10) + '...' : '(–∏–∑ env)'
                    }
                });

                const startTime = Date.now();

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ø—Ä–æ–∫—Å–∏
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const endTime = Date.now();
                const duration = endTime - startTime;

                log('üì• –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω', {
                    status: response.status,
                    statusText: response.statusText,
                    ok: response.ok,
                    duration: `${duration}ms`,
                    headers: {
                        'content-type': response.headers.get('content-type'),
                        'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                        'access-control-allow-methods': response.headers.get('access-control-allow-methods')
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('access-control-allow-origin'),
                    'Access-Control-Allow-Methods': response.headers.get('access-control-allow-methods'),
                    'Access-Control-Allow-Headers': response.headers.get('access-control-allow-headers')
                };

                const hasCorsHeaders = corsHeaders['Access-Control-Allow-Origin'] !== null;
                if (hasCorsHeaders) {
                    log('‚úÖ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç', corsHeaders);
                } else {
                    log('‚ö†Ô∏è CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ—Ç–≤–µ—Ç–µ', { note: '–≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –æ—à–∏–±–∫–∏ CORS –≤ –±—Ä–∞—É–∑–µ—Ä–µ' });
                }

                const responseText = await response.text();

                log('üìÑ –¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ (raw)', {
                    length: responseText.length,
                    preview: responseText.substring(0, 200)
                });

                if (!response.ok) {
                    log('‚ùå –û—à–∏–±–∫–∞ HTTP', {
                        status: response.status,
                        statusText: response.statusText,
                        body: responseText
                    });
                    return;
                }

                // –ü–∞—Ä—Å–∏–º JSON –æ—Ç–≤–µ—Ç
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    log('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON', {
                        error: parseError.message,
                        responseText: responseText.substring(0, 500)
                    });
                    return;
                }

                log('‚úÖ –û—Ç–≤–µ—Ç —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω', {
                    hasResult: !!data.result,
                    hasAlternatives: !!(data.result && data.result.alternatives),
                    alternativesCount: data.result?.alternatives?.length || 0
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç API
                if (data.error) {
                    log('‚ùå –û—à–∏–±–∫–∞ –æ—Ç Yandex API', {
                        error: data.error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞',
                        httpCode: data.error.httpCode,
                        grpcCode: data.error.grpcCode
                    });
                    return;
                }

                // –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
                if (data.result && data.result.alternatives && data.result.alternatives.length > 0) {
                    const answer = data.result.alternatives[0].message.text;
                    const usage = data.result.usage;

                    log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç YandexGPT', {
                        answer: answer,
                        usage: usage,
                        tokens: {
                            input: usage?.inputTextTokens,
                            output: usage?.completionTokens,
                            total: usage?.totalTokens
                        }
                    });
                } else {
                    log('‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞', { data });
                }

            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ', {
                    error: error.message,
                    name: error.name,
                    stack: error.stack?.split('\n').slice(0, 5).join('\n')
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º CORS –æ—à–∏–±–∫—É
                if (error.message === 'Failed to fetch' ||
                    (error.name === 'TypeError' && error.message?.includes('fetch'))) {
                    log('‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω–∞—è CORS –æ—à–∏–±–∫–∞', {
                        note: '–ó–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–æ–∫—Å–∏.',
                        origin: window.location.origin,
                        protocol: window.location.protocol
                    });
                }
            }
        });
    </script>

</body>
</html>
